<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOCKIN | Student Life Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono:wght==400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            // Dark Theme Colors
                            dark: '#0f0f13',
                            card: '#18181b',
                            cardHover: '#202023',
                            input: '#27272a',
                            // Light Theme Colors
                            light: '#f9fafb',
                            lightCard: '#ffffff',
                            lightCardHover: '#f3f4f6',
                            lightInput: '#e5e7eb',

                            accent: '#8b5cf6', // Violet
                            accentHover: '#7c3aed',
                            success: '#10b981',
                            warning: '#f59e0b',
                            danger: '#ef4444',
                        },
                        classColors: {
                            blue: '#3b82f6',
                            red: '#ef4444',
                            yellow: '#f59e0b',
                            green: '#10b981',
                            purple: '#a855f7',
                            pink: '#ec4899',
                            gray: '#6b7280',
                        }
                    },
                    keyframes: {
                        pulseIn: {
                            '0%': { opacity: 0, transform: 'scale(0.9)' },
                            '100%': { opacity: 1, transform: 'scale(1)' },
                        }
                    },
                    animation: {
                        pulseIn: 'pulseIn 0.3s ease-out',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #18181b;
        }
        ::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #52525b;
        }
        /* Custom scrollbar for light mode */
        html:not(.dark) ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        html:not(.dark) ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }
        html:not(.dark) ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Task Checkbox */
        .task-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #4b5563;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .task-checkbox:checked {
            border-color: #8b5cf6;
            background-color: #8b5cf6;
        }
        .task-checkbox:checked::after {
            content: '\f00c'; /* Font Awesome check icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 12px;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .task-checkbox.priority-high { border-color: #ef4444; }
        .task-checkbox.priority-high:checked { background-color: #ef4444; border-color: #ef4444; }
        .task-checkbox.priority-medium { border-color: #f59e0b; }
        .task-checkbox.priority-medium:checked { background-color: #f59e0b; border-color: #f59e0b; }
        .task-checkbox.priority-low { border-color: #10b981; }
        .task-checkbox.priority-low:checked { background-color: #10b981; border-color: #10b981; }

        .task-item.completed {
            opacity: 0.6;
        }
        .task-item.completed .task-name,
        .task-item.completed .task-due {
            text-decoration: line-through;
            text-decoration-color: #9ca3af;
        }

        /* Daily Agenda Time Grid */
        .time-slot {
            height: 60px; /* 1 hour slot */
            position: relative;
        }
        .time-slot:not(:last-child) {
            border-bottom: 1px dashed #3f3f46;
        }
        html:not(.dark) .time-slot:not(:last-child) {
            border-bottom: 1px dashed #d1d5db;
        }
        .time-label {
            position: absolute;
            top: -10px;
            left: -15px;
            font-size: 12px;
            color: #6b7280;
        }
        html:not(.dark) .time-label {
            color: #6b7280;
        }

        /* Event rendering in daily agenda */
        .event-block {
            position: absolute;
            left: 10%;
            right: 0;
            border-radius: 8px;
            padding: 4px 8px;
            overflow: hidden;
            font-size: 12px;
            z-index: 10;
        }

        /* Click-drag event creation */
        #event-drag-preview {
            position: absolute;
            left: 10%;
            right: 0;
            background-color: rgba(139, 92, 246, 0.3);
            border: 1px dashed #8b5cf6;
            border-radius: 8px;
            z-index: 20;
            pointer-events: none;
            display: none;
        }
        
        /* Task Filter Buttons */
        .task-filter-btn {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            background-color: #e5e7eb; /* brand-lightInput */
            border: 1px solid #d1d5db; /* light mode border */
            transition: all 0.2s ease;
        }
        .task-filter-btn:hover {
            background-color: #f3f4f6; /* brand-lightCardHover */
            border-color: #9ca3af;
        }
        .task-filter-btn.active {
            background-color: #8b5cf6; /* brand-accent */
            color: white;
            border-color: #8b5cf6;
            box-shadow: 0 4px 14px 0 rgba(139, 92, 246, 0.25);
        }
        
        html.dark .task-filter-btn {
            background-color: #27272a; /* brand-input */
            border: 1px solid #3f3f46; /* dark mode border */
        }
        html.dark .task-filter-btn:hover {
            background-color: #202023; /* brand-cardHover */
            border-color: #52525b;
        }
        html.dark .task-filter-btn.active {
            background-color: #8b5cf6; /* brand-accent */
            color: white;
            border-color: #8b5cf6;
            box-shadow: 0 4px 14px 0 rgba(139, 92, 246, 0.25);
        }

        /* Subtle border for light mode cards */
        html:not(.dark) .bg-brand-lightCard {
            border: 1px solid #e5e7eb; /* brand-lightInput */
        }
    </style>
</head>
<body class="bg-brand-light dark:bg-brand-dark text-gray-800 dark:text-gray-200 font-sans antialiased">

    <!-- Global Toast Notification -->
    <div id="toast-container" class="fixed top-5 right-5 z-[100]"></div>

    <!-- Onboarding Modal -->
    <div id="onboarding-modal" class="fixed inset-0 bg-brand-dark/80 dark:bg-brand-dark/90 backdrop-blur-md z-[200] flex items-center justify-center p-4 hidden">
        <div class="bg-brand-lightCard dark:bg-brand-card w-full max-w-lg rounded-2xl shadow-2xl p-6 sm:p-8 animate-pulseIn">
            
            <!-- Step 1: Welcome -->
            <div id="onboarding-step-1">
                <i class="fa-solid fa-hand-sparkles text-4xl text-brand-accent mb-4"></i>
                <h2 class="text-2xl font-bold mb-2">Welcome to LOCKIN</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Let's get your student hub set up. First, what should we call you?</p>
                <input id="onboarding-name-input" type="text" placeholder="Your Name" class="w-full px-4 py-3 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" autocomplete="name">
                <button id="onboarding-next-1" class="w-full bg-brand-accent text-white font-semibold py-3 px-6 rounded-lg mt-6 hover:bg-brand-accentHover transition-all">
                    Continue <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>

            <!-- Step 2: Schedule -->
            <div id="onboarding-step-2" class="hidden">
                <i class="fa-solid fa-calendar-week text-4xl text-brand-accent mb-4"></i>
                <h2 class="text-2xl font-bold mb-2">School Schedule</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">How does your school schedule work? This will help set up your calendar.</p>
                
                <select id="onboarding-rotation-select" class="w-full px-4 py-3 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none">
                    <option value="none">No Rotation (Standard Week / College)</option>
                    <option value="5">5-Day Rotation (Day 1-5)</option>
                    <option value="8">8-Day Rotation (Day 1-8)</option>
                    <option value="9">9-Day Rotation (Day 1-9)</option>
                </select>

                <div id="onboarding-rotation-date-picker" class="mt-4 hidden">
                    <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">When does/did this rotation start?</label>
                    <p class="text-xs text-gray-500 mb-2">Pick the date for "Day 1" of a cycle. It can be in the past.</p>
                    <input id="onboarding-rotation-start-date" type="date" class="w-full px-4 py-3 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none"
                           value=""> <!-- Value will be set to today by JS -->
                </div>

                <button id="onboarding-finish" class="w-full bg-brand-accent text-white font-semibold py-3 px-6 rounded-lg mt-6 hover:bg-brand-accentHover transition-all">
                    Get Started <i class="fa-solid fa-check ml-2"></i>
                </button>
            </div>

        </div>
    </div>


    <!-- Main App Wrapper -->
    <div class="flex h-screen">

        <!-- Sidebar Navigation -->
        <nav class="w-20 md:w-64 bg-brand-lightCard dark:bg-brand-card p-4 flex flex-col shadow-lg z-10">
            <!-- Logo -->
            <div class="flex items-center justify-center md:justify-start mb-10 md:pl-2">
                <i class="fa-solid fa-rocket text-brand-accent text-3xl"></i>
                <h1 class="text-2xl font-bold ml-3 hidden md:block">LOCKIN</h1>
            </div>

            <!-- Nav Links -->
            <ul class="flex flex-col space-y-3 flex-grow">
                <li>
                    <a href="#" data-view="dashboard" class="nav-link flex items-center py-3 px-3 md:px-4 rounded-lg transition-all group">
                        <i class="fa-solid fa-home text-lg w-6 text-center"></i>
                        <span class="ml-4 font-semibold hidden md:block">Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-view="schedule" class="nav-link flex items-center py-3 px-3 md:px-4 rounded-lg transition-all group">
                        <i class="fa-solid fa-calendar-days text-lg w-6 text-center"></i>
                        <span class="ml-4 font-semibold hidden md:block">Schedule</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-view="tasks" class="nav-link flex items-center py-3 px-3 md:px-4 rounded-lg transition-all group">
                        <i class="fa-solid fa-check-double text-lg w-6 text-center"></i>
                        <span class="ml-4 font-semibold hidden md:block">Tasks</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-view="events" class="nav-link flex items-center py-3 px-3 md:px-4 rounded-lg transition-all group">
                        <i class="fa-solid fa-star text-lg w-6 text-center"></i>
                        <span class="ml-4 font-semibold hidden md:block">Events</span>
                    </a>
                </li>
                 <li>
                    <a href="#" data-view="gpa" class="nav-link flex items-center py-3 px-3 md:px-4 rounded-lg transition-all group">
                        <i class="fa-solid fa-calculator text-lg w-6 text-center"></i>
                        <span class="ml-4 font-semibold hidden md:block">GPA Calculator</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-view="habits" class="nav-link flex items-center py-3 px-3 md:px-4 rounded-lg transition-all group">
                        <i class="fa-solid fa-repeat text-lg w-6 text-center"></i>
                        <span class="ml-4 font-semibold hidden md:block">Habits</span>
                    </a>
                </li>
            </ul>

            <!-- Footer / Settings -->
            <div class="mt-auto">
                <a href="#" id="theme-toggle-btn" class="flex items-center py-3 px-3 md:px-4 rounded-lg text-gray-500 hover:bg-brand-lightInput dark:hover:bg-brand-input transition-all group">
                    <i id="theme-icon" class="fa-solid fa-moon text-lg w-6 text-center"></i>
                    <span class="ml-4 font-semibold hidden md:block">Toggle Theme</span>
                </a>
                 <a href="#" data-view="settings" class="nav-link flex items-center py-3 px-3 md:px-4 rounded-lg transition-all group">
                    <i class="fa-solid fa-cog text-lg w-6 text-center"></i>
                    <span class="ml-4 font-semibold hidden md:block">Settings</span>
                </a>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 h-screen overflow-y-auto p-4 sm:p-6 md:p-8">

            <!-- ======================= -->
            <!-- == DASHBOARD VIEW  == -->
            <!-- ======================= -->
            <section data-view="dashboard" class="app-view">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold">Welcome back, <span id="user-name-header">User</span>!</h2>
                        <p id="today-date-header" class="text-gray-500 dark:text-gray-400 text-lg">Monday, July 15</p>
                    </div>
                    <!-- Gamification Widget -->
                    <div id="gamification-widget" class="bg-brand-lightCard dark:bg-brand-card p-4 rounded-xl shadow-md min-w-[250px]">
                         <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">Level <span id="xp-level">1</span></span>
                            <span class="text-sm font-mono text-brand-accent"><span id="xp-current">0</span> / <span id="xp-next-level">100</span> XP</span>
                        </div>
                        <div class="w-full bg-brand-lightInput dark:bg-brand-input rounded-full h-2.5">
                            <div id="xp-bar" class="bg-brand-accent h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <!-- Left Column (Tasks & Habits) -->
                    <div class="lg:col-span-2 space-y-6">
                        
                        <!-- Today's Schedule -->
                        <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Today's Schedule <span id="today-rotation-day-label" class="text-sm font-normal text-brand-accent ml-2"></span></h3>
                            <div id="today-schedule-list" class="space-y-3">
                                <!-- JS will render today's classes and events here -->
                                <!-- <p class="text-gray-500 dark:text-gray-400">No classes or events scheduled for today.</p> -->
                            </div>
                        </div>

                        <!-- Priority Tasks -->
                        <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">Priority Tasks</h3>
                                <button data-view-target="tasks" class="text-sm font-medium text-brand-accent hover:underline">View All</button>
                            </div>
                            <div id="priority-tasks-list" class="space-y-3">
                                <!-- JS will render tasks here -->
                                <!-- <p class="text-gray-500 dark:text-gray-400">You're all caught up!</p> -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Column (Daily Habits & Quick Add) -->
                    <div class="lg:col-span-1 space-y-6">
                        <!-- Daily Habits -->
                        <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Daily Habits</h3>
                            <div id="daily-habits-list-dashboard" class="space-y-4">
                                <!-- JS will render habits here -->
                                <!-- <p class="text-gray-500 dark:text-gray-400">No habits added yet. Go to the Habits tab to add some!</p> -->
                            </div>
                        </div>

                        <!-- Quick Add -->
                        <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Quick Add</h3>
                            <div class="space-y-3">
                                <button id="quick-add-task-btn" class="w-full text-left bg-brand-lightInput dark:bg-brand-input hover:bg-brand-lightCardHover dark:hover:bg-brand-cardHover p-4 rounded-lg transition-all">
                                    <i class="fa-solid fa-plus w-5 mr-2 text-brand-success"></i>
                                    <span>Add New Task</span>
                                </button>
                                <button id="quick-add-event-btn" class="w-full text-left bg-brand-lightInput dark:bg-brand-input hover:bg-brand-lightCardHover dark:hover:bg-brand-cardHover p-4 rounded-lg transition-all">
                                    <i class="fa-solid fa-plus w-5 mr-2 text-brand-accent"></i>
                                    <span>Add New Event</span>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <!-- ======================= -->
            <!-- == SCHEDULE VIEW   == -->
            <!-- ======================= -->
            <section data-view="schedule" class="app-view hidden">
                <h2 class="text-3xl font-bold mb-6">Schedule</h2>

                <!-- Schedule Navigation -->
                <div class="flex space-x-1 mb-6 border-b border-gray-300 dark:border-gray-700">
                    <button class="schedule-tab-btn px-4 py-2 font-semibold" data-schedule-view="week">Week View</button>
                    <button class="schedule-tab-btn px-4 py-2 font-semibold" data-schedule-view="daily">Daily View</button>
                    <button class="schedule-tab-btn px-4 py-2 font-semibold" data-schedule-view="setup">Class Setup</button>
                </div>

                <!-- == Schedule View: Week == -->
                <div id="schedule-view-week" class="schedule-view">
                    <!-- Week Navigation -->
                    <div class="flex justify-between items-center mb-4">
                        <button id="week-prev-btn" class="p-2 rounded-lg hover:bg-brand-lightCardHover dark:hover:bg-brand-cardHover">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <h3 id="week-view-title" class="text-xl font-bold"></h3>
                        <button id="week-next-btn" class="p-2 rounded-lg hover:bg-brand-lightCardHover dark:hover:bg-brand-cardHover">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Week Grid -->
                    <div id="week-grid-container" class="grid grid-cols-7 gap-px bg-gray-300 dark:bg-gray-700 border border-gray-300 dark:border-gray-700 rounded-lg overflow-hidden">
                        <!-- Headers -->
                        <div class="week-grid-header text-center p-2 font-semibold bg-brand-lightCard dark:bg-brand-card">Sun</div>
                        <div class="week-grid-header text-center p-2 font-semibold bg-brand-lightCard dark:bg-brand-card">Mon</div>
                        <div class="week-grid-header text-center p-2 font-semibold bg-brand-lightCard dark:bg-brand-card">Tue</div>
                        <div class="week-grid-header text-center p-2 font-semibold bg-brand-lightCard dark:bg-brand-card">Wed</div>
                        <div class="week-grid-header text-center p-2 font-semibold bg-brand-lightCard dark:bg-brand-card">Thu</div>
                        <div class="week-grid-header text-center p-2 font-semibold bg-brand-lightCard dark:bg-brand-card">Fri</div>
                        <div class="week-grid-header text-center p-2 font-semibold bg-brand-lightCard dark:bg-brand-card">Sat</div>

                        <!-- Days will be populated by JS -->
                    </div>
                </div>

                <!-- == Schedule View: Daily Agenda == -->
                <div id="schedule-view-daily" class="schedule-view hidden">
                    <!-- Day Navigation -->
                    <div class="flex justify-between items-center mb-4">
                        <button id="daily-prev-btn" class="p-2 rounded-lg hover:bg-brand-lightCardHover dark:hover:bg-brand-cardHover">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <h3 id="daily-view-title" class="text-xl font-bold"></h3>
                        <button id="daily-next-btn" class="p-2 rounded-lg hover:bg-brand-lightCardHover dark:hover:bg-brand-cardHover">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- 24-Hour Grid -->
                    <div id="daily-agenda-grid" class="relative max-w-4xl mx-auto pr-4">
                        <div id="event-drag-preview"></div>
                        <!-- Time slots will be populated by JS -->
                    </div>
                </div>


                <!-- == Schedule View: Setup == -->
                <div id="schedule-view-setup" class="schedule-view hidden">
                    <h3 class="text-xl font-bold mb-4">Class Setup</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Add Class Form -->
                        <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                            <h4 class="text-lg font-semibold mb-4">Add New Class</h4>
                            <form id="add-class-form" class="space-y-4">
                                <input type="hidden" id="class-id-input">
                                <div>
                                    <label for="class-name-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Class Name</label>
                                    <input type="text" id="class-name-input" placeholder="e.g., Calculus" class="w-full px-4 py-2 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" required>
                                </div>
                                <div id="class-day-selector-container">
                                    <label for="class-day-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Day</label>
                                    <select id="class-day-input" class="w-full px-4 py-2 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none">
                                        <!-- Options populated by JS based on rotation -->
                                    </select>
                                </div>
                                <div>
                                    <label for="class-time-start-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Start Time</label>
                                    <input type="time" id="class-time-start-input" class="w-full px-4 py-2 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" required>
                                </div>
                                <div>
                                    <label for="class-time-end-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">End Time</label>
                                    <input type="time" id="class-time-end-input" class="w-full px-4 py-2 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Color</label>
                                    <div id="class-color-picker" class="flex flex-wrap gap-2">
                                        <button type="button" data-color="blue" class="w-8 h-8 rounded-full bg-classColors-blue border-2 border-transparent"></button>
                                        <button type="button" data-color="red" class="w-8 h-8 rounded-full bg-classColors-red border-2 border-transparent"></button>
                                        <button type="button" data-color="yellow" class="w-8 h-8 rounded-full bg-classColors-yellow border-2 border-transparent"></button>
                                        <button type="button" data-color="green" class="w-8 h-8 rounded-full bg-classColors-green border-2 border-transparent"></button>
                                        <button type="button" data-color="purple" class="w-8 h-8 rounded-full bg-classColors-purple border-2 border-transparent"></button>
                                        <button type="button" data-color="pink" class="w-8 h-8 rounded-full bg-classColors-pink border-2 border-transparent"></button>
                                        <button type="button" data-color="gray" class="w-8 h-8 rounded-full bg-classColors-gray border-2 border-transparent"></button>
                                    </div>
                                    <input type="hidden" id="class-color-input" value="blue">
                                </div>
                                <button type="submit" class="w-full bg-brand-accent text-white font-semibold py-2 px-4 rounded-lg hover:bg-brand-accentHover transition-all">
                                    <i class="fa-solid fa-plus mr-2"></i><span id="add-class-btn-text">Add Class</span>
                                </button>
                                <button type="button" id="cancel-edit-class-btn" class="w-full bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition-all hidden">
                                    Cancel Edit
                                </button>
                            </form>
                        </div>
                        
                        <!-- Class List -->
                        <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                            <h4 class="text-lg font-semibold mb-4">Your Classes</h4>
                            <div id="class-list-container" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- JS populates this -->
                            </div>
                        </div>
                    </div>
                </div>

            </section>

            <!-- ======================= -->
            <!-- == TASKS VIEW      == -->
            <!-- ======================= -->
            <section data-view="tasks" class="app-view hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Tasks</h2>
                    <button id="add-task-btn" class="bg-brand-accent text-white font-semibold py-2 px-5 rounded-lg hover:bg-brand-accentHover transition-all">
                        <i class="fa-solid fa-plus mr-2"></i>Add Task
                    </button>
                </div>
                
                <!-- Task Filters -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button class="task-filter-btn active" data-filter="all"><i class="fa-solid fa-grip w-4 mr-2"></i>All</button>
                    <button class="task-filter-btn" data-filter="School"><i class="fa-solid fa-graduation-cap w-4 mr-2"></i>School</button>
                    <button class="task-filter-btn" data-filter="Life"><i class="fa-solid fa-person-running w-4 mr-2"></i>Life</button>
                    <button class="task-filter-btn" data-filter="Application"><i class="fa-solid fa-file-lines w-4 mr-2"></i>Application</button>
                    <button class="task-filter-btn" data-filter="Social"><i class="fa-solid fa-users w-4 mr-2"></i>Social</button>
                    <button class="task-filter-btn" data-filter="completed"><i class="fa-solid fa-check w-4 mr-2"></i>Completed</button>
                </div>

                <!-- Task List -->
                <div id="task-list-container" class="space-y-4">
                    <!-- JS will render tasks here -->
                </div>
            </section>

             <!-- ======================= -->
            <!-- == EVENTS VIEW     == -->
            <!-- ======================= -->
            <section data-view="events" class="app-view hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Events</h2>
                    <button id="add-event-btn" class="bg-brand-accent text-white font-semibold py-2 px-5 rounded-lg hover:bg-brand-accentHover transition-all">
                        <i class="fa-solid fa-plus mr-2"></i>Add Event
                    </button>
                </div>

                <!-- Event List -->
                <div id="event-list-container" class="space-y-4">
                     <!-- JS will render events here, grouped by date -->
                </div>
            </section>

            <!-- ======================= -->
            <!-- == GPA CALCULATOR VIEW == -->
            <!-- ======================= -->
            <section data-view="gpa" class="app-view hidden">
                <h2 class="text-3xl font-bold mb-6">GPA Calculator</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Add/Edit Course Form -->
                    <div class="md:col-span-1">
                        <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4" id="gpa-form-title">Add Course</h3>
                            <form id="gpa-course-form" class="space-y-4">
                                <input type="hidden" id="gpa-course-id-input">
                                <div>
                                    <label for="gpa-course-name" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Course Name</label>
                                    <input type="text" id="gpa-course-name" placeholder="e.g., Biology 101" class="w-full px-4 py-2 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" required>
                                </div>
                                <div>
                                    <label for="gpa-course-grade" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Grade</label>
                                    <select id="gpa-course-grade" class="w-full px-4 py-2 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" required>
                                        <!-- JS will populate options from gpaScale -->
                                    </select>
                                </div>
                                <div>
                                    <label for="gpa-course-credits" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Credits/Units</label>
                                    <input type="number" id="gpa-course-credits" step="0.1" min="0" placeholder="e.g., 3" class="w-full px-4 py-2 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" required>
                                </div>
                                <button type="submit" id="gpa-submit-btn" class="w-full bg-brand-accent text-white font-semibold py-2 px-4 rounded-lg hover:bg-brand-accentHover transition-all">
                                    <i class="fa-solid fa-plus mr-2"></i>Add Course
                                </button>
                                <button type="button" id="gpa-cancel-edit-btn" class="w-full bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition-all hidden">
                                    Cancel Edit
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Course List & Results -->
                    <div class="md:col-span-2">
                        <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg mb-6">
                            <h3 class="text-xl font-bold mb-4">Total GPA</h3>
                            <div class="text-center p-6 bg-brand-lightInput dark:bg-brand-input rounded-xl">
                                <span class="text-5xl font-bold text-brand-accent" id="gpa-total-result">0.00</span>
                                <p class="text-gray-600 dark:text-gray-400 mt-1">Based on <span id="gpa-total-credits">0</span> credits</p>
                            </div>
                        </div>

                        <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">Your Courses</h3>
                                <button id="gpa-clear-all-btn" class="text-sm font-medium text-brand-danger hover:underline">Clear All</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full min-w-[400px]">
                                    <thead>
                                        <tr class="border-b border-gray-300 dark:border-gray-700">
                                            <th class="text-left p-2 font-semibold">Course</th>
                                            <th class="text-center p-2 font-semibold">Grade</th>
                                            <th class="text-center p-2 font-semibold">Credits</th>
                                            <th class="text-right p-2 font-semibold">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gpa-course-list">
                                        <!-- JS will populate rows -->
                                        <!-- <tr><td colspan="4" class="text-center p-4 text-gray-500">No courses added yet.</td></tr> -->
                                    </tbody>
                               </table>
                            </div>
                        </div>
                    </div>
                </div>

            </section>

             <!-- ======================= -->
            <!-- == HABITS VIEW     == -->
            <!-- ======================= -->
            <section data-view="habits" class="app-view hidden">
                <h2 class="text-3xl font-bold mb-6">Habit Tracker</h2>

                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Add Habit Form -->
                    <div class="md:col-span-1">
                        <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Add New Habit</h3>
                            <form id="add-habit-form" class="space-y-4">
                                <div>
                                    <label for="habit-name-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Habit Name</label>
                                    <input type="text" id="habit-name-input" placeholder="e.g., Drink Water" class="w-full px-4 py-2 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" required>
                                </div>
                                <button type="submit" class="w-full bg-brand-accent text-white font-semibold py-2 px-4 rounded-lg hover:bg-brand-accentHover transition-all">
                                    <i class="fa-solid fa-plus mr-2"></i>Add Habit
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Habit List -->
                    <div class="md:col-span-2">
                        <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Your Habits</h3>
                            <div id="habits-list-full" class="space-y-4">
                                <!-- JS will populate habits -->
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <!-- ======================= -->
            <!-- == SETTINGS VIEW   == -->
            <!-- ======================= -->
            <section data-view="settings" class="app-view hidden">
                <h2 class="text-3xl font-bold mb-6">Settings</h2>

                <div class="max-w-2xl space-y-8">
                    
                    <!-- Profile Settings -->
                    <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">Profile</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="settings-name-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Your Name</label>
                                <input type="text" id="settings-name-input" class="w-full px-4 py-2 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none">
                            </div>
                            <button id="settings-save-profile" class="bg-brand-accent text-white font-semibold py-2 px-5 rounded-lg hover:bg-brand-accentHover transition-all">
                                Save Name
                            </button>
                        </div>
                    </div>

                    <!-- Schedule Settings -->
                    <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">Schedule</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="settings-rotation-select" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Schedule Type</label>
                                <select id="settings-rotation-select" class="w-full px-4 py-2 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none">
                                    <option value="none">No Rotation (Standard Week / College)</option>
                                    <option value="5">5-Day Rotation (Day 1-5)</option>
                                    <option value="8">8-Day Rotation (Day 1-8)</option>
                                    <option value="9">9-Day Rotation (Day 1-9)</option>
                                </select>
                            </div>
                             <div id="settings-rotation-date-picker" class="hidden">
                                <label for="settings-rotation-start-date" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Rotation Start Date ("Day 1")</label>
                                <input id="settings-rotation-start-date" type="date" class="w-full px-4 py-2 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none">
                            </div>
                            <button id="settings-save-schedule" class="bg-brand-accent text-white font-semibold py-2 px-5 rounded-lg hover:bg-brand-accentHover transition-all">
                                Save Schedule Settings
                            </button>
                        </div>
                    </div>

                     <!-- GPA Settings -->
                    <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">GPA Scale</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Adjust the point value for each grade. This will be used to calculate your GPA.</p>
                        <div id="gpa-scale-settings-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                            <!-- JS will populate grade inputs -->
                        </div>
                        <button id="settings-save-gpa-scale" class="bg-brand-accent text-white font-semibold py-2 px-5 rounded-lg hover:bg-brand-accentHover transition-all mt-6">
                            Save GPA Scale
                        </button>
                    </div>

                    <!-- Danger Zone -->
                    <div class="bg-brand-lightCard dark:bg-brand-card p-6 rounded-2xl shadow-lg border border-brand-danger/30">
                        <h3 class="text-xl font-bold mb-4 text-brand-danger">Danger Zone</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">These actions are permanent and cannot be undone.</p>
                        <button id="settings-reset-app-btn" class="bg-brand-danger text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700 transition-all">
                            <i class="fa-solid fa-triangle-exclamation mr-2"></i>Reset All App Data
                        </button>
                    </div>

                </div>
            </section>


        </main>
    </div>

    <!-- ======================= -->
    <!-- == MODALS          == -->
    <!-- ======================= -->

    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="fixed inset-0 bg-brand-dark/80 dark:bg-brand-dark/90 backdrop-blur-md z-[150] flex items-center justify-center p-4 hidden animate-pulseIn">
        <div class="bg-brand-lightCard dark:bg-brand-card w-full max-w-lg rounded-2xl shadow-2xl p-6 sm:p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 id="task-modal-title" class="text-2xl font-bold">Add New Task</h3>
                <button id="close-task-modal" class="text-gray-400 hover:text-gray-200">
                    <i class="fa-solid fa-times text-2xl"></i>
                </button>
            </div>
            <form id="task-form">
                <input type="hidden" id="task-id-input">
                <div class="space-y-5">
                    <div>
                        <label for="task-name-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Task Name</label>
                        <input type="text" id="task-name-input" placeholder="e.g., Finish Math Homework" class="w-full px-4 py-3 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" required>
                    </div>
                    <div>
                        <label for="task-due-date-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Due Date</label>
                        <input type="date" id="task-due-date-input" class="w-full px-4 py-3 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none">
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label for="task-category-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Category</label>
                            <select id="task-category-input" class="w-full px-4 py-3 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none">
                                <option value="School">School</option>
                                <option value="Life">Life</option>
                                <option value="Application">Application</option>
                                <option value="Social">Social</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="task-priority-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Priority</label>
                            <select id="task-priority-input" class="w-full px-4 py-3 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="task-notes-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Notes (Optional)</label>
                        <textarea id="task-notes-input" rows="3" placeholder="Add any details..." class="w-full px-4 py-3 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none resize-none"></textarea>
                    </div>
                    <button type="submit" id="task-submit-btn" class="w-full bg-brand-accent text-white font-semibold py-3 px-6 rounded-lg hover:bg-brand-accentHover transition-all">
                        Add Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Event Modal -->
    <div id="event-modal" class="fixed inset-0 bg-brand-dark/80 dark:bg-brand-dark/90 backdrop-blur-md z-[150] flex items-center justify-center p-4 hidden animate-pulseIn">
        <div class="bg-brand-lightCard dark:bg-brand-card w-full max-w-lg rounded-2xl shadow-2xl p-6 sm:p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 id="event-modal-title" class="text-2xl font-bold">Add New Event</h3>
                <button id="close-event-modal" class="text-gray-400 hover:text-gray-200">
                    <i class="fa-solid fa-times text-2xl"></i>
                </button>
            </div>
            <form id="event-form">
                <input type="hidden" id="event-id-input">
                <div class="space-y-5">
                    <div>
                        <label for="event-title-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Event Title</label>
                        <input type="text" id="event-title-input" placeholder="e.g., Study Session" class="w-full px-4 py-3 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" required>
                    </div>
                    <div>
                        <label for="event-date-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Date</label>
                        <input type="date" id="event-date-input" class="w-full px-4 py-3 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" required>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label for="event-start-time-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Start Time</labe>
                            <input type="time" id="event-start-time-input" class="w-full px-4 py-3 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" required>
                        </div>
                        <div class="flex-1">
                            <label for="event-end-time-input" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">End Time</label>
                            <input type="time" id="event-end-time-input" class="w-full px-4 py-3 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" required>
                        </div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Color</label>
                        <div id="event-color-picker" class="flex flex-wrap gap-2">
                            <button type="button" data-color="blue" class="w-8 h-8 rounded-full bg-classColors-blue border-2 border-transparent"></button>
                            <button type="button" data-color="red" class="w-8 h-8 rounded-full bg-classColors-red border-2 border-transparent"></button>
                            <button type="button" data-color="yellow" class="w-8 h-8 rounded-full bg-classColors-yellow border-2 border-transparent"></button>
                            <button type="button" data-color="green" class="w-8 h-8 rounded-full bg-classColors-green border-2 border-transparent"></button>
                            <button type="button" data-color="purple" class="w-8 h-8 rounded-full bg-classColors-purple border-2 border-transparent"></button>
                            <button type="button" data-color="pink" class="w-8 h-8 rounded-full bg-classColors-pink border-2 border-transparent"></button>
                            <button type="button" data-color="gray" class="w-8 h-8 rounded-full bg-classColors-gray border-2 border-transparent"></button>
                        </div>
                        <input type="hidden" id="event-color-input" value="purple">
                    </div>
                    <button type="submit" id="event-submit-btn" class="w-full bg-brand-accent text-white font-semibold py-3 px-6 rounded-lg hover:bg-brand-accentHover transition-all">
                        Add Event
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-brand-dark/80 dark:bg-brand-dark/90 backdrop-blur-md z-[250] flex items-center justify-center p-4 hidden animate-pulseIn">
        <div class="bg-brand-lightCard dark:bg-brand-card w-full max-w-sm rounded-2xl shadow-2xl p-6 sm:p-8">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-gray-600 dark:text-gray-400 mb-6">This action cannot be undone.</p>
            <div class="flex gap-4">
                <button id="confirm-modal-cancel-btn" class="w-full bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition-all">
                    Cancel
                </button>
                <button id="confirm-modal-confirm-btn" class="w-full bg-brand-danger text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-all">
                    Confirm
                </button>
            </div>
        </div>
    </div>


    <script>
        // =================================================================================
        // == APP ROOT ===================================================================
        // =================================================================================
        
        // Using a single global object 'app' to manage the application state and functions
        window.app = {
            state: {},
            dom: {}, // To store references to DOM elements
            dragState: {
                isDragging: false,
                startX: 0,
                startY: 0,
                startTime: null,
                container: null,
                previewEl: null,
                date: null,
            },

            // =================================================================================
            // == INITIALIZATION ===============================================================
            // =================================================================================

            /**
             * Get the default application state.
             * This is used for new users or after a reset.
             */
            getInitialState: () => ({
                onboardingComplete: false,
                currentView: 'dashboard',
                currentScheduleView: 'week', // 'week', 'daily', 'setup'
                currentTaskFilter: 'all',
                currentWeekDate: new Date(), // A Date object for the start of the displayed week
                currentDailyDate: new Date(), // A Date object for the displayed day
                settings: {
                    theme: 'dark',
                    userName: 'User',
                    schoolRotation: 'none', // 'none', '5', '8', '9'
                    rotationStartDate: null, // 'YYYY-MM-DD'
                },
                schedule: {
                    classes: [], // { id, name, day, startTime, endTime, color }
                },
                tasks: [], // { id, name, dueDate, category, priority, notes, completed, completedDate }
                events: [], // { id, title, date, startTime, endTime, color }
                habits: [], // { id, name, completedDates: ['YYYY-MM-DD'] }
                gpa: {
                    courses: [], // { id, name, grade, credits }
                    gpaScale: {
                        'A+': 4.0, 'A': 4.0, 'A-': 3.7,
                        'B+': 3.3, 'B': 3.0, 'B-': 2.7,
                        'C+': 2.3, 'C': 2.0, 'C-': 1.7,
                        'D+': 1.3, 'D': 1.0, 'F': 0.0,
                    },
                },
                gamification: {
                    xp: 0,
                    level: 1,
                    xpToNextLevel: 10000,
                    lastLoginDate: null, // YYYY-MM-DD
                },
            }),

            /**
             * Main application entry point.
             * Runs on window.onload.
             */
            init: () => {
                console.log('App init...');
                app.cacheDomElements();
                app.loadState();
                app.applyTheme();
                app.checkDailyLoginXP(); // Check for daily login XP
                app.registerEventListeners();

                if (!app.state.onboardingComplete) {
                    app.showOnboarding();
                } else {
                    app.renderAll();
                }
            },

            /**
             * Store references to frequently used DOM elements.
             */
            cacheDomElements: () => {
                app.dom.navLinks = document.querySelectorAll('.nav-link');
                app.dom.appViews = document.querySelectorAll('.app-view');
                app.dom.themeToggle = document.getElementById('theme-toggle-btn');
                app.dom.themeIcon = document.getElementById('theme-icon');
                app.dom.toastContainer = document.getElementById('toast-container');
                
                // Modals
                app.dom.taskModal = document.getElementById('task-modal');
                app.dom.taskForm = document.getElementById('task-form');
                app.dom.eventModal = document.getElementById('event-modal');
                app.dom.eventForm = document.getElementById('event-form');
                app.dom.confirmModal = document.getElementById('confirm-modal');
                app.dom.onboardingModal = document.getElementById('onboarding-modal');

                // Schedule
                app.dom.scheduleTabBtns = document.querySelectorAll('.schedule-tab-btn');
                app.dom.scheduleViews = document.querySelectorAll('.schedule-view');
                
                // Week View
                app.dom.weekViewTitle = document.getElementById('week-view-title');
                app.dom.weekGridContainer = document.getElementById('week-grid-container');

                // Daily View
                app.dom.dailyViewTitle = document.getElementById('daily-view-title');
                app.dom.dailyAgendaGrid = document.getElementById('daily-agenda-grid');
                app.dom.eventDragPreview = document.getElementById('event-drag-preview');

                // Class Setup
                app.dom.classForm = document.getElementById('add-class-form');
                app.dom.classColorPicker = document.getElementById('class-color-picker');
                app.dom.classColorInput = document.getElementById('class-color-input');
                app.dom.classDaySelector = document.getElementById('class-day-input');
                app.dom.classDaySelectorContainer = document.getElementById('class-day-selector-container');
                app.dom.classListContainer = document.getElementById('class-list-container');
                app.dom.classSubmitBtnText = document.getElementById('add-class-btn-text');
                app.dom.classCancelEditBtn = document.getElementById('cancel-edit-class-btn');
                
                // GPA
                app.dom.gpaCourseForm = document.getElementById('gpa-course-form');
                app.dom.gpaFormTitle = document.getElementById('gpa-form-title');
                app.dom.gpaSubmitBtn = document.getElementById('gpa-submit-btn');
                app.dom.gpaCancelEditBtn = document.getElementById('gpa-cancel-edit-btn');
                app.dom.gpaCourseGradeSelect = document.getElementById('gpa-course-grade');
                app.dom.gpaCourseList = document.getElementById('gpa-course-list');
                app.dom.gpaTotalResult = document.getElementById('gpa-total-result');
                app.dom.gpaTotalCredits = document.getElementById('gpa-total-credits');
                app.dom.gpaScaleSettingsContainer = document.getElementById('gpa-scale-settings-container');

                // Habits
                app.dom.addHabitForm = document.getElementById('add-habit-form');
                app.dom.habitsListFull = document.getElementById('habits-list-full');

                // Event Modal Color Picker
                app.dom.eventColorPicker = document.getElementById('event-color-picker');
                app.dom.eventColorInput = document.getElementById('event-color-input');
            },

            /**
             * Register all global event listeners for the app.
             */
            registerEventListeners: () => {
                // Navigation
                app.dom.navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const view = link.dataset.view;
                        if (view) app.navigateTo(view);
                    });
                });

                // Theme Toggle
                app.dom.themeToggle.addEventListener('click', app.toggleTheme);

                // Onboarding
                document.getElementById('onboarding-next-1').addEventListener('click', app.handleOnboardingStep1);
                document.getElementById('onboarding-rotation-select').addEventListener('change', app.handleOnboardingRotationSelect);
                document.getElementById('onboarding-finish').addEventListener('click', app.handleOnboardingFinish);
                
                // Dashboard Quick Add
                document.getElementById('quick-add-task-btn').addEventListener('click', app.showTaskModal);
                document.getElementById('quick-add-event-btn').addEventListener('click', () => {
                    app.showEventModal();
                    // Fix: Highlight events tab when using quick add
                    app.navigateTo('events');
                });
                
                // View-specific buttons
                document.querySelectorAll('[data-view-target]').forEach(btn => {
                    btn.addEventListener('click', () => app.navigateTo(btn.dataset.viewTarget));
                });

                // Task Modal
                document.getElementById('add-task-btn').addEventListener('click', app.showTaskModal);
                document.getElementById('close-task-modal').addEventListener('click', () => app.modal.hide(app.dom.taskModal));
                app.dom.taskForm.addEventListener('submit', app.handleTaskFormSubmit);

                // Event Modal
                document.getElementById('add-event-btn').addEventListener('click', () => {
                    app.showEventModal();
                    // Fix: Highlight events tab when opening modal from the view
                    app.navigateTo('events');
                });
                document.getElementById('close-event-modal').addEventListener('click', () => app.modal.hide(app.dom.eventModal));
                app.dom.eventForm.addEventListener('submit', app.handleEventFormSubmit);

                // Task Filters
                document.querySelectorAll('.task-filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.task-filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        app.state.currentTaskFilter = btn.dataset.filter;
                        app.renderTasks();
                    });
                });

                // Schedule Tabs
                app.dom.scheduleTabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        app.state.currentScheduleView = btn.dataset.scheduleView;
                        app.renderSchedule();
                    });
                });

                // Week View Navigation
                document.getElementById('week-prev-btn').addEventListener('click', () => {
                    app.state.currentWeekDate.setDate(app.state.currentWeekDate.getDate() - 7);
                    app.renderWeekCalendar();
                });
                document.getElementById('week-next-btn').addEventListener('click', () => {
                    app.state.currentWeekDate.setDate(app.state.currentWeekDate.getDate() + 7);
                    app.renderWeekCalendar();
                });

                // Daily View Navigation
                document.getElementById('daily-prev-btn').addEventListener('click', () => {
                    app.state.currentDailyDate.setDate(app.state.currentDailyDate.getDate() - 1);
                    app.renderDailyAgenda();
                });
                document.getElementById('daily-next-btn').addEventListener('click', () => {
                    app.state.currentDailyDate.setDate(app.state.currentDailyDate.getDate() + 1);
                    app.renderDailyAgenda();
                });

                // Daily View Click-Drag-Create Event
                app.dom.dailyAgendaGrid.addEventListener('mousedown', app.handleDragStart);
                document.addEventListener('mousemove', app.handleDragMove); // Listen on document
                document.addEventListener('mouseup', app.handleDragEnd); // Listen on document

                // Class Setup
                app.dom.classForm.addEventListener('submit', app.handleClassFormSubmit);
                app.dom.classColorPicker.addEventListener('click', app.handleColorPickerClick.bind(null, app.dom.classColorPicker, app.dom.classColorInput));
                app.dom.classCancelEditBtn.addEventListener('click', app.resetClassForm);
                
                // Event Modal Color Picker
                app.dom.eventColorPicker.addEventListener('click', app.handleColorPickerClick.bind(null, app.dom.eventColorPicker, app.dom.eventColorInput));

                // GPA Calculator
                app.dom.gpaCourseForm.addEventListener('submit', app.handleGpaFormSubmit);
                app.dom.gpaCancelEditBtn.addEventListener('click', app.resetGpaForm);
                document.getElementById('gpa-clear-all-btn').addEventListener('click', app.handleClearAllCourses);

                // Habits
                app.dom.addHabitForm.addEventListener('submit', app.handleAddHabit);

                // Settings
                document.getElementById('settings-save-profile').addEventListener('click', app.handleSaveProfile);
                document.getElementById('settings-rotation-select').addEventListener('change', app.handleSettingsRotationSelect);
                document.getElementById('settings-save-schedule').addEventListener('click', app.handleSaveSchedule);
                document.getElementById('settings-save-gpa-scale').addEventListener('click', app.handleSaveGpaScale);
                document.getElementById('settings-reset-app-btn').addEventListener('click', app.handleResetApp);
            },

            // =================================================================================
            // == STATE & THEME MANAGEMENT =====================================================
            // =================================================================================

            /**
             * Load state from localStorage or use initial state.
             */
            loadState: () => {
                const savedState = localStorage.getItem('lockinAppState');
                const initialState = app.getInitialState();
                if (savedState) {
                    try {
                        // Merge saved state with initial state to ensure all keys exist
                        const parsedState = JSON.parse(savedState);
                        // Convert saved date strings back to Date objects
                        if(parsedState.currentWeekDate) parsedState.currentWeekDate = new Date(parsedState.currentWeekDate);
                        if(parsedState.currentDailyDate) parsedState.currentDailyDate = new Date(parsedState.currentDailyDate);
                        
                        app.state = { ...initialState, ...parsedState };
                        // Deep merge nested objects
                        app.state.settings = { ...initialState.settings, ...parsedState.settings };
                        app.state.schedule = { ...initialState.schedule, ...parsedState.schedule };
                        app.state.gpa = { ...initialState.gpa, ...parsedState.gpa };
                        app.state.gamification = { ...initialState.gamification, ...parsedState.gamification };
                    } catch (e) {
                        console.error('Failed to parse saved state, using initial state.', e);
                        app.state = initialState;
                    }
                } else {
                    app.state = initialState;
                }
            },

            /**
             * Save the current state to localStorage.
             */
            saveState: () => {
                try {
                    localStorage.setItem('lockinAppState', JSON.stringify(app.state));
                } catch (e) {
                    console.error('Failed to save state to localStorage.', e);
                    app.showToast('Error saving data. Storage might be full.', 'error');
                }
            },

            /**
             * Apply the theme ('dark' or 'light') to the <html> element.
             */
            applyTheme: () => {
                if (app.state.settings.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    app.dom.themeIcon.classList.remove('fa-moon');
                    app.dom.themeIcon.classList.add('fa-sun'); // Show sun in dark mode
                } else {
                    document.documentElement.classList.remove('dark');
                    app.dom.themeIcon.classList.remove('fa-sun');
                    app.dom.themeIcon.classList.add('fa-moon'); // Show moon in light mode
                }
            },

            /**
             * Toggle the theme and save the new setting.
             */
            toggleTheme: () => {
                app.state.settings.theme = app.state.settings.theme === 'dark' ? 'light' : 'dark';
                app.applyTheme();
                app.saveState();
            },

            // =================================================================================
            // == ONBOARDING ===================================================================
            // =================================================================================

            showOnboarding: () => {
                // Set today's date for the rotation start date picker
                document.getElementById('onboarding-rotation-start-date').value = app.helpers.formatDateToYYYYMMDD(new Date());
                app.modal.show(app.dom.onboardingModal);
            },

            handleOnboardingStep1: (e) => {
                const nameInput = document.getElementById('onboarding-name-input');
                const name = nameInput.value.trim();
                if (name) {
                    app.state.settings.userName = name;
                    document.getElementById('onboarding-step-1').classList.add('hidden');
                    document.getElementById('onboarding-step-2').classList.remove('hidden');
                } else {
                    nameInput.focus();
                    app.showToast('Please enter your name.', 'error');
                }
            },
            
            handleOnboardingRotationSelect: (e) => {
                const picker = document.getElementById('onboarding-rotation-date-picker');
                if (e.target.value === 'none') {
                    picker.classList.add('hidden');
                } else {
                    picker.classList.remove('hidden');
                }
            },

            handleOnboardingFinish: () => {
                const rotation = document.getElementById('onboarding-rotation-select').value;
                const startDate = document.getElementById('onboarding-rotation-start-date').value;

                app.state.settings.schoolRotation = rotation;
                if (rotation !== 'none') {
                    if (!startDate) {
                        app.showToast('Please select a start date for your rotation.', 'error');
                        return;
                    }
                    app.state.settings.rotationStartDate = startDate;
                } else {
                    app.state.settings.rotationStartDate = null;
                }

                app.state.onboardingComplete = true;
                app.saveState();
                app.modal.hide(app.dom.onboardingModal);
                app.renderAll();
                app.showToast(`Welcome, ${app.state.settings.userName}!`, 'success');
            },


            // =================================================================================
            // == MASTER RENDER & NAVIGATION ===================================================
            // =================================================================================

            /**
             * The master render function.
             * This function is responsible for calling all sub-render functions
             * to update the UI based on the current app.state.
             */
            renderAll: () => {
                console.log('Rendering all... View:', app.state.currentView);
                // Update active view
                app.dom.appViews.forEach(view => {
                    if (view.dataset.view === app.state.currentView) {
                        view.classList.remove('hidden');
                    } else {
                        view.classList.add('hidden');
                    }
                });

                // Update active nav link
                app.dom.navLinks.forEach(link => {
                    if (link.dataset.view === app.state.currentView) {
                        link.classList.add('bg-brand-accent/10', 'text-brand-accent');
                    } else {
                        link.classList.remove('bg-brand-accent/10', 'text-brand-accent');
                        link.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:bg-brand-lightInput', 'dark:hover:bg-brand-input', 'hover:text-gray-800', 'dark:hover:text-gray-200');
                    }
                });
                
                // Call specific render functions for the current view
                switch (app.state.currentView) {
                    case 'dashboard':
                        app.renderDashboard();
                        app.renderHabits('dashboard');
                        app.renderGamification();
                        break;
                    case 'schedule':
                        app.renderSchedule();
                        break;
                    case 'tasks':
                        app.renderTasks();
                        break;
                    case 'events':
                        app.renderEvents();
                        break;
                    case 'gpa':
                        app.renderGpaCalculator();
                        break;
                    case 'habits':
                        app.renderHabits('full');
                        break;
                    case 'settings':
                        app.renderSettings();
                        break;
                }
            },

            /**
             * Navigate to a different view in the app.
             * @param {string} view - The view to navigate to (e.g., 'dashboard', 'tasks').
             */
            navigateTo: (view) => {
                app.state.currentView = view;
                // Don't save state on navigation, only on explicit user actions
                app.renderAll();
            },
            
            /**
             * Handles rendering the dashboard.
             */
            renderDashboard: () => {
                const today = new Date();
                document.getElementById('user-name-header').textContent = app.state.settings.userName;
                document.getElementById('today-date-header').textContent = today.toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                
                // Render Today's Schedule
                app.renderTodaySchedule();

                // Render Priority Tasks
                const tasksList = document.getElementById('priority-tasks-list');
                const priorityTasks = app.state.tasks
                    .filter(task => !task.completed && (task.priority === 'high' || task.priority === 'medium'))
                    .sort(app.helpers.sortTasks);
                
                if (priorityTasks.length === 0) {
                    tasksList.innerHTML = `<p class="text-gray-500 dark:text-gray-400">You're all caught up!</p>`;
                } else {
                    tasksList.innerHTML = priorityTasks
                        .slice(0, 5) // Show top 5
                        .map(task => app.templates.taskItem(task))
                        .join('');
                    app.helpers.addTaskEventListeners(tasksList);
                }
            },

            renderTodaySchedule: () => {
                const container = document.getElementById('today-schedule-list');
                const todayStr = app.helpers.formatDateToYYYYMMDD(new Date());
                const rotationDay = app.helpers.calculateRotationDay(new Date());

                const rotationLabel = document.getElementById('today-rotation-day-label');
                if (rotationDay) {
                    rotationLabel.textContent = `(Day ${rotationDay})`;
                } else {
                    rotationLabel.textContent = '';
                }
                
                const classes = app.state.schedule.classes
                    .filter(c => c.day == rotationDay) // Use == for type coercion (string/number)
                    .map(c => ({ ...c, type: 'class' }));
                    
                const events = app.state.events
                    .filter(e => e.date === todayStr)
                    .map(e => ({ ...e, type: 'event' }));
                
                const items = [...classes, ...events].sort((a, b) => {
                    const timeA = a.startTime || '00:00';
                    const timeB = b.startTime || '00:00';
                    return timeA.localeCompare(timeB);
                });

                if (items.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400">No classes or events scheduled for today.</p>`;
                    return;
                }

                container.innerHTML = items.map(item => {
                    if (item.type === 'class') {
                        return app.templates.scheduleItem(item.name, item.startTime, item.endTime, item.color);
                    } else {
                        return app.templates.scheduleItem(item.title, item.startTime, item.endTime, item.color);
                    }
                }).join('');
            },

            // =================================================================================
            // == SCHEDULE (Week, Daily, Setup) ================================================
            // =================================================================================
            
            /**
             * Main render function for the 'Schedule' view.
             * Toggles between 'week', 'daily', and 'setup' sub-views.
             */
            renderSchedule: () => {
                // Toggle active tab
                app.dom.scheduleTabBtns.forEach(btn => {
                    if (btn.dataset.scheduleView === app.state.currentScheduleView) {
                        btn.classList.add('border-b-2', 'border-brand-accent', 'text-brand-accent');
                        btn.classList.remove('text-gray-500');
                    } else {
                        btn.classList.remove('border-b-2', 'border-brand-accent', 'text-brand-accent');
                        btn.classList.add('text-gray-500');
                    }
                });

                // Toggle active view
                app.dom.scheduleViews.forEach(view => {
                    if (view.id === `schedule-view-${app.state.currentScheduleView}`) {
                        view.classList.remove('hidden');
                    } else {
                        view.classList.add('hidden');
                    }
                });

                // Call specific render function
                switch (app.state.currentScheduleView) {
                    case 'week':
                        app.renderWeekCalendar();
                        break;
                    case 'daily':
                        app.renderDailyAgenda();
                        break;
                    case 'setup':
                        app.renderClassSetup();
                        break;
                }
            },

            // --- Week View ---
            renderWeekCalendar: () => {
                const week = app.helpers.getWeekDays(app.state.currentWeekDate);
                const weekStart = week[0];
                const weekEnd = week[6];

                app.dom.weekViewTitle.textContent = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

                // Clear existing grid days (keep headers)
                app.dom.weekGridContainer.querySelectorAll('.week-grid-day').forEach(el => el.remove());

                const todayStr = app.helpers.formatDateToYYYYMMDD(new Date());

                week.forEach(day => {
                    const dayStr = app.helpers.formatDateToYYYYMMDD(day);
                    const rotationDay = app.helpers.calculateRotationDay(day);

                    const classes = app.state.schedule.classes
                        .filter(c => c.day == rotationDay) // Coercion
                        .sort((a, b) => a.startTime.localeCompare(b.startTime));
                        
                    const events = app.state.events
                        .filter(e => e.date === dayStr)
                        .sort((a, b) => a.startTime.localeCompare(b.startTime));

                    let dayHtml = `
                        <div class="week-grid-day relative bg-brand-lightCard dark:bg-brand-card p-2 min-h-[120px] overflow-hidden">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold ${dayStr === todayStr ? 'text-brand-accent' : ''}">${day.getDate()}</span>
                                ${rotationDay ? `<span class="text-xs font-semibold text-brand-accent/70">Day ${rotationDay}</span>` : ''}
                            </div>
                            <div class="space-y-1 overflow-y-auto max-h-[90px]">
                    `;

                    if (classes.length === 0 && events.length === 0) {
                        dayHtml += `<!-- No items -->`;
                    } else {
                        classes.forEach(c => {
                            dayHtml += `
                                <div class="text-xs p-1 rounded ${app.helpers.getClassColorClasses(c.color, 'light')}">
                                    <strong>${app.helpers.formatTime(c.startTime)}</strong> ${c.name}
                                </div>
                            `;
                        });
                        events.forEach(e => {
                            dayHtml += `
                                <div class="text-xs p-1 rounded ${app.helpers.getClassColorClasses(e.color, 'light')}">
                                    <strong>${app.helpers.formatTime(e.startTime)}</strong> ${e.title}
                                </div>
                            `;
                        });
                    }

                    dayHtml += `</div></div>`;
                    app.dom.weekGridContainer.insertAdjacentHTML('beforeend', dayHtml);
                });
            },

            // --- Daily View ---
            renderDailyAgenda: () => {
                app.dragState.date = app.helpers.formatDateToYYYYMMDD(app.state.currentDailyDate);
                app.dom.dailyViewTitle.textContent = app.state.currentDailyDate.toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                
                app.dom.dailyAgendaGrid.innerHTML = ''; // Clear grid

                // Add drag preview element
                app.dom.dailyAgendaGrid.appendChild(app.dom.eventDragPreview);

                // Get items for this day
                const dayStr = app.helpers.formatDateToYYYYMMDD(app.state.currentDailyDate);
                const rotationDay = app.helpers.calculateRotationDay(app.state.currentDailyDate);
                
                const classes = app.state.schedule.classes
                    .filter(c => c.day == rotationDay) // Coercion
                    .map(c => ({ ...c, type: 'class' }));
                    
                const events = app.state.events
                    .filter(e => e.date === dayStr)
                    .map(e => ({ ...e, type: 'event' }));

                const items = [...classes, ...events];

                for (let hour = 0; hour < 24; hour++) {
                    const timeLabel = (hour % 12 === 0) ? '12' : (hour % 12);
                    const ampm = hour < 12 ? 'AM' : 'PM';
                    
                    app.dom.dailyAgendaGrid.insertAdjacentHTML('beforeend', `
                        <div class="time-slot pl-12" data-hour="${hour}">
                            ${hour > 0 ? `<span class="time-label">${timeLabel} ${ampm}</span>` : ''}
                        </div>
                    `);
                }

                // Render event blocks
                items.forEach(item => {
                    const [startHour, startMinute] = item.startTime.split(':').map(Number);
                    const [endHour, endMinute] = item.endTime.split(':').map(Number);

                    const top = (startHour * 60 + startMinute) / (24 * 60) * (24 * 60); // 24 slots * 60px/slot
                    const height = ((endHour * 60 + endMinute) - (startHour * 60 + startMinute)) / (24 * 60) * (24 * 60);

                    const title = item.type === 'class' ? item.name : item.title;
                    const eventBlock = document.createElement('div');
                    eventBlock.className = `event-block ${app.helpers.getClassColorClasses(item.color, 'dark')}`;
                    eventBlock.style.top = `${top}px`;
                    eventBlock.style.height = `${height}px`;
                    eventBlock.innerHTML = `
                        <strong class="block">${title}</strong>
                        <span>${app.helpers.formatTime(item.startTime)} - ${app.helpers.formatTime(item.endTime)}</span>
                    `;
                    app.dom.dailyAgendaGrid.appendChild(eventBlock);
                });
            },

            // --- Class Setup View ---
            renderClassSetup: () => {
                const rotation = app.state.settings.schoolRotation;
                app.dom.classDaySelector.innerHTML = ''; // Clear options

                if (rotation === 'none') {
                    app.dom.classDaySelectorContainer.classList.remove('hidden');
                    ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].forEach(day => {
                        app.dom.classDaySelector.insertAdjacentHTML('beforeend', `<option value="${day}">${day}</option>`);
                    });
                } else {
                    app.dom.classDaySelectorContainer.classList.remove('hidden');
                    const numDays = parseInt(rotation);
                    for (let i = 1; i <= numDays; i++) {
                        app.dom.classDaySelector.insertAdjacentHTML('beforeend', `<option value="${i}">Day ${i}</option>`);
                    }
                }
                
                app.renderClassList();
            },

            renderClassList: () => {
                app.dom.classListContainer.innerHTML = '';
                if (app.state.schedule.classes.length === 0) {
                    app.dom.classListContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400">No classes added yet.</p>`;
                    return;
                }

                // Group classes by day
                const groupedClasses = app.state.schedule.classes.reduce((acc, c) => {
                    const day = c.day;
                    if (!acc[day]) acc[day] = [];
                    acc[day].push(c);
                    return acc;
                }, {});

                // Sort group keys
                const rotation = app.state.settings.schoolRotation;
                const dayOrder = (rotation === 'none')
                    ? ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
                    : Object.keys(groupedClasses).sort((a, b) => parseInt(a) - parseInt(b));

                dayOrder.forEach(day => {
                    if (groupedClasses[day]) {
                        const dayLabel = (rotation === 'none') ? day : `Day ${day}`;
                        app.dom.classListContainer.insertAdjacentHTML('beforeend', `<h5 class="font-semibold mt-4 first:mt-0">${dayLabel}</h5>`);
                        
                        // Sort classes by start time
                        const sortedClasses = groupedClasses[day].sort((a,b) => a.startTime.localeCompare(b.startTime));

                        sortedClasses.forEach(c => {
                            app.dom.classListContainer.insertAdjacentHTML('beforeend', app.templates.classItem(c));
                        });
                    }
                });

                // Add event listeners to new buttons
                app.dom.classListContainer.querySelectorAll('.edit-class-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.closest('.class-item').dataset.id;
                        app.handleEditClass(id);
                    });
                });
                app.dom.classListContainer.querySelectorAll('.delete-class-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.closest('.class-item').dataset.id;
                        app.handleDeleteClass(id);
                    });
                });
            },

            // --- Schedule Form Handlers ---
            
            handleColorPickerClick: (pickerElement, inputElement, e) => {
                if (e.target.tagName === 'BUTTON') {
                    const color = e.target.dataset.color;
                    inputElement.value = color;
                    // Update visual selection
                    pickerElement.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('border-white', 'dark:border-white', 'ring-2', 'ring-brand-accent');
                        btn.classList.add('border-transparent');
                    });
                    e.target.classList.add('ring-2', 'ring-brand-accent');
                }
            },
            
            handleClassFormSubmit: (e) => {
                e.preventDefault();
                const id = document.getElementById('class-id-input').value;
                const newClass = {
                    id: id || `class_${new Date().getTime()}`,
                    name: document.getElementById('class-name-input').value,
                    day: document.getElementById('class-day-input').value,
                    startTime: document.getElementById('class-time-start-input').value,
                    endTime: document.getElementById('class-time-end-input').value,
                    color: document.getElementById('class-color-input').value,
                };

                if (!newClass.name || !newClass.startTime || !newClass.endTime) {
                    app.showToast('Please fill out all fields.', 'error');
                    return;
                }

                if (id) {
                    // Update existing class
                    app.state.schedule.classes = app.state.schedule.classes.map(c => c.id === id ? newClass : c);
                    app.showToast('Class updated!', 'success');
                } else {
                    // Add new class
                    app.state.schedule.classes.push(newClass);
                    app.showToast('Class added!', 'success');
                }

                app.saveState();
                app.renderClassList();
                app.renderTodaySchedule(); // Update dashboard
                app.resetClassForm();
            },

            resetClassForm: () => {
                app.dom.classForm.reset();
                document.getElementById('class-id-input').value = '';
                app.dom.classSubmitBtnText.textContent = 'Add Class';
                app.dom.classCancelEditBtn.classList.add('hidden');
                // Reset color picker
                app.dom.classColorInput.value = 'blue';
                app.dom.classColorPicker.querySelectorAll('button').forEach((btn, index) => {
                    btn.classList.remove('ring-2', 'ring-brand-accent');
                    if(index === 0) btn.classList.add('ring-2', 'ring-brand-accent');
                });
            },

            handleEditClass: (id) => {
                const classToEdit = app.state.schedule.classes.find(c => c.id === id);
                if (!classToEdit) return;

                document.getElementById('class-id-input').value = classToEdit.id;
                document.getElementById('class-name-input').value = classToEdit.name;
                document.getElementById('class-day-input').value = classToEdit.day;
                document.getElementById('class-time-start-input').value = classToEdit.startTime;
                document.getElementById('class-time-end-input').value = classToEdit.endTime;
                document.getElementById('class-color-input').value = classToEdit.color;

                // Update color picker
                app.dom.classColorPicker.querySelectorAll('button').forEach(btn => {
                    if (btn.dataset.color === classToEdit.color) {
                        btn.classList.add('ring-2', 'ring-brand-accent');
                    } else {
                        btn.classList.remove('ring-2', 'ring-brand-accent');
                    }
                });
                
                app.dom.classSubmitBtnText.textContent = 'Update Class';
                app.dom.classCancelEditBtn.classList.remove('hidden');
                window.scrollTo(0, 0); // Scroll to top of view
            },

            handleDeleteClass: (id) => {
                app.modal.showConfirm(
                    'Delete Class?',
                    'Are you sure you want to delete this class? This cannot be undone.',
                    () => {
                        app.state.schedule.classes = app.state.schedule.classes.filter(c => c.id !== id);
                        app.saveState();
                        app.renderClassList();
                        app.renderTodaySchedule(); // Update dashboard
                        app.showToast('Class deleted.', 'success');
                    }
                );
            },

            // --- Daily Agenda Click-Drag Handlers ---
            
            handleDragStart: (e) => {
                // Only start drag on the grid itself, not on existing event blocks
                if (e.target !== app.dom.dailyAgendaGrid) return;
                
                app.dragState.isDragging = true;
                const rect = app.dom.dailyAgendaGrid.getBoundingClientRect();
                app.dragState.startY = e.clientY - rect.top + app.dom.dailyAgendaGrid.scrollTop;
                
                // Snap startY to 15-minute intervals
                const startYSnapped = Math.floor(app.dragState.startY / 15) * 15;
                app.dragState.startY = startYSnapped;

                app.dragState.previewEl = app.dom.eventDragPreview;
                app.dragState.previewEl.style.top = `${startYSnapped}px`;
                app.dragState.previewEl.style.height = `30px`; // Min height
                app.dragState.previewEl.style.display = 'block';
            },
            
            handleDragMove: (e) => {
                if (!app.dragState.isDragging) return;
                
                const rect = app.dom.dailyAgendaGrid.getBoundingClientRect();
                let currentY = e.clientY - rect.top + app.dom.dailyAgendaGrid.scrollTop;
                
                // Snap currentY to 15-minute intervals
                currentY = Math.ceil(currentY / 15) * 15;

                const height = Math.max(15, currentY - app.dragState.startY); // Min height of 15px (15 min)

                app.dragState.previewEl.style.height = `${height}px`;
            },
            
            handleDragEnd: (e) => {
                if (!app.dragState.isDragging) return;
                
                app.dragState.isDragging = false;
                app.dragState.previewEl.style.display = 'none';

                const rect = app.dom.dailyAgendaGrid.getBoundingClientRect();
                let endY = e.clientY - rect.top + app.dom.dailyAgendaGrid.scrollTop;
                endY = Math.ceil(endY / 15) * 15;

                const startY = app.dragState.startY;
                const height = Math.max(15, endY - startY);

                if (height <= 15) return; // Drag was too short

                // Convert pixels to time
                // 1440px total height (24 * 60px) = 1440 minutes
                const startMinute = startY;
                const endMinute = startY + height;

                const startTimeStr = app.helpers.minutesToTimeStr(startMinute);
                const endTimeStr = app.helpers.minutesToTimeStr(endMinute);

                // Show event modal pre-filled
                app.showEventModal({
                    date: app.dragState.date,
                    startTime: startTimeStr,
                    endTime: endTimeStr,
                });
                // Fix: Highlight events tab
                app.navigateTo('events');
            },


            // =================================================================================
            // == TASKS ========================================================================
            // =================================================================================

            /**
             * Render the task list based on the current filter.
             */
            renderTasks: () => {
                const container = document.getElementById('task-list-container');
                container.innerHTML = '';
                const filter = app.state.currentTaskFilter;
                
                const filteredTasks = app.state.tasks
                    .filter(task => {
                        if (filter === 'all') return !task.completed;
                        if (filter === 'completed') return task.completed;
                        return task.category === filter && !task.completed;
                    })
                    .sort(app.helpers.sortTasks);

                if (filteredTasks.length === 0) {
                    let msg = "No tasks here. Add one!";
                    if (filter === 'completed') msg = "No completed tasks yet.";
                    else if (filter === 'all') msg = "You're all caught up! Add a new task.";
                    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 p-4 text-center">${msg}</p>`;
                } else {
                    container.innerHTML = filteredTasks.map(app.templates.taskItem).join('');
                    app.helpers.addTaskEventListeners(container);
                }
            },

            /**
             * Show the Add/Edit Task modal.
             * @param {object|null} task - The task object to edit, or null to add a new task.
             */
            showTaskModal: (task = null) => {
                app.dom.taskForm.reset();
                const modalTitle = document.getElementById('task-modal-title');
                const submitBtn = document.getElementById('task-submit-btn');
                
                if (task) {
                    modalTitle.textContent = 'Edit Task';
                    submitBtn.textContent = 'Update Task';
                    document.getElementById('task-id-input').value = task.id;
                    document.getElementById('task-name-input').value = task.name;
                    document.getElementById('task-due-date-input').value = task.dueDate;
                    document.getElementById('task-category-input').value = task.category;
                    document.getElementById('task-priority-input').value = task.priority;
                    document.getElementById('task-notes-input').value = task.notes;
                } else {
                    modalTitle.textContent = 'Add New Task';
                    submitBtn.textContent = 'Add Task';
                    document.getElementById('task-id-input').value = '';
                }
                app.modal.show(app.dom.taskModal);
            },

            /**
             * Handle the submission of the task form.
             */
            handleTaskFormSubmit: (e) => {
                e.preventDefault();
                const id = document.getElementById('task-id-input').value;
                const task = {
                    id: id || `task_${new Date().getTime()}`,
                    name: document.getElementById('task-name-input').value,
                    dueDate: document.getElementById('task-due-date-input').value,
                    category: document.getElementById('task-category-input').value,
                    priority: document.getElementById('task-priority-input').value,
                    notes: document.getElementById('task-notes-input').value,
                    completed: id ? app.state.tasks.find(t => t.id === id).completed : false,
                    completedDate: id ? app.state.tasks.find(t => t.id === id).completedDate : null
                };

                if (!task.name) {
                    app.showToast('Please enter a task name.', 'error');
                    return;
                }

                if (id) {
                    // Update
                    app.state.tasks = app.state.tasks.map(t => t.id === id ? task : t);
                    app.showToast('Task updated!', 'success');
                } else {
                    // Add
                    app.state.tasks.push(task);
                    app.showToast('Task added!', 'success');
                }

                app.saveState();
                app.renderTasks();
                app.modal.hide(app.dom.taskModal);
            },

            /**
             * Toggle the completion status of a task.
             * @param {string} id - The ID of the task.
             */
            toggleTaskComplete: (id) => {
                let xpGained = 0;
                app.state.tasks = app.state.tasks.map(task => {
                    if (task.id === id) {
                        if (!task.completed) {
                            xpGained = 10; // Gain 10 XP for completion
                            return { ...task, completed: true, completedDate: new Date().toISOString() };
                        } else {
                            xpGained = -10; // Lose 10 XP for un-completion
                            return { ...task, completed: false, completedDate: null };
                        }
                    }
                    return task;
                });
                
                if (xpGained > 0) {
                    app.addXP(xpGained);
                    app.showToast('Task completed! +10 XP', 'success');
                } else {
                    app.addXP(xpGained);
                }

                app.saveState();
                app.renderTasks();
                // If on dashboard, re-render priority tasks
                if(app.state.currentView === 'dashboard') {
                    app.renderDashboard();
                }
            },

            /**
             * Delete a task.
             * @param {string} id - The ID of the task to delete.
             */
            deleteTask: (id) => {
                app.modal.showConfirm(
                    'Delete Task?',
                    'Are you sure you want to permanently delete this task?',
                    () => {
                        app.state.tasks = app.state.tasks.filter(task => task.id !== id);
                        app.saveState();
                        app.renderTasks();
                        if(app.state.currentView === 'dashboard') app.renderDashboard();
                        app.showToast('Task deleted.', 'success');
                    }
                );
            },


            // =================================================================================
            // == EVENTS =======================================================================
            // =================================================================================
            
            /**
             * Render the event list, grouped by date.
             */
            renderEvents: () => {
                const container = document.getElementById('event-list-container');
                container.innerHTML = '';
                
                if (app.state.events.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 p-4 text-center">No events scheduled. Add one!</p>`;
                    return;
                }

                // Group events by date
                const groupedEvents = app.state.events.reduce((acc, event) => {
                    const date = event.date;
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(event);
                    return acc;
                }, {});

                // Sort dates
                const sortedDates = Object.keys(groupedEvents).sort();

                sortedDates.forEach(date => {
                    const dateObj = app.helpers.parseYYYYMMDD(date);
                    const dateHeader = dateObj.toLocaleDateString('en-US', {
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                    });
                    
                    container.insertAdjacentHTML('beforeend', `<h3 class="text-xl font-bold mt-6 first:mt-0 mb-3">${dateHeader}</h3>`);
                    
                    // Sort events by start time
                    const eventsOnDay = groupedEvents[date].sort((a,b) => a.startTime.localeCompare(b.startTime));

                    eventsOnDay.forEach(event => {
                        container.insertAdjacentHTML('beforeend', app.templates.eventItem(event));
                    });
                });

                // Add event listeners
                container.querySelectorAll('.edit-event-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.closest('.event-item').dataset.id;
                        const event = app.state.events.find(ev => ev.id === id);
                        if(event) app.showEventModal(event);
                    });
                });
                container.querySelectorAll('.delete-event-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.closest('.event-item').dataset.id;
                        app.deleteEvent(id);
                    });
                });
            },

            /**
             * Show the Add/Edit Event modal.
             * @param {object|null} event - The event object to edit, or partial data, or null.
             */
            showEventModal: (event = null) => {
                app.dom.eventForm.reset();
                const modalTitle = document.getElementById('event-modal-title');
                const submitBtn = document.getElementById('event-submit-btn');
                
                // Set default color
                app.dom.eventColorInput.value = 'purple';
                app.dom.eventColorPicker.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-brand-accent');
                    if(btn.dataset.color === 'purple') btn.classList.add('ring-2', 'ring-brand-accent');
                });
                
                if (event && event.id) { // Editing existing event
                    modalTitle.textContent = 'Edit Event';
                    submitBtn.textContent = 'Update Event';
                    document.getElementById('event-id-input').value = event.id;
                    document.getElementById('event-title-input').value = event.title;
                    document.getElementById('event-date-input').value = event.date;
                    document.getElementById('event-start-time-input').value = event.startTime;
                    document.getElementById('event-end-time-input').value = event.endTime;
                    document.getElementById('event-color-input').value = event.color;
                } else if (event) { // Pre-filling from click-drag
                    modalTitle.textContent = 'Add New Event';
                    submitBtn.textContent = 'Add Event';
                    document.getElementById('event-id-input').value = '';
                    document.getElementById('event-title-input').value = '';
                    document.getElementById('event-date-input').value = event.date;
                    document.getElementById('event-start-time-input').value = event.startTime;
                    document.getElementById('event-end-time-input').value = event.endTime;
                    document.getElementById('event-color-input').value = 'purple';
                } else { // Adding new event
                    modalTitle.textContent = 'Add New Event';
                    submitBtn.textContent = 'Add Event';
                    document.getElementById('event-id-input').value = '';
                    document.getElementById('event-date-input').value = app.helpers.formatDateToYYYYMMDD(new Date()); // Default to today
                }
                
                // Update color picker visual
                const color = document.getElementById('event-color-input').value;
                 app.dom.eventColorPicker.querySelectorAll('button').forEach(btn => {
                    if (btn.dataset.color === color) {
                        btn.classList.add('ring-2', 'ring-brand-accent');
                    } else {
                        btn.classList.remove('ring-2', 'ring-brand-accent');
                    }
                });

                app.modal.show(app.dom.eventModal);
            },

            handleEventFormSubmit: (e) => {
                e.preventDefault();
                const id = document.getElementById('event-id-input').value;
                const event = {
                    id: id || `event_${new Date().getTime()}`,
                    title: document.getElementById('event-title-input').value,
                    date: document.getElementById('event-date-input').value,
                    startTime: document.getElementById('event-start-time-input').value,
                    endTime: document.getElementById('event-end-time-input').value,
                    color: document.getElementById('event-color-input').value,
                };

                if (!event.title || !event.date || !event.startTime || !event.endTime) {
                    app.showToast('Please fill out all fields.', 'error');
                    return;
                }
                
                if (id) {
                    // Update
                    app.state.events = app.state.events.map(ev => ev.id === id ? event : ev);
                    app.showToast('Event updated!', 'success');
                } else {
                    // Add
                    app.state.events.push(event);
                    app.showToast('Event added!', 'success');
                }

                app.saveState();
                app.renderEvents();
                app.renderSchedule(); // Update schedule views
                app.modal.hide(app.dom.eventModal);
            },

            deleteEvent: (id) => {
                app.modal.showConfirm(
                    'Delete Event?',
                    'Are you sure you want to permanently delete this event?',
                    () => {
                        app.state.events = app.state.events.filter(ev => ev.id !== id);
                        app.saveState();
                        app.renderEvents();
                        app.renderSchedule(); // Update schedule views
                        app.showToast('Event deleted.', 'success');
                    }
                );
            },

            // =================================================================================
            // == GPA CALCULATOR ===============================================================
            // =================================================================================

            renderGpaCalculator: () => {
                // Populate grade select options
                app.dom.gpaCourseGradeSelect.innerHTML = '';
                for (const grade in app.state.gpa.gpaScale) {
                    app.dom.gpaCourseGradeSelect.insertAdjacentHTML('beforeend', `<option value="${grade}">${grade}</option>`);
                }
                
                app.renderGpaCourseList();
                app.calculateTotalGpa();
                app.renderGpaScaleSettings();
            },

            renderGpaCourseList: () => {
                app.dom.gpaCourseList.innerHTML = '';
                if (app.state.gpa.courses.length === 0) {
                    app.dom.gpaCourseList.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500 dark:text-gray-400">No courses added yet.</td></tr>`;
                    return;
                }

                app.state.gpa.courses.forEach(course => {
                    app.dom.gpaCourseList.insertAdjacentHTML('beforeend', app.templates.gpaCourseRow(course));
                });
                
                // Add event listeners
                app.dom.gpaCourseList.querySelectorAll('.edit-course-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.closest('tr').dataset.id;
                        app.handleEditCourse(id);
                    });
                });
                app.dom.gpaCourseList.querySelectorAll('.delete-course-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.closest('tr').dataset.id;
                        app.handleDeleteCourse(id);
                    });
                });
            },

            calculateTotalGpa: () => {
                let totalPoints = 0;
                let totalCredits = 0;
                const scale = app.state.gpa.gpaScale;

                app.state.gpa.courses.forEach(course => {
                    const grade = course.grade;
                    const credits = parseFloat(course.credits);
                    const points = scale[grade];

                    if (!isNaN(credits) && points !== undefined) {
                        totalPoints += points * credits;
                        totalCredits += credits;
                    }
                });
                
                const gpa = (totalCredits === 0) ? 0 : (totalPoints / totalCredits);
                app.dom.gpaTotalResult.textContent = gpa.toFixed(2);
                app.dom.gpaTotalCredits.textContent = totalCredits;
            },

            handleGpaFormSubmit: (e) => {
                e.preventDefault();
                const id = document.getElementById('gpa-course-id-input').value;
                const course = {
                    id: id || `gpa_${new Date().getTime()}`,
                    name: document.getElementById('gpa-course-name').value,
                    grade: document.getElementById('gpa-course-grade').value,
                    credits: document.getElementById('gpa-course-credits').value,
                };
                
                if (!course.name || !course.grade || !course.credits) {
                    app.showToast('Please fill out all fields.', 'error');
                    return;
                }

                if (id) {
                    // Update
                    app.state.gpa.courses = app.state.gpa.courses.map(c => c.id === id ? course : c);
                    app.showToast('Course updated!', 'success');
                } else {
                    // Add
                    app.state.gpa.courses.push(course);
                    app.showToast('Course added!', 'success');
                }
                
                app.saveState();
                app.renderGpaCourseList();
                app.calculateTotalGpa();
                app.resetGpaForm();
            },

            resetGpaForm: () => {
                app.dom.gpaCourseForm.reset();
                document.getElementById('gpa-course-id-input').value = '';
                app.dom.gpaFormTitle.textContent = 'Add Course';
                app.dom.gpaSubmitBtn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i>Add Course';
                app.dom.gpaCancelEditBtn.classList.add('hidden');
            },

            handleEditCourse: (id) => {
                const course = app.state.gpa.courses.find(c => c.id === id);
                if (!course) return;

                document.getElementById('gpa-course-id-input').value = course.id;
                document.getElementById('gpa-course-name').value = course.name;
                document.getElementById('gpa-course-grade').value = course.grade;
                document.getElementById('gpa-course-credits').value = course.credits;
                
                app.dom.gpaFormTitle.textContent = 'Edit Course';
                app.dom.gpaSubmitBtn.innerHTML = 'Update Course';
                app.dom.gpaCancelEditBtn.classList.remove('hidden');
                window.scrollTo(0, 0);
            },

            handleDeleteCourse: (id) => {
                app.state.gpa.courses = app.state.gpa.courses.filter(c => c.id !== id);
                app.saveState();
                app.renderGpaCourseList();
                app.calculateTotalGpa();
                app.showToast('Course removed.', 'success');
            },

            handleClearAllCourses: () => {
                app.modal.showConfirm(
                    'Clear All Courses?',
                    'Are you sure you want to delete all courses? This cannot be undone.',
                    () => {
                        app.state.gpa.courses = [];
                        app.saveState();
                        app.renderGpaCourseList();
                        app.calculateTotalGpa();
                        app.showToast('All courses cleared.', 'success');
                    }
                );
            },

            // =================================================================================
            // == HABITS =======================================================================
            // =================================================================================
            
            /**
             * Renders the habits list.
             * @param {string} location - 'dashboard' or 'full' (for the habits page)
             */
            renderHabits: (location = 'dashboard') => {
                const containerId = (location === 'dashboard') ? 'daily-habits-list-dashboard' : 'habits-list-full';
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = '';
                const todayStr = app.helpers.formatDateToYYYYMMDD(new Date());

                if (app.state.habits.length === 0) {
                    let msg = (location === 'dashboard')
                        ? "No habits added yet. Go to the Habits tab to add some!"
                        : "No habits added yet. Add one using the form!";
                    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-sm">${msg}</p>`;
                    return;
                }

                app.state.habits.forEach(habit => {
                    const isCompleted = habit.completedDates.includes(todayStr);
                    container.insertAdjacentHTML('beforeend', app.templates.habitItem(habit, isCompleted, location));
                });
                
                // Add event listeners
                container.querySelectorAll('.habit-checkbox').forEach(box => {
                    box.addEventListener('change', (e) => {
                        const id = e.target.closest('.habit-item').dataset.id;
                        app.toggleHabitComplete(id, todayStr, e.target.checked);
                    });
                });

                if (location === 'full') {
                     container.querySelectorAll('.delete-habit-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = e.currentTarget.closest('.habit-item').dataset.id;
                            app.handleDeleteHabit(id);
                        });
                    });
                }
            },

            handleAddHabit: (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('habit-name-input');
                const name = nameInput.value.trim();
                if (!name) {
                    app.showToast('Please enter a habit name.', 'error');
                    return;
                }

                const newHabit = {
                    id: `habit_${new Date().getTime()}`,
                    name: name,
                    completedDates: []
                };

                app.state.habits.push(newHabit);
                app.saveState();
                app.renderHabits('full');
                nameInput.value = '';
                app.showToast('Habit added!', 'success');
            },

            toggleHabitComplete: (id, dateStr, isCompleted) => {
                let xpGained = 0;
                const habit = app.state.habits.find(h => h.id === id);
                if (!habit) return;

                const completedIndex = habit.completedDates.indexOf(dateStr);

                if (isCompleted && completedIndex === -1) {
                    habit.completedDates.push(dateStr);
                    xpGained = 5; // Gain 5 XP
                    app.showToast('Habit complete! +5 XP', 'success');
                } else if (!isCompleted && completedIndex !== -1) {
                    habit.completedDates.splice(completedIndex, 1);
                    xpGained = -5; // Lose 5 XP
                }
                
                app.addXP(xpGained);
                app.saveState();
                
                // Re-render both lists
                app.renderHabits('dashboard');
                if (app.state.currentView === 'habits') app.renderHabits('full');
            },

            handleDeleteHabit: (id) => {
                app.modal.showConfirm(
                    'Delete Habit?',
                    'Are you sure you want to delete this habit? This will remove all its completion history.',
                    () => {
                        app.state.habits = app.state.habits.filter(h => h.id !== id);
                        app.saveState();
                        app.renderHabits('full');
                        app.showToast('Habit deleted.', 'success');
                    }
                );
            },

            // =================================================================================
            // == GAMIFICATION =================================================================
            // =================================================================================
            
            renderGamification: () => {
                const { level, xp, xpToNextLevel } = app.state.gamification;
                document.getElementById('xp-level').textContent = level;
                document.getElementById('xp-current').textContent = xp;
                document.getElementById('xp-next-level').textContent = xpToNextLevel;
                
                const xpPercentage = Math.max(0, Math.min(100, (xp / xpToNextLevel) * 100));
                document.getElementById('xp-bar').style.width = `${xpPercentage}%`;
            },

            addXP: (amount) => {
                if (amount === 0) return;
                
                app.state.gamification.xp += amount;
                
                // Handle leveling up
                while (app.state.gamification.xp >= app.state.gamification.xpToNextLevel) {
                    app.levelUp();
                }

                // Handle de-leveling (if XP goes negative)
                while (app.state.gamification.xp < 0) {
                    if (app.state.gamification.level === 1) {
                        app.state.gamification.xp = 0;
                        break;
                    }
                    app.deLevel();
                }

                app.renderGamification();
                app.saveState();
            },

            levelUp: () => {
                const { xp, level, xpToNextLevel } = app.state.gamification;
                app.state.gamification.level++;
                app.state.gamification.xp = xp - xpToNextLevel; // Carry over remaining XP
                app.state.gamification.xpToNextLevel = 10000; // Fixed 10,000 XP per level
                
                app.showToast(`Level Up! You are now Level ${app.state.gamification.level}!`, 'success', 5000);
            },

            deLevel: () => {
                const prevXpToNextLevel = 10000; // Fixed 10,000 XP
                app.state.gamification.level--;
                app.state.gamification.xpToNextLevel = prevXpToNextLevel;
                app.state.gamification.xp = prevXpToNextLevel + app.state.gamification.xp; // Add the negative XP to the new max
            },


            // =================================================================================
            // == SETTINGS =====================================================================
            // =================================================================================
            
            renderSettings: () => {
                document.getElementById('settings-name-input').value = app.state.settings.userName;
                document.getElementById('settings-rotation-select').value = app.state.settings.schoolRotation;
                
                const rotationPicker = document.getElementById('settings-rotation-date-picker');
                if (app.state.settings.schoolRotation !== 'none') {
                    rotationPicker.classList.remove('hidden');
                    document.getElementById('settings-rotation-start-date').value = app.state.settings.rotationStartDate;
                } else {
                    rotationPicker.classList.add('hidden');
                }
                
                app.renderGpaScaleSettings();
            },
            
            renderGpaScaleSettings: () => {
                app.dom.gpaScaleSettingsContainer.innerHTML = '';
                for (const grade in app.state.gpa.gpaScale) {
                    const value = app.state.gpa.gpaScale[grade];
                    app.dom.gpaScaleSettingsContainer.insertAdjacentHTML('beforeend', `
                        <div>
                            <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">${grade}</label>
                            <input type="number" step="0.01" data-grade="${grade}" 
                                   class="gpa-scale-input w-full px-3 py-2 rounded-lg bg-brand-lightInput dark:bg-brand-input border border-transparent focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" 
                                   value="${value}">
                        </div>
                    `);
                }
            },

            handleSaveProfile: () => {
                const newName = document.getElementById('settings-name-input').value.trim();
                if (newName) {
                    app.state.settings.userName = newName;
                    app.saveState();
                    document.getElementById('user-name-header').textContent = newName;
                    app.showToast('Profile updated!', 'success');
                } else {
                    app.showToast('Name cannot be empty.', 'error');
                }
            },
            
            handleSettingsRotationSelect: (e) => {
                 const picker = document.getElementById('settings-rotation-date-picker');
                if (e.target.value === 'none') {
                    picker.classList.add('hidden');
                } else {
                    picker.classList.remove('hidden');
                    // Default to today if no date is set
                    if (!document.getElementById('settings-rotation-start-date').value) {
                        document.getElementById('settings-rotation-start-date').value = app.helpers.formatDateToYYYYMMDD(new Date());
                    }
                }
            },

            handleSaveSchedule: () => {
                const rotation = document.getElementById('settings-rotation-select').value;
                const startDate = document.getElementById('settings-rotation-start-date').value;

                if (rotation !== 'none' && !startDate) {
                    app.showToast('Please select a start date for your rotation.', 'error');
                    return;
                }
                
                app.modal.showConfirm(
                    'Update Schedule?',
                    'Changing schedule settings may affect your existing classes. Are you sure?',
                    () => {
                        app.state.settings.schoolRotation = rotation;
                        app.state.settings.rotationStartDate = (rotation === 'none') ? null : startDate;
                        app.saveState();
                        app.showToast('Schedule settings updated!', 'success');
                        app.renderSettings();
                        // May need to re-render schedule views if they are active
                        app.renderAll();
                    }
                );
            },
            
            handleSaveGpaScale: () => {
                const inputs = document.querySelectorAll('.gpa-scale-input');
                const newScale = {};
                let isValid = true;
                
                inputs.forEach(input => {
                    const grade = input.dataset.grade;
                    const value = parseFloat(input.value);
                    if (isNaN(value)) {
                        isValid = false;
                    }
                    newScale[grade] = value;
                });

                if (!isValid) {
                    app.showToast('Invalid GPA value. Please enter numbers only.', 'error');
                    return;
                }

                app.state.gpa.gpaScale = newScale;
                app.saveState();
                app.calculateTotalGpa(); // Recalculate GPA with new scale
                app.showToast('GPA Scale updated!', 'success');
            },

            handleResetApp: () => {
                app.modal.showConfirm(
                    'RESET ALL DATA?',
                    'This is your final warning. All tasks, events, classes, and settings will be permanently deleted. This cannot be undone.',
                    () => {
                        localStorage.removeItem('lockinAppState');
                        app.state = app.getInitialState();
                        // Need to reload the page to re-trigger onboarding
                        window.location.reload();
                    },
                    'DELETE FOREVER' // Custom confirm text
                );
            },


            // =================================================================================
            // == UI TEMPLATES =================================================================
            // =================================================================================
            
            /**
             * Contains functions that return HTML strings for UI components.
             */
            templates: {
                /**
                 * Create HTML for a task item.
                 * @param {object} task - The task object.
                 * @returns {string} HTML string.
                 */
                taskItem: (task) => {
                    const isCompleted = task.completed;
                    const dueDate = app.helpers.formatDate(task.dueDate);
                    const dueClass = app.helpers.getDueDateClass(task.dueDate, isCompleted);
                    const categoryClasses = app.helpers.getCategoryTagClasses(task.category);

                    return `
                        <div class="task-item flex items-center bg-brand-lightCard dark:bg-brand-card shadow-md p-4 rounded-xl ${isCompleted ? 'completed' : ''}" data-id="${task.id}">
                            <input type="checkbox" class="task-checkbox priority-${task.priority}" ${isCompleted ? 'checked' : ''} data-action="toggle">
                            <div class="flex-1 min-w-0">
                                <p class="task-name font-semibold truncate">${task.name}</p>
                                <div class="flex items-center gap-x-3 mt-1">
                                    <span class="task-due text-sm ${dueClass}">${dueDate}</span>
                                    <span class="text-xs font-medium px-2 py-0.5 rounded-full ${categoryClasses}">${task.category}</span>
                                </div>
                                ${task.notes ? `<p class="text-xs text-gray-500 truncate mt-2">${task.notes}</p>` : ''}
                            </div>
                            <div class="flex-shrink-0 ml-4 space-x-2">
                                <button class="task-action-btn text-gray-400 hover:text-brand-accent" data-action="edit">
                                    <i class="fa-solid fa-pencil"></i>
                                </button>
                                <button class="task-action-btn text-gray-400 hover:text-brand-danger" data-action="delete">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                },
                
                /**
                 * Create HTML for a schedule item (class or event) on the dashboard.
                 */
                scheduleItem: (title, startTime, endTime, color) => {
                    const bgColor = app.helpers.getClassColorClasses(color, 'light');
                    const borderColor = app.helpers.getClassColorClasses(color, 'border');

                    return `
                        <div class="flex items-center space-x-4 p-3 rounded-lg ${bgColor}">
                            <div class="flex-shrink-0 w-1.5 h-10 rounded-full ${borderColor}"></div>
                            <div>
                                <p class="font-semibold">${title}</p>
                                <p class="text-sm opacity-80">${app.helpers.formatTime(startTime)} - ${app.helpers.formatTime(endTime)}</p>
                            </div>
                        </div>
                    `;
                },
                
                /**
                 * Create HTML for an event item in the Events list.
                 */
                eventItem: (event) => {
                    return `
                        <div class="event-item flex items-center bg-brand-lightInput dark:bg-brand-input p-4 rounded-xl" data-id="${event.id}">
                            <div class="w-1.5 h-12 rounded-full ${app.helpers.getClassColorClasses(event.color, 'border')} mr-4"></div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold truncate">${event.title}</p>
                                <span class="text-sm text-gray-500 dark:text-gray-400">
                                    ${app.helpers.formatTime(event.startTime)} - ${app.helpers.formatTime(event.endTime)}
                                </span>
                            </div>
                            <div class="flex-shrink-0 ml-4 space-x-2">
                                <button class="edit-event-btn text-gray-400 hover:text-brand-accent">
                                    <i class="fa-solid fa-pencil"></i>
                                </button>
                                <button class="delete-event-btn text-gray-400 hover:text-brand-danger">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                },

                /**
                 * Create HTML for a class item in the setup list.
                 */
                classItem: (c) => {
                    return `
                        <div class="class-item flex items-center bg-brand-lightInput dark:bg-brand-input p-3 rounded-lg" data-id="${c.id}">
                            <div class="w-1.5 h-10 rounded-full ${app.helpers.getClassColorClasses(c.color, 'border')} mr-4"></div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold truncate">${c.name}</p>
                                <span class="text-sm text-gray-500 dark:text-gray-400">
                                    ${app.helpers.formatTime(c.startTime)} - ${app.helpers.formatTime(c.endTime)}
                                </span>
                            </div>
                            <div class="flex-shrink-0 ml-4 space-x-2">
                                <button class="edit-class-btn text-gray-400 hover:text-brand-accent">
                                    <i class="fa-solid fa-pencil"></i>
                                </button>
                                <button class="delete-class-btn text-gray-400 hover:text-brand-danger">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                },
                
                /**
                 * Create HTML for a GPA course row.
                 */
                gpaCourseRow: (course) => {
                    return `
                        <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-brand-lightCardHover/50 dark:hover:bg-brand-cardHover/50" data-id="${course.id}">
                            <td class="p-2 font-medium">${course.name}</td>
                            <td class="p-2 text-center">${course.grade}</td>
                            <td class="p-2 text-center">${course.credits}</td>
                            <td class="p-2 text-right">
                                <button class="edit-course-btn text-gray-400 hover:text-brand-accent px-2">
                                    <i class="fa-solid fa-pencil"></i>
                                </button>
                                <button class="delete-course-btn text-gray-400 hover:text-brand-danger px-2">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                },

                /**
                 * Create HTML for a habit item.
                 * @param {string} location - 'dashboard' or 'full'
                 */
                habitItem: (habit, isCompleted, location) => {
                    return `
                        <div class="habit-item flex items-center justify-between bg-brand-lightInput dark:bg-brand-input p-3 rounded-lg" data-id="${habit.id}">
                            <div class="flex items-center">
                                <input type="checkbox" id="habit-check-${habit.id}" class="habit-checkbox task-checkbox" ${isCompleted ? 'checked' : ''}>
                                <label for="habit-check-${habit.id}" class="font-medium cursor-pointer ${isCompleted ? 'line-through text-gray-500' : ''}">
                                    ${habit.name}
                                </label>
                            </div>
                            ${location === 'full' ? `
                            <button class="delete-habit-btn text-gray-400 hover:text-brand-danger px-2">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                    `;
                },
            },
            
            // =================================================================================
            // == UI HELPERS (Modals, Toasts) ==================================================
            // =================================================================================

            /**
             * Reusable modal logic.
             */
            modal: {
                show: (modalElement) => {
                    modalElement.classList.remove('hidden');
                },
                hide: (modalElement) => {
                    modalElement.classList.add('hidden');
                },
                showConfirm: (title, text, onConfirm, confirmText = 'Confirm') => {
                    document.getElementById('confirm-modal-title').textContent = title;
                    document.getElementById('confirm-modal-text').textContent = text;
                    const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
                    const cancelBtn = document.getElementById('confirm-modal-cancel-btn');
                    confirmBtn.textContent = confirmText;

                    // Remove old listeners and add new ones
                    const newConfirmBtn = confirmBtn.cloneNode(true);
                    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                    newConfirmBtn.addEventListener('click', () => {
                        onConfirm();
                        app.modal.hide(app.dom.confirmModal);
                    });

                    const newCancelBtn = cancelBtn.cloneNode(true);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                    newCancelBtn.addEventListener('click', () => {
                        app.modal.hide(app.dom.confirmModal);
                    });
                    
                    app.modal.show(app.dom.confirmModal);
                },
            },

            /**
             * Show a toast notification.
             * @param {string} message - The text to display.
             * @param {string} type - 'success', 'error', or 'info'.
             * @param {number} duration - How long to show the toast (ms).
             */
            showToast: (message, type = 'info', duration = 3000) => {
                const colors = {
                    success: 'bg-brand-success',
                    error: 'bg-brand-danger',
                    info: 'bg-brand-accent'
                };
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    info: 'fa-info-circle'
                };

                const toast = document.createElement('div');
                toast.className = `flex items-center p-4 mb-3 rounded-lg shadow-lg text-white ${colors[type]} animate-pulseIn`;
                toast.innerHTML = `
                    <i class="fa-solid ${icons[type]} mr-3 text-xl"></i>
                    <span class="font-semibold">${message}</span>
                `;
                app.dom.toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.transition = 'opacity 0.5s ease-out';
                    toast.style.opacity = 0;
                    setTimeout(() => toast.remove(), 500);
                }, duration);
            },


            // =================================================================================
            // == DATA & LOGIC HELPERS =========================================================
            // =================================================================================
            
            /**
             * Reusable helper functions for formatting and calculations.
             */
            helpers: {
                /**
                 * Add listeners for check, edit, delete on a task list.
                 */
                addTaskEventListeners: (container) => {
                    container.querySelectorAll('.task-item').forEach(item => {
                        const id = item.dataset.id;
                        item.querySelector('[data-action="toggle"]').addEventListener('change', () => app.toggleTaskComplete(id));
                        item.querySelector('[data-action="edit"]').addEventListener('click', () => {
                            const task = app.state.tasks.find(t => t.id === id);
                            if(task) app.showTaskModal(task);
                        });
                        item.querySelector('[data-action="delete"]').addEventListener('click', () => app.deleteTask(id));
                    });
                },

                /**
                 * Format a 'YYYY-MM-DD' string to a user-friendly format.
                 */
                formatDate: (dateStr) => {
                    if (!dateStr) return 'No Date';
                    const today = new Date();
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    const date = app.helpers.parseYYYYMMDD(dateStr);
                    
                    if (date.toDateString() === today.toDateString()) return 'Today';
                    if (date.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
                    if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
                    
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                },

                /**
                 * Format a 'YYYY-MM-DD' string from a Date object.
                 */
                formatDateToYYYYMMDD: (date) => {
                    return date.toISOString().split('T')[0];
                },
                
                /**
                 * Parse 'YYYY-MM-DD' string into a Date object, handling timezones.
                 */
                parseYYYYMMDD: (dateStr) => {
                    return new Date(dateStr + 'T00:00:00'); // Use T00:00:00 to avoid timezone shift
                },
                
                /**
                 * Format 'HH:mm' to 'h:mm AM/PM'.
                 */
                formatTime: (timeStr) => {
                    if (!timeStr) return '';
                    const [hour, minute] = timeStr.split(':');
                    const h = parseInt(hour);
                    const m = parseInt(minute);
                    const ampm = h >= 12 ? 'PM' : 'AM';
                    const h12 = h % 12 || 12; // 0 becomes 12
                    return `${h12}:${m < 10 ? '0' + m : m} ${ampm}`;
                },
                
                /**
                 * Convert total minutes from midnight to a 'HH:mm' string.
                 */
                minutesToTimeStr: (totalMinutes) => {
                    const hours = Math.floor(totalMinutes / 60) % 24;
                    const minutes = totalMinutes % 60;
                    return `${hours < 10 ? '0' + hours : hours}:${minutes < 10 ? '0' + minutes : minutes}`;
                },

                /**
                 * Get CSS class for due date based on how soon it is.
                 */
                getDueDateClass: (dateStr, isCompleted) => {
                    if (isCompleted || !dateStr) return 'text-gray-500 dark:text-gray-400';
                    const date = app.helpers.parseYYYYMMDD(dateStr);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const diffTime = date.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays < 0) return 'text-brand-danger font-semibold'; // Overdue
                    if (diffDays === 0) return 'text-brand-warning font-semibold'; // Today
                    if (diffDays === 1) return 'text-blue-400'; // Tomorrow
                    return 'text-gray-500 dark:text-gray-400'; // Later
                },

                /**
                 * Get category text color class.
                 */
                getCategoryColor: (cat) => {
                    switch (cat) {
                        case 'School': return 'text-blue-400';
                        case 'Life': return 'text-green-400';
                        case 'Application': return 'text-purple-400';
                        case 'Social': return 'text-pink-400';
                        default: return 'text-gray-400';
                    }
                },
                
                /**
                 * Get Tailwind classes for a category tag.
                 */
                getCategoryTagClasses: (cat) => {
                    switch (cat) {
                        case 'School': return 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200';
                        case 'Life': return 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-200';
                        case 'Application': return 'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-200';
                        case 'Social': return 'bg-pink-100 text-pink-800 dark:bg-pink-900/50 dark:text-pink-200';
                        default: return 'bg-gray-100 text-gray-800 dark:bg-gray-900/50 dark:text-gray-200';
                    }
                },

                /**
                 * Get Tailwind classes for a class/event color.
                 * @param {string} colorName - e.g., 'blue', 'red'
                 * @param {string} type - 'light' (bg/text), 'dark' (bg/text), 'border' (bg)
                 */
                getClassColorClasses: (colorName, type = 'light') => {
                    const colorMap = {
                        blue: { light: 'bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-200', dark: 'bg-blue-500 text-white', border: 'bg-blue-500' },
                        red: { light: 'bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200', dark: 'bg-red-500 text-white', border: 'bg-red-500' },
                        yellow: { light: 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-200', dark: 'bg-yellow-500 text-white', border: 'bg-yellow-500' },
                        green: { light: 'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200', dark: 'bg-green-500 text-white', border: 'bg-green-500' },
                        purple: { light: 'bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-200', dark: 'bg-purple-500 text-white', border: 'bg-purple-500' },
                        pink: { light: 'bg-pink-100 dark:bg-pink-900/50 text-pink-800 dark:text-pink-200', dark: 'bg-pink-500 text-white', border: 'bg-pink-500' },
                        gray: { light: 'bg-gray-100 dark:bg-gray-900/50 text-gray-800 dark:text-gray-200', dark: 'bg-gray-500 text-white', border: 'bg-gray-500' },
                    };
                    return (colorMap[colorName] || colorMap['gray'])[type];
                },
                
                /**
                 * Sort function for tasks (priority, then due date).
                 */
                sortTasks: (a, b) => {
                    if (a.completed && !b.completed) return 1;
                    if (!a.completed && b.completed) return -1;
                    
                    // Priority
                    const priorityMap = { high: 0, medium: 1, low: 2 };
                    if (priorityMap[a.priority] < priorityMap[b.priority]) return -1;
                    if (priorityMap[a.priority] > priorityMap[b.priority]) return 1;
                    
                    // Due Date
                    const dateA = a.dueDate ? new Date(a.dueDate) : new Date(0);
                    const dateB = b.dueDate ? new Date(b.dueDate) : new Date(0);
                    if (a.dueDate && !b.dueDate) return -1; // Tasks with dates come first
                    if (!a.dueDate && b.dueDate) return 1;
                    return dateA - dateB;
                },
                
                /**
                 * Get the days of the week for a given date (Sun-Sat).
                 * @param {Date} dateInWeek - Any date within the desired week.
                 * @returns {Date[]} An array of 7 Date objects, from Sunday to Saturday.
                 */
                getWeekDays: (dateInWeek) => {
                    const date = new Date(dateInWeek);
                    const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, ...
                    const sunday = new Date(date.setDate(date.getDate() - dayOfWeek));
                    const week = [];
                    for (let i = 0; i < 7; i++) {
                        const nextDay = new Date(sunday);
                        nextDay.setDate(nextDay.getDate() + i);
                        week.push(nextDay);
                    }
                    return week;
                },

                /**
                 * Calculate the current rotation day.
                 * @param {Date} date - The date to check.
                 * @returns {number|null} The rotation day number, or null.
                 */
                calculateRotationDay: (date) => {
                    const rotation = app.state.settings.schoolRotation;
                    const startDateStr = app.state.settings.rotationStartDate;
                    
                    if (rotation === 'none' || !startDateStr) return null;

                    const numDays = parseInt(rotation);
                    const startDate = app.helpers.parseYYYYMMDD(startDateStr);
                    
                    // Normalize target date to start of day
                    const targetDate = new Date(date);
                    targetDate.setHours(0, 0, 0, 0);
                    
                    // Only count weekdays
                    let daysDifference = 0;
                    let currentDate = new Date(startDate);

                    if (targetDate < currentDate) {
                        // Target date is before start date, count backwards
                        while(currentDate > targetDate) {
                            const dayOfWeek = currentDate.getDay();
                            if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Not Sunday or Saturday
                                daysDifference--;
                            }
                            currentDate.setDate(currentDate.getDate() - 1);
                        }
                    } else {
                         // Target date is after start date, count forwards
                        while(currentDate < targetDate) {
                            const dayOfWeek = currentDate.getDay();
                            if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Not Sunday or Saturday
                                daysDifference++;
                            }
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                    
                    // Check target date itself
                    const targetDayOfWeek = targetDate.getDay();
                    if (targetDayOfWeek === 0 || targetDayOfWeek === 6) return null; // It's a weekend

                    if (daysDifference < 0) {
                         // (daysDifference % numDays) + numDays handles negative modulo
                        return ((daysDifference % numDays) + numDays) % numDays + 1;
                    }

                    return (daysDifference % numDays) + 1;
                },
            }
        };

        // =================================================================================
        // == APP START ====================================================================
        // =================================================================================
        
        // Add daily login check function
        app.checkDailyLoginXP = () => {
            const todayStr = app.helpers.formatDateToYYYYMMDD(new Date());
            if (app.state.gamification.lastLoginDate !== todayStr) {
                app.state.gamification.lastLoginDate = todayStr;
                // Only add XP if it's not the very first login (i.e., lastLoginDate was not null)
                if (app.state.gamification.lastLoginDate !== null && app.state.onboardingComplete) {
                     // Check if it's not the first session
                    const lastLogin = localStorage.getItem('lockinAppState'); // Check if state was saved before
                    if(lastLogin) {
                        app.addXP(20);
                        app.showToast('Daily Login! +20 XP', 'info');
                    }
                }
                app.saveState(); // Save the new login date
            }
        };

        window.onload = app.init;

    </script>
</body>
</html>
