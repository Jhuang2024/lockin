<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOCKIN | Student Life Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            dark: '#0f0f13',
                            card: '#18181b',
                            accent: 'var(--brand-accent)', // Dynamic Color
                            success: '#10b981',
                            warning: '#f59e0b',
                            danger: '#ef4444',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --brand-accent: #8b5cf6; /* Default Violet */
        }

        body {
            background-color: #050505;
            color: #e4e4e7;
            -webkit-font-smoothing: antialiased;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-heavy {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #0f0f13;
        }
        ::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #52525b;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .timer-circle {
            transition: stroke-dashoffset 1s linear;
        }

        /* Progress Bar Animation */
        .xp-bar {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col md:flex-row">

    <!-- Mobile Navigation (Bottom) -->
    <nav class="md:hidden fixed bottom-0 w-full glass-heavy z-50 border-t border-white/10 flex justify-around py-3 px-2">
        <button onclick="router('dashboard')" class="nav-btn text-gray-400 hover:text-white flex flex-col items-center gap-1 active" data-target="dashboard">
            <i class="fa-solid fa-bolt text-lg"></i>
            <span class="text-[10px]">Home</span>
        </button>
        <button onclick="router('calendar')" class="nav-btn text-gray-400 hover:text-white flex flex-col items-center gap-1" data-target="calendar">
            <i class="fa-regular fa-calendar text-lg"></i>
            <span class="text-[10px]">Agenda</span>
        </button>
        <button onclick="openAddModal()" class="text-white bg-brand-accent rounded-full w-12 h-12 flex items-center justify-center -mt-6 shadow-lg shadow-brand-accent/30 border-4 border-[#050505]">
            <i class="fa-solid fa-plus text-xl"></i>
        </button>
        <button onclick="router('tasks')" class="nav-btn text-gray-400 hover:text-white flex flex-col items-center gap-1" data-target="tasks">
            <i class="fa-solid fa-list-check text-lg"></i>
            <span class="text-[10px]">Tasks</span>
        </button>
        <button onclick="router('grades')" class="nav-btn text-gray-400 hover:text-white flex flex-col items-center gap-1" data-target="grades">
            <i class="fa-solid fa-graduation-cap text-lg"></i>
            <span class="text-[10px]">Grades</span>
        </button>
    </nav>

    <!-- Desktop Navigation (Sidebar) -->
    <aside class="hidden md:flex w-64 glass flex-col justify-between p-6 border-r border-white/10 z-40">
        <div>
            <div class="flex items-center gap-3 mb-10">
                <div class="w-8 h-8 rounded bg-brand-accent flex items-center justify-center font-bold text-white">L</div>
                <h1 class="text-2xl font-bold tracking-tighter">LOCKIN</h1>
            </div>

            <nav class="space-y-2">
                <button onclick="router('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all flex items-center gap-3 active" data-target="dashboard">
                    <i class="fa-solid fa-bolt w-5"></i> Dashboard
                </button>
                <button onclick="router('calendar')" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all flex items-center gap-3" data-target="calendar">
                    <i class="fa-regular fa-calendar w-5"></i> Calendar
                </button>
                <button onclick="router('tasks')" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all flex items-center gap-3" data-target="tasks">
                    <i class="fa-solid fa-list-check w-5"></i> Tasks
                </button>
                <button onclick="router('grades')" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all flex items-center gap-3" data-target="grades">
                    <i class="fa-solid fa-graduation-cap w-5"></i> Grades & GPA
                </button>
                <button onclick="router('focus')" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all flex items-center gap-3" data-target="focus">
                    <i class="fa-solid fa-headphones w-5"></i> Focus Mode
                </button>
            </nav>
        </div>

        <div class="space-y-4">
             <button onclick="openAddModal()" class="w-full bg-brand-accent hover:opacity-90 text-white py-3 rounded-xl font-semibold shadow-lg shadow-brand-accent/20 transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus"></i> Add New
            </button>
            <div id="mini-profile" class="flex items-center gap-3 p-3 rounded-xl bg-white/5 cursor-pointer hover:bg-white/10 group" onclick="openSettingsModal()">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-gray-700 to-gray-500 flex items-center justify-center relative">
                    <i class="fa-solid fa-user text-xs"></i>
                </div>
                <div class="flex-1">
                    <p class="text-xs text-gray-400">Level <span id="sidebar-level">1</span></p>
                    <p class="text-sm font-semibold" id="sidebar-username">Student</p>
                </div>
                <i class="fa-solid fa-gear text-gray-500 group-hover:text-white transition"></i>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 h-full overflow-y-auto relative pb-20 md:pb-0" id="main-container">
        <!-- Views injected here by JS -->
    </main>

    <!-- MODALS -->

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[70] bg-black/90 flex items-center justify-center hidden" onclick="if(event.target === this) closeSettingsModal()">
        <div class="glass w-full max-w-md p-6 rounded-2xl animate-enter mx-4">
            <h2 class="text-xl font-bold mb-4">Settings</h2>
            
            <div class="mb-6">
                <p class="text-sm text-gray-400 mb-3 uppercase font-bold tracking-widest">Theme Color</p>
                <div class="flex gap-4">
                    <button onclick="changeTheme('#8b5cf6')" class="w-10 h-10 rounded-full bg-violet-500 border-2 border-transparent hover:border-white focus:ring-2 ring-offset-2 ring-offset-black ring-white"></button>
                    <button onclick="changeTheme('#3b82f6')" class="w-10 h-10 rounded-full bg-blue-500 border-2 border-transparent hover:border-white focus:ring-2 ring-offset-2 ring-offset-black ring-white"></button>
                    <button onclick="changeTheme('#10b981')" class="w-10 h-10 rounded-full bg-emerald-500 border-2 border-transparent hover:border-white focus:ring-2 ring-offset-2 ring-offset-black ring-white"></button>
                    <button onclick="changeTheme('#f43f5e')" class="w-10 h-10 rounded-full bg-rose-500 border-2 border-transparent hover:border-white focus:ring-2 ring-offset-2 ring-offset-black ring-white"></button>
                    <button onclick="changeTheme('#f59e0b')" class="w-10 h-10 rounded-full bg-amber-500 border-2 border-transparent hover:border-white focus:ring-2 ring-offset-2 ring-offset-black ring-white"></button>
                </div>
            </div>

            <div class="border-t border-white/10 pt-4">
                <button onclick="clearData()" class="text-red-500 text-sm hover:underline">Reset All Data</button>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboarding-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-90 flex items-center justify-center hidden">
        <div class="glass w-full max-w-lg p-8 rounded-2xl animate-enter mx-4">
            <h2 class="text-3xl font-bold mb-2">Welcome to LOCKIN</h2>
            <p class="text-gray-400 mb-6">Let's set up your profile to optimize your schedule.</p>
            
            <form id="onboarding-form" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Your Name</label>
                    <input type="text" id="ob-name" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-brand-accent" placeholder="e.g. Alex" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Grade Level</label>
                    <select id="ob-grade" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:outline-none">
                        <option value="9">Grade 9 (Freshman)</option>
                        <option value="10">Grade 10 (Sophomore)</option>
                        <option value="11">Grade 11 (Junior)</option>
                        <option value="12">Grade 12 (Senior)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Top Goal</label>
                    <input type="text" id="ob-goal" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-brand-accent" placeholder="e.g. Get into Stanford, Pass Math">
                </div>
                <button type="submit" class="w-full bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200 mt-4">Start Locking In</button>
            </form>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="add-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-end md:items-center justify-center hidden" onclick="if(event.target === this) closeAddModal()">
        <div class="glass-heavy w-full max-w-lg p-6 rounded-t-2xl md:rounded-2xl animate-enter mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Quick Add</h3>
                <button onclick="closeAddModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="flex gap-4 mb-4 border-b border-white/10 pb-2">
                <button onclick="switchAddTab('task')" id="tab-task" class="text-sm font-semibold text-brand-accent border-b-2 border-brand-accent pb-2 px-2 transition-all">Task</button>
                <button onclick="switchAddTab('event')" id="tab-event" class="text-sm font-semibold text-gray-400 pb-2 px-2 transition-all hover:text-white">Event</button>
            </div>

            <form id="add-form">
                <input type="hidden" id="add-type" value="task">
                
                <div class="space-y-4">
                    <div>
                        <input type="text" id="add-title" class="w-full bg-transparent text-xl font-semibold placeholder-gray-600 focus:outline-none" placeholder="What needs to be done?" required autofocus>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500 uppercase">Category</label>
                            <select id="add-category" class="w-full bg-white/5 border border-white/10 rounded-lg p-2 text-sm text-white mt-1">
                                <option value="School">School</option>
                                <option value="Life">Life</option>
                                <option value="Application">Application</option>
                                <option value="Social">Social</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 uppercase">Due Date</label>
                            <input type="date" id="add-date" class="w-full bg-white/5 border border-white/10 rounded-lg p-2 text-sm text-white mt-1">
                        </div>
                    </div>
                    
                    <div id="time-input-container" class="hidden">
                         <label class="text-xs text-gray-500 uppercase">Time</label>
                         <input type="time" id="add-time" class="w-full bg-white/5 border border-white/10 rounded-lg p-2 text-sm text-white mt-1">
                    </div>

                    <div class="flex gap-2 pt-2">
                        <span class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded border border-red-500/30 cursor-pointer" onclick="setPriority('Critical')">Critical</span>
                        <span class="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded border border-yellow-500/30 cursor-pointer" onclick="setPriority('Medium')">Medium</span>
                        <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded border border-blue-500/30 cursor-pointer" onclick="setPriority('Low')">Low</span>
                        <input type="hidden" id="add-priority" value="Medium">
                    </div>

                    <button type="submit" class="w-full bg-brand-accent hover:opacity-90 py-3 rounded-lg font-bold shadow-lg shadow-brand-accent/20">
                        Create <span id="btn-action-text">Task</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- STATE MANAGEMENT ---
        const STORE_KEY = 'lockin_app_data_v2'; // Bumped version for new schema
        
        let store = {
            user: null, // { name, grade, goal }
            settings: { theme: '#8b5cf6' },
            xp: 0,
            level: 1,
            tasks: [], // { id, title, category, date, priority, completed }
            events: [], // { id, title, type, date, time }
            grades: [], // { id, className, grade, type } (type: AP, Honors, Regular)
            habits: [
                { id: 1, title: "Sleep before 12", completedToday: false },
                { id: 2, title: "Drink Water", completedToday: false },
                { id: 3, title: "Study 30m", completedToday: false }
            ],
            focusLog: 0 // minutes
        };

        // --- INIT & UTILS ---
        function init() {
            const data = localStorage.getItem(STORE_KEY);
            if (data) {
                const parsed = JSON.parse(data);
                store = { ...store, ...parsed }; // Merge to ensure new fields exist
                // Reset habits if new day
                const lastLogin = localStorage.getItem('lockin_last_login');
                const today = new Date().toDateString();
                if(lastLogin !== today) {
                    store.habits.forEach(h => h.completedToday = false);
                    localStorage.setItem('lockin_last_login', today);
                }
            }
            
            // Apply Theme
            changeTheme(store.settings.theme, false);

            if (!store.user) {
                document.getElementById('onboarding-modal').classList.remove('hidden');
            } else {
                updateSidebar();
                router('dashboard');
            }
        }

        function saveData() {
            localStorage.setItem(STORE_KEY, JSON.stringify(store));
            updateSidebar();
        }

        function updateSidebar() {
            if(store.user) {
                document.getElementById('sidebar-username').textContent = store.user.name;
                document.getElementById('sidebar-level').textContent = store.level;
            }
        }

        function clearData() {
            if(confirm("Reset all data? This cannot be undone.")) {
                localStorage.removeItem(STORE_KEY);
                location.reload();
            }
        }

        function changeTheme(color, save = true) {
            document.documentElement.style.setProperty('--brand-accent', color);
            if(save) {
                store.settings.theme = color;
                saveData();
            }
        }

        function openSettingsModal() {
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function addXP(amount) {
            store.xp += amount;
            // Level up logic: Level = 1 + floor(xp / 1000)
            const newLevel = 1 + Math.floor(store.xp / 1000);
            if(newLevel > store.level) {
                alert(`LEVEL UP! You are now Level ${newLevel}`);
                store.level = newLevel;
            }
            saveData();
            // Refresh dashboard if active to show bar update
            if(document.querySelector('.nav-btn[data-target="dashboard"]').classList.contains('active')) {
                renderDashboard(document.getElementById('main-container'));
            }
        }

        function router(viewName) {
            // Update UI Active States
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === viewName) {
                    btn.classList.add('text-white', 'active');
                    if(window.innerWidth >= 768) btn.classList.add('bg-white/5');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('text-white', 'active', 'bg-white/5');
                    btn.classList.add('text-gray-400');
                }
            });

            const container = document.getElementById('main-container');
            container.innerHTML = ''; // Clear content
            container.scrollTop = 0;

            switch(viewName) {
                case 'dashboard': renderDashboard(container); break;
                case 'tasks': renderTasks(container); break;
                case 'calendar': renderCalendar(container); break;
                case 'focus': renderFocus(container); break;
                case 'grades': renderGrades(container); break;
            }
        }

        // --- VIEWS ---

        function renderDashboard(container) {
            const today = new Date();
            const hour = today.getHours();
            let greeting = "Good Morning";
            if (hour >= 12) greeting = "Good Afternoon";
            if (hour >= 17) greeting = "Good Evening";

            // Stats
            const pendingTasks = store.tasks.filter(t => !t.completed).length;
            const eventsToday = store.events.filter(e => e.date === today.toISOString().split('T')[0]).length;
            
            // XP Progress
            const xpForNextLevel = store.level * 1000;
            const xpCurrentLevel = store.xp % 1000;
            const xpPercent = (xpCurrentLevel / 1000) * 100;

            // Overload Logic
            let overloadBanner = '';
            if (pendingTasks > 6) {
                overloadBanner = `
                <div class="mb-6 p-4 rounded-xl bg-brand-danger/10 border border-brand-danger/30 text-brand-danger flex items-center gap-3 animate-enter">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <div>
                        <p class="font-bold text-sm">High Workload Detected</p>
                        <p class="text-xs opacity-80">You have ${pendingTasks} tasks pending. Try focusing on the top 3 priorities.</p>
                    </div>
                </div>`;
            }

            container.innerHTML = `
                <div class="max-w-5xl mx-auto p-6 animate-enter">
                    <header class="mb-8 flex justify-between items-end">
                        <div>
                            <p class="text-gray-400 text-sm mb-1">${today.toDateString()}</p>
                            <h2 class="text-3xl font-bold">${greeting}, ${store.user.name}.</h2>
                        </div>
                        <div class="hidden md:block text-right">
                             <p class="text-2xl font-mono font-bold text-brand-accent">${store.focusLog}m</p>
                             <p class="text-xs text-gray-500 uppercase tracking-widest">Focus Today</p>
                        </div>
                    </header>

                    <!-- Level Bar -->
                    <div class="mb-8">
                        <div class="flex justify-between text-xs font-bold uppercase tracking-widest text-gray-500 mb-2">
                            <span>Level ${store.level}</span>
                            <span>${xpCurrentLevel} / 1000 XP</span>
                        </div>
                        <div class="h-2 w-full bg-white/10 rounded-full overflow-hidden">
                            <div class="h-full bg-brand-accent xp-bar" style="width: ${xpPercent}%"></div>
                        </div>
                    </div>

                    ${overloadBanner}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Left Col: Tasks & Habits -->
                        <div class="md:col-span-2 space-y-6">
                            
                            <!-- Today's Snapshot -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="glass p-5 rounded-2xl border-l-4 border-brand-accent">
                                    <p class="text-gray-400 text-xs uppercase mb-2">Pending Tasks</p>
                                    <p class="text-3xl font-bold">${pendingTasks}</p>
                                </div>
                                <div class="glass p-5 rounded-2xl border-l-4 border-blue-500">
                                    <p class="text-gray-400 text-xs uppercase mb-2">Events Today</p>
                                    <p class="text-3xl font-bold">${eventsToday}</p>
                                </div>
                            </div>

                            <!-- Tasks Section -->
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-lg">Up Next</h3>
                                    <button onclick="router('tasks')" class="text-xs text-brand-accent hover:underline">View All</button>
                                </div>
                                <div class="space-y-3">
                                    ${store.tasks.filter(t => !t.completed).slice(0, 3).map(task => `
                                        <div class="glass p-4 rounded-xl flex items-center gap-4 hover:bg-white/5 transition group">
                                            <button onclick="toggleTask(${task.id})" class="w-5 h-5 rounded-full border border-gray-500 hover:border-brand-accent flex items-center justify-center transition">
                                                <div class="w-3 h-3 rounded-full bg-brand-accent opacity-0 group-hover:opacity-100"></div>
                                            </button>
                                            <div class="flex-1">
                                                <p class="font-semibold text-sm">${task.title}</p>
                                                <div class="flex gap-2 text-xs text-gray-500 mt-1">
                                                    <span class="${getCategoryColor(task.category)}">${task.category}</span>
                                                    <span>•</span>
                                                    <span>${task.date || 'No Date'}</span>
                                                </div>
                                            </div>
                                            ${task.priority === 'Critical' ? '<i class="fa-solid fa-flag text-red-500 text-xs"></i>' : ''}
                                        </div>
                                    `).join('') || '<p class="text-gray-500 italic text-sm">No tasks pending. You\'re free!</p>'}
                                </div>
                            </div>
                        </div>

                        <!-- Right Col: Habits & Schedule -->
                        <div class="space-y-6">
                            <!-- Habits -->
                            <div class="glass p-6 rounded-2xl">
                                <h3 class="font-bold text-lg mb-4">Daily Habits</h3>
                                <div class="space-y-3">
                                    ${store.habits.map(habit => `
                                        <div class="flex items-center justify-between cursor-pointer" onclick="toggleHabit(${habit.id})">
                                            <span class="text-sm ${habit.completedToday ? 'text-gray-500 line-through' : 'text-gray-200'}">${habit.title}</span>
                                            <i class="fa-solid fa-check-circle ${habit.completedToday ? 'text-brand-success' : 'text-gray-700'}"></i>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Simple Schedule (Demo) -->
                            <div class="glass p-6 rounded-2xl">
                                <h3 class="font-bold text-lg mb-4">Schedule</h3>
                                <div class="relative pl-4 border-l border-white/10 space-y-6">
                                    ${eventsToday > 0 ? store.events.filter(e => e.date === today.toISOString().split('T')[0]).map(e => `
                                        <div class="relative">
                                            <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-brand-accent"></div>
                                            <p class="text-sm font-semibold">${e.title}</p>
                                            <p class="text-xs text-gray-500">${e.time || 'All Day'}</p>
                                        </div>
                                    `).join('') : `
                                        <div class="relative">
                                            <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-blue-500"></div>
                                            <p class="text-sm font-semibold">School Day</p>
                                            <p class="text-xs text-gray-500">8:00 AM - 3:00 PM</p>
                                        </div>
                                        <p class="text-xs text-gray-500 pt-2">No specific events added.</p>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGrades(container) {
            // Calculate GPA
            let totalPoints = 0;
            let totalClasses = store.grades.length;
            
            store.grades.forEach(g => {
                let points = 0;
                const grade = parseFloat(g.grade);
                if(grade >= 90) points = 4.0;
                else if(grade >= 80) points = 3.0;
                else if(grade >= 70) points = 2.0;
                else if(grade >= 60) points = 1.0;
                else points = 0.0;
                
                // Add weight? (Simplified unweighted for now display, but let's assume standard)
                totalPoints += points;
            });

            const gpa = totalClasses > 0 ? (totalPoints / totalClasses).toFixed(2) : '0.00';

            container.innerHTML = `
                <div class="max-w-3xl mx-auto p-6 animate-enter pb-24">
                    <header class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-bold">Grades</h2>
                            <p class="text-gray-400 text-sm">Track your performance.</p>
                        </div>
                        <div class="text-right">
                             <p class="text-4xl font-mono font-bold text-brand-accent">${gpa}</p>
                             <p class="text-xs text-gray-500 uppercase tracking-widest">GPA (Unweighted)</p>
                        </div>
                    </header>

                    <!-- Add Class Form -->
                    <div class="glass p-4 rounded-xl mb-8">
                        <form id="grade-form" class="flex gap-2 flex-col md:flex-row">
                            <input type="text" id="g-name" placeholder="Class Name (e.g. AP Calc)" class="flex-1 bg-white/5 border border-white/10 rounded-lg p-2 text-sm text-white focus:outline-none" required>
                            <input type="number" id="g-grade" placeholder="Current Grade %" class="w-full md:w-32 bg-white/5 border border-white/10 rounded-lg p-2 text-sm text-white focus:outline-none" required>
                            <button type="submit" class="bg-brand-accent text-white px-6 py-2 rounded-lg font-bold text-sm">Add</button>
                        </form>
                    </div>

                    <div class="space-y-3">
                         ${store.grades.map(g => `
                            <div class="glass p-4 rounded-xl flex items-center justify-between group">
                                <div>
                                    <p class="font-semibold">${g.className}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right">
                                        <p class="text-xl font-bold ${g.grade >= 90 ? 'text-brand-success' : (g.grade >= 70 ? 'text-brand-warning' : 'text-brand-danger')}">${g.grade}%</p>
                                    </div>
                                    <button onclick="deleteGrade(${g.id})" class="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                         `).join('') || '<div class="text-center py-8 text-gray-500 italic">No classes added yet.</div>'}
                    </div>
                </div>
            `;

            // Attach listener dynamically since we overwrite innerHTML
            setTimeout(() => {
                const form = document.getElementById('grade-form');
                if(form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const name = document.getElementById('g-name').value;
                        const grade = document.getElementById('g-grade').value;
                        
                        store.grades.push({
                            id: Date.now(),
                            className: name,
                            grade: grade
                        });
                        saveData();
                        renderGrades(container);
                    });
                }
            }, 0);
        }

        function deleteGrade(id) {
            store.grades = store.grades.filter(g => g.id !== id);
            saveData();
            renderGrades(document.getElementById('main-container'));
        }

        function renderTasks(container) {
            const sortedTasks = [...store.tasks].sort((a,b) => new Date(a.date) - new Date(b.date));
            const active = sortedTasks.filter(t => !t.completed);
            const completed = sortedTasks.filter(t => t.completed);

            container.innerHTML = `
                <div class="max-w-3xl mx-auto p-6 animate-enter pb-24">
                    <h2 class="text-2xl font-bold mb-6">Tasks</h2>
                    
                    <!-- Filters (Visual Only for MVP) -->
                    <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6">
                        <button class="bg-white text-black px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap">All</button>
                        <button class="bg-white/5 border border-white/10 text-gray-300 px-4 py-1.5 rounded-full text-sm font-semibold whitespace-nowrap hover:bg-white/10">School</button>
                        <button class="bg-white/5 border border-white/10 text-gray-300 px-4 py-1.5 rounded-full text-sm font-semibold whitespace-nowrap hover:bg-white/10">Life</button>
                        <button class="bg-white/5 border border-white/10 text-gray-300 px-4 py-1.5 rounded-full text-sm font-semibold whitespace-nowrap hover:bg-white/10">Applications</button>
                    </div>

                    <div class="space-y-4">
                        <p class="text-xs text-gray-500 font-bold tracking-widest uppercase">To Do (${active.length})</p>
                        ${active.map(task => renderTaskItem(task)).join('')}
                        ${active.length === 0 ? '<div class="text-center py-10 text-gray-600">No active tasks. <br> Time to relax or add more.</div>' : ''}
                    </div>

                    <div class="mt-8 space-y-4 opacity-60">
                         <div class="flex items-center gap-2 cursor-pointer" onclick="document.getElementById('completed-list').classList.toggle('hidden')">
                             <i class="fa-solid fa-chevron-down text-xs"></i>
                             <p class="text-xs text-gray-500 font-bold tracking-widest uppercase">Completed (${completed.length})</p>
                         </div>
                         <div id="completed-list" class="space-y-2 hidden">
                             ${completed.map(task => renderTaskItem(task)).join('')}
                         </div>
                    </div>
                </div>
            `;
        }

        function renderTaskItem(task) {
            return `
                <div class="glass p-4 rounded-xl flex items-start gap-4 group ${task.completed ? 'opacity-50' : ''}">
                    <button onclick="toggleTask(${task.id})" class="mt-1 w-5 h-5 flex-shrink-0 rounded-full border ${task.completed ? 'bg-brand-success border-brand-success' : 'border-gray-500 hover:border-brand-accent'} flex items-center justify-center transition">
                         ${task.completed ? '<i class="fa-solid fa-check text-black text-xs"></i>' : ''}
                    </button>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                             <p class="font-semibold text-sm ${task.completed ? 'line-through text-gray-500' : ''}">${task.title}</p>
                             <button onclick="deleteTask(${task.id})" class="text-gray-600 hover:text-red-500 transition"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                        <div class="flex gap-2 text-xs text-gray-500 mt-1 items-center">
                            <span class="${getCategoryColor(task.category)} border border-white/5 px-1.5 py-0.5 rounded">${task.category}</span>
                            ${task.date ? `<span><i class="fa-regular fa-clock mr-1"></i>${formatDate(task.date)}</span>` : ''}
                            ${task.priority === 'Critical' ? '<span class="text-red-400 font-bold">!!!</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCalendar(container) {
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth();
            const monthName = date.toLocaleString('default', { month: 'long' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Generate Grid
            let daysHtml = '';
            for(let i=0; i<firstDay; i++) {
                daysHtml += `<div></div>`;
            }
            for(let d=1; d<=daysInMonth; d++) {
                const dayString = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasEvent = store.events.some(e => e.date === dayString);
                const hasTask = store.tasks.some(t => t.date === dayString && !t.completed);
                const isToday = d === date.getDate();

                daysHtml += `
                    <div class="aspect-square rounded-lg flex flex-col items-center justify-center relative ${isToday ? 'bg-brand-accent text-white' : 'hover:bg-white/5 text-gray-300'}">
                        <span class="text-sm">${d}</span>
                        <div class="flex gap-1 mt-1">
                            ${hasEvent ? `<div class="w-1 h-1 rounded-full ${isToday ? 'bg-white' : 'bg-blue-400'}"></div>` : ''}
                            ${hasTask ? `<div class="w-1 h-1 rounded-full ${isToday ? 'bg-white' : 'bg-green-400'}"></div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Events List for selected month
            const monthEvents = store.events
                .filter(e => new Date(e.date).getMonth() === month)
                .sort((a,b) => new Date(a.date) - new Date(b.date));

            container.innerHTML = `
                <div class="max-w-4xl mx-auto p-6 animate-enter h-full flex flex-col md:flex-row gap-8">
                    <!-- Calendar Grid -->
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">${monthName} ${year}</h2>
                            <div class="flex gap-2">
                                <button class="w-8 h-8 rounded bg-white/5 hover:bg-white/10 flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
                                <button class="w-8 h-8 rounded bg-white/5 hover:bg-white/10 flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs text-gray-500 font-bold uppercase">
                            <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                        </div>
                        <div class="grid grid-cols-7 gap-2">
                            ${daysHtml}
                        </div>
                    </div>

                    <!-- Upcoming List -->
                    <div class="md:w-80 glass p-6 rounded-2xl h-fit">
                        <h3 class="font-bold mb-4">Upcoming Events</h3>
                        <div class="space-y-4">
                            ${monthEvents.map(e => `
                                <div class="flex gap-3">
                                    <div class="flex flex-col items-center text-gray-400 w-10">
                                        <span class="text-xs font-bold uppercase">${new Date(e.date).toLocaleString('default', {month:'short'})}</span>
                                        <span class="text-lg font-bold text-white">${new Date(e.date).getDate() + 1}</span>
                                    </div>
                                    <div class="flex-1 pb-3 border-b border-white/10">
                                        <p class="text-sm font-semibold">${e.title}</p>
                                        <p class="text-xs text-gray-500">${e.type} • ${e.time || 'All Day'}</p>
                                    </div>
                                </div>
                            `).join('') || '<p class="text-sm text-gray-500">No events this month.</p>'}
                        </div>
                        <button onclick="openAddModal(true)" class="w-full mt-4 py-2 border border-white/10 rounded-lg text-sm hover:bg-white/5 transition">Add Event</button>
                    </div>
                </div>
            `;
        }

        let focusTimer = null;
        let focusTimeLeft = 25 * 60;
        let isFocusing = false;

        function renderFocus(container) {
            container.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center animate-enter relative overflow-hidden">
                    <!-- Background blobs -->
                    <div class="absolute top-10 left-10 w-64 h-64 bg-brand-accent/20 rounded-full blur-[100px]"></div>
                    <div class="absolute bottom-10 right-10 w-64 h-64 bg-blue-500/10 rounded-full blur-[100px]"></div>

                    <div class="text-center z-10">
                        <div class="mb-8">
                            <h2 class="text-4xl font-bold mb-2">Focus Mode</h2>
                            <p class="text-gray-400">Lock In. Distractions Out.</p>
                        </div>

                        <!-- Timer Display -->
                        <div class="relative w-64 h-64 mx-auto mb-8 flex items-center justify-center">
                            <svg class="absolute inset-0 w-full h-full transform -rotate-90">
                                <circle cx="128" cy="128" r="120" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="transparent"/>
                                <circle id="timer-ring" cx="128" cy="128" r="120" stroke="var(--brand-accent)" stroke-width="8" fill="transparent" stroke-dasharray="754" stroke-dashoffset="0" stroke-linecap="round" class="timer-circle"/>
                            </svg>
                            <div class="text-6xl font-mono font-bold tracking-tighter" id="timer-display">25:00</div>
                        </div>

                        <!-- Task Selection -->
                        <div class="mb-8 max-w-xs mx-auto">
                            <select id="focus-task-select" class="w-full bg-white/5 border border-white/10 rounded-lg p-2 text-sm text-center focus:outline-none">
                                <option value="">-- Select a task to lock in on --</option>
                                ${store.tasks.filter(t => !t.completed).map(t => `<option value="${t.id}">${t.title}</option>`).join('')}
                            </select>
                        </div>

                        <!-- Controls -->
                        <div class="flex gap-4 justify-center">
                            <button onclick="toggleTimer()" id="timer-btn" class="w-16 h-16 rounded-full bg-white text-black flex items-center justify-center text-xl hover:scale-105 transition shadow-[0_0_20px_rgba(255,255,255,0.3)]">
                                <i class="fa-solid fa-play ml-1"></i>
                            </button>
                            <button onclick="resetTimer()" class="w-16 h-16 rounded-full bg-white/10 text-white flex items-center justify-center text-xl hover:bg-white/20 transition">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- ACTIONS & LOGIC ---

        function toggleTimer() {
            const btn = document.getElementById('timer-btn');
            const ring = document.getElementById('timer-ring');
            
            if (isFocusing) {
                // Pause
                clearInterval(focusTimer);
                isFocusing = false;
                btn.innerHTML = '<i class="fa-solid fa-play ml-1"></i>';
                ring.style.stroke = "#f59e0b"; // Warning color paused
            } else {
                // Start
                if(focusTimeLeft <= 0) focusTimeLeft = 25 * 60;
                isFocusing = true;
                btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                ring.style.stroke = "var(--brand-accent)";

                focusTimer = setInterval(() => {
                    focusTimeLeft--;
                    updateTimerDisplay();
                    
                    if (focusTimeLeft <= 0) {
                        clearInterval(focusTimer);
                        isFocusing = false;
                        btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                        store.focusLog += 25; // Add to stats
                        addXP(100); // XP Reward
                        saveData();
                        alert("Session Complete! +100 XP");
                    }
                }, 1000);
            }
        }

        function resetTimer() {
            clearInterval(focusTimer);
            isFocusing = false;
            focusTimeLeft = 25 * 60;
            updateTimerDisplay();
            document.getElementById('timer-btn').innerHTML = '<i class="fa-solid fa-play ml-1"></i>';
            document.getElementById('timer-ring').style.strokeDashoffset = 0;
        }

        function updateTimerDisplay() {
            const m = Math.floor(focusTimeLeft / 60);
            const s = focusTimeLeft % 60;
            document.getElementById('timer-display').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            
            // Update Ring
            const totalTime = 25 * 60;
            const progress = focusTimeLeft / totalTime;
            const dashoffset = 754 * (1 - progress);
            document.getElementById('timer-ring').style.strokeDashoffset = dashoffset;
        }

        // Form Handling
        document.getElementById('onboarding-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('ob-name').value;
            const grade = document.getElementById('ob-grade').value;
            const goal = document.getElementById('ob-goal').value;

            store.user = { name, grade, goal, classes: [] };
            saveData();
            document.getElementById('onboarding-modal').classList.add('hidden');
            updateSidebar();
            router('dashboard');
        });

        // Add Modal Logic
        function openAddModal(isEvent = false) {
            document.getElementById('add-modal').classList.remove('hidden');
            if(isEvent) switchAddTab('event');
            else switchAddTab('task');
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
            document.getElementById('add-form').reset();
        }

        function switchAddTab(type) {
            const taskTab = document.getElementById('tab-task');
            const eventTab = document.getElementById('tab-event');
            const timeInput = document.getElementById('time-input-container');
            const actionText = document.getElementById('btn-action-text');
            const typeInput = document.getElementById('add-type');

            if(type === 'task') {
                taskTab.classList.add('text-brand-accent', 'border-brand-accent');
                taskTab.classList.remove('text-gray-400');
                eventTab.classList.remove('text-brand-accent', 'border-brand-accent');
                eventTab.classList.add('text-gray-400');
                timeInput.classList.add('hidden');
                actionText.textContent = "Task";
                typeInput.value = "task";
            } else {
                eventTab.classList.add('text-brand-accent', 'border-brand-accent');
                eventTab.classList.remove('text-gray-400');
                taskTab.classList.remove('text-brand-accent', 'border-brand-accent');
                taskTab.classList.add('text-gray-400');
                timeInput.classList.remove('hidden');
                actionText.textContent = "Event";
                typeInput.value = "event";
            }
        }

        document.getElementById('add-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const type = document.getElementById('add-type').value;
            const title = document.getElementById('add-title').value;
            const category = document.getElementById('add-category').value;
            const date = document.getElementById('add-date').value;
            const priority = document.getElementById('add-priority').value;

            if (type === 'task') {
                const newTask = {
                    id: Date.now(),
                    title,
                    category,
                    date,
                    priority,
                    completed: false
                };
                store.tasks.push(newTask);
                addXP(10); // Creating task reward
            } else {
                const time = document.getElementById('add-time').value;
                const newEvent = {
                    id: Date.now(),
                    title,
                    type: category, // reusing category logic as type
                    date,
                    time
                };
                store.events.push(newEvent);
            }

            saveData();
            closeAddModal();
            // Refresh current view
            const activeBtn = document.querySelector('.nav-btn.active');
            if(activeBtn) router(activeBtn.dataset.target);
        });

        function setPriority(p) {
            document.getElementById('add-priority').value = p;
            alert(`Priority set to ${p}`);
        }

        // Data Manipulation
        function toggleTask(id) {
            const task = store.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                if(task.completed) addXP(50); // Completion reward
                saveData();
                const activeBtn = document.querySelector('.nav-btn.active');
                if(activeBtn) router(activeBtn.dataset.target);
            }
        }

        function deleteTask(id) {
            store.tasks = store.tasks.filter(t => t.id !== id);
            saveData();
            const activeBtn = document.querySelector('.nav-btn.active');
            if(activeBtn) router(activeBtn.dataset.target);
        }

        function toggleHabit(id) {
            const habit = store.habits.find(h => h.id === id);
            if(habit) {
                habit.completedToday = !habit.completedToday;
                if(habit.completedToday) addXP(20);
                saveData();
                renderDashboard(document.getElementById('main-container')); // Re-render only dashboard
            }
        }

        // Helpers
        function getCategoryColor(cat) {
            switch(cat) {
                case 'School': return 'text-blue-400';
                case 'Life': return 'text-green-400';
                case 'Application': return 'text-purple-400';
                case 'Social': return 'text-pink-400';
                default: return 'text-gray-400';
            }
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Initialize App
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>