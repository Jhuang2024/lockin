<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOCKIN | Student Life Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono:wght==400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            // Dark Theme Colors
                            dark: '#0f0f13',
                            card: '#18181b',
                            // Light Theme Colors
                            light: '#f9fafb',
                            lightCard: '#ffffff',

                            accent: '#8b5cf6', // Violet
                            success: '#10b981',
                            warning: '#f59e0b',
                            danger: '#ef4444',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base styles for dark mode (default) */
        .dark body {
            background-color: #050505;
            color: #e4e4e7;
        }
        .dark .glass {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .dark .glass-heavy {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        /* Light mode overrides */
        body {
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s, color 0.3s;
        }
        .light body {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .light .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .light .glass-heavy {
             background: rgba(243, 244, 246, 0.95);
             backdrop-filter: blur(16px);
             -webkit-backdrop-filter: blur(16px);
        }
        .light .nav-btn {
            color: #6b7280;
        }
        .light .nav-btn.active {
            background-color: #e5e7eb;
            color: #1f2937;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f0f13; }
        .light ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        .light ::-webkit-scrollbar-thumb { background: #9ca3af; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        .light ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .timer-circle {
            transition: stroke-dashoffset 1s linear;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: var(--color);
            border: 2px solid var(--border-color);
            z-index: 10;
            transform: translateX(-50%);
        }
        .timeline-item {
            padding-left: 1rem;
            position: relative;
        }

        /* Weekly View Grid */
        .weekly-grid {
            display: grid;
            grid-template-columns: 80px repeat(7, minmax(100px, 1fr));
            gap: 1px;
            overflow-x: auto;
            max-width: 100%;
        }

        .weekly-header, .weekly-time, .weekly-cell {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(24, 24, 27, 0.6);
            min-width: 100px;
        }

        .light .weekly-header, .light .weekly-time, .light .weekly-cell {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
        }

        .weekly-time {
            position: sticky;
            left: 0;
            z-index: 20;
            text-align: right;
            font-size: 0.75rem;
            min-width: 80px;
            padding-right: 12px;
            background-color: rgba(10, 10, 10, 0.85); /* Heavy glass for sticky */
        }
        
        .light .weekly-time {
            background-color: rgba(243, 244, 246, 0.95);
        }

    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col md:flex-row font-sans">

    <!-- Mobile Navigation (Bottom) -->
    <nav class="md:hidden fixed bottom-0 w-full glass-heavy z-50 border-t border-white/10 dark:border-white/10 flex justify-around py-3 px-2">
        <button onclick="router('dashboard')" class="nav-btn text-gray-400 hover:text-brand-accent flex flex-col items-center gap-1 active" data-target="dashboard">
            <i class="fa-solid fa-bolt text-lg"></i>
            <span class="text-[10px]">Home</span>
        </button>
        <button onclick="router('calendar')" class="nav-btn text-gray-400 hover:text-brand-accent flex flex-col items-center gap-1" data-target="calendar">
            <i class="fa-regular fa-calendar text-lg"></i>
            <span class="text-[10px]">Agenda</span>
        </button>
        <button onclick="openAddModal()" class="text-white bg-brand-accent rounded-full w-12 h-12 flex items-center justify-center -mt-6 shadow-lg shadow-brand-accent/30 border-4 border-[#050505] dark:border-[#050505] light:border-[#f3f4f6]">
            <i class="fa-solid fa-plus text-xl"></i>
        </button>
        <button onclick="router('tasks')" class="nav-btn text-gray-400 hover:text-brand-accent flex flex-col items-center gap-1" data-target="tasks">
            <i class="fa-solid fa-list-check text-lg"></i>
            <span class="text-[10px]">Tasks</span>
        </button>
        <button onclick="router('settings')" class="nav-btn text-gray-400 hover:text-brand-accent flex flex-col items-center gap-1" data-target="settings">
            <i class="fa-solid fa-gear text-lg"></i>
            <span class="text-[10px]">Settings</span>
        </button>
    </nav>

    <!-- Desktop Navigation (Sidebar) -->
    <aside class="hidden md:flex w-64 glass flex-col justify-between p-6 border-r border-white/10 dark:border-white/10 z-40 light:border-gray-200">
        <div>
            <div class="flex items-center gap-3 mb-10">
                <div class="w-8 h-8 rounded bg-brand-accent flex items-center justify-center font-bold text-white">L</div>
                <h1 class="text-2xl font-bold tracking-tighter">LOCKIN</h1>
            </div>

            <nav class="space-y-2">
                <button onclick="router('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 light:hover:bg-gray-100 transition-all flex items-center gap-3 active" data-target="dashboard">
                    <i class="fa-solid fa-bolt w-5"></i> Dashboard
                </button>
                <button onclick="router('calendar')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 light:hover:bg-gray-100 transition-all flex items-center gap-3" data-target="calendar">
                    <i class="fa-regular fa-calendar w-5"></i> Agenda
                </button>
                <button onclick="router('tasks')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 light:hover:bg-gray-100 transition-all flex items-center gap-3" data-target="tasks">
                    <i class="fa-solid fa-list-check w-5"></i> Tasks
                </button>
                <button onclick="router('focus')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 light:hover:bg-gray-100 transition-all flex items-center gap-3" data-target="focus">
                    <i class="fa-solid fa-headphones w-5"></i> Focus Mode
                </button>
                 <button onclick="router('settings')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 light:hover:bg-gray-100 transition-all flex items-center gap-3" data-target="settings">
                    <i class="fa-solid fa-gear w-5"></i> Settings
                </button>
            </nav>
        </div>

        <div class="space-y-4">
             <button onclick="openAddModal()" class="w-full bg-brand-accent hover:bg-violet-600 text-white py-3 rounded-xl font-semibold shadow-lg shadow-brand-accent/20 transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus"></i> Add New
            </button>
            <div id="mini-profile" class="flex items-center gap-3 p-3 rounded-xl bg-white/5 light:bg-gray-100 cursor-pointer hover:bg-white/10 light:hover:bg-gray-200" onclick="clearData()">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-400 to-emerald-400"></div>
                <div>
                    <p class="text-xs text-gray-400 light:text-gray-500">Settings / Reset</p>
                    <p class="text-sm font-semibold" id="sidebar-username">Student</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 h-full overflow-y-auto relative pb-20 md:pb-0" id="main-container">
        <!-- Views injected here by JS -->
    </main>

    <!-- MODALS -->

    <!-- Onboarding Modal -->
    <div id="onboarding-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-90 dark:bg-opacity-90 light:bg-black/50 flex items-center justify-center hidden">
        <div class="glass w-full max-w-lg p-8 rounded-2xl animate-enter mx-4 light:text-gray-900 light:bg-white/90">
            <h2 class="text-3xl font-bold mb-2">Welcome to LOCKIN</h2>
            <p class="text-gray-400 dark:text-gray-400 light:text-gray-600 mb-6">
                Let’s set up your account. After this, you’ll connect your class schedule
                either by <span class="font-semibold">uploading your calendar</span> or
                <span class="font-semibold">adding it manually</span>.
            </p>
            
            <form id="onboarding-form" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 dark:text-gray-400 light:text-gray-600 mb-1">Your Name</label>
                    <input type="text" id="ob-name" class="w-full bg-white/5 border border-white/10 dark:bg-white/5 dark:border-white/10 light:bg-gray-100 light:border-gray-300 rounded-lg p-3 text-white dark:text-white light:text-gray-900 focus:outline-none focus:border-brand-accent" placeholder="e.g. Alex" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 dark:text-gray-400 light:text-gray-600 mb-1">Grade Level</label>
                    <select id="ob-grade" class="w-full bg-white/5 border border-white/10 dark:bg-white/5 dark:border-white/10 light:bg-gray-100 light:border-gray-300 rounded-lg p-3 text-white dark:text-white light:text-gray-900 focus:outline-none">
                        <option value="9">Grade 9 (Freshman)</option>
                        <option value="10">Grade 10 (Sophomore)</option>
                        <option value="11">Grade 11 (Junior)</option>
                        <option value="12">Grade 12 (Senior)</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-brand-accent text-white font-bold py-3 rounded-lg hover:bg-violet-600 mt-4">Continue</button>
            </form>
        </div>
    </div>
    
    <!-- Schedule Input Modal (Step 2 of Onboarding) -->
    <div id="schedule-setup-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-90 dark:bg-opacity-90 light:bg-black/50 flex items-center justify-center hidden">
        <div class="glass w-full max-w-lg p-8 rounded-2xl animate-enter mx-4 light:text-gray-900 light:bg-white/90">
            <h2 class="text-3xl font-bold mb-2">Connect Your Schedule</h2>
            <p class="text-gray-400 dark:text-gray-400 light:text-gray-600 mb-6">
                Pull your classes from your calendar, or build your schedule directly inside LOCKIN.
            </p>
            
            <div class="space-y-4">
                <!-- Hidden file input for calendar upload -->
                <input type="file" id="calendar-file" accept=".ics,text/calendar" class="hidden" onchange="handleCalendarFile(this.files[0])">
                
                <button onclick="triggerCalendarUpload()" class="w-full text-left p-4 rounded-xl border border-white/10 dark:border-white/10 light:border-gray-300 hover:bg-white/5 light:hover:bg-gray-100 transition flex items-center gap-4">
                    <i class="fa-brands fa-google text-2xl text-red-500"></i>
                    <div>
                        <p class="font-bold">Upload Google Calendar (.ics)</p>
                        <p class="text-sm text-gray-500">
                            Export your class calendar from Google as an <span class="font-mono">.ics</span> file and upload it here.
                        </p>
                    </div>
                </button>
                 <button onclick="manualScheduleEntry()" class="w-full text-left p-4 rounded-xl border border-white/10 dark:border-white/10 light:border-gray-300 hover:bg-white/5 light:hover:bg-gray-100 transition flex items-center gap-4">
                    <i class="fa-solid fa-keyboard text-2xl text-brand-accent"></i>
                    <div>
                        <p class="font-bold">Set Up Manually</p>
                        <p class="text-sm text-gray-500">
                            Define your time blocks and classes in Settings. Good if your school uses a custom rotation.
                        </p>
                    </div>
                </button>
            </div>
            
        </div>
    </div>


    <!-- Add Item Modal -->
    <div id="add-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-end md:items-center justify-center hidden" onclick="if(event.target === this) closeAddModal()">
        <div class="glass-heavy w-full max-w-lg p-6 rounded-t-2xl md:rounded-2xl animate-enter mx-auto light:bg-gray-100/90 light:text-gray-900">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Quick Add</h3>
                <button onclick="closeAddModal()" class="text-gray-400 hover:text-white light:hover:text-gray-800"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="flex gap-4 mb-4 border-b border-white/10 dark:border-white/10 light:border-gray-300 pb-2">
                <button onclick="switchAddTab('task')" id="tab-task" class="text-sm font-semibold text-brand-accent border-b-2 border-brand-accent pb-2 px-2 transition-all">Task</button>
                <button onclick="switchAddTab('event')" id="tab-event" class="text-sm font-semibold text-gray-400 dark:text-gray-400 light:text-gray-500 pb-2 px-2 transition-all hover:text-white light:hover:text-gray-900">Event</button>
            </div>

            <form id="add-form">
                <input type="hidden" id="add-type" value="task">
                
                <div class="space-y-4">
                    <div>
                        <input type="text" id="add-title" class="w-full bg-transparent text-xl font-semibold placeholder-gray-600 dark:placeholder-gray-600 light:placeholder-gray-400 focus:outline-none light:text-gray-900" placeholder="What needs to be done?" required autofocus>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500 uppercase">Category / Type</label>
                            <select id="add-category" class="w-full bg-white/5 border border-white/10 dark:bg-white/5 dark:border-white/10 light:bg-gray-100 light:border-gray-300 rounded-lg p-2 text-sm text-white dark:text-white light:text-gray-900 mt-1">
                                <option value="School">School</option>
                                <option value="Life">Life</option>
                                <option value="Application">Application</option>
                                <option value="Social">Social</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 uppercase">Due Date</label>
                            <input type="date" id="add-date" class="w-full bg-white/5 border border-white/10 dark:bg-white/5 dark:border-white/10 light:bg-gray-100 light:border-gray-300 rounded-lg p-2 text-sm text-white dark:text-white light:text-gray-900 mt-1">
                        </div>
                    </div>
                    
                    <div id="time-input-container" class="hidden">
                         <label class="text-xs text-gray-500 uppercase">Time (Optional)</label>
                         <input type="time" id="add-time" class="w-full bg-white/5 border border-white/10 dark:bg-white/5 dark:border-white/10 light:bg-gray-100 light:border-gray-300 rounded-lg p-2 text-sm text-white dark:text-white light:text-gray-900 mt-1">
                    </div>

                    <div class="flex gap-2 pt-2" id="priority-options">
                        <span class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded border border-red-500/30 cursor-pointer" onclick="setPriority('Critical')">Critical</span>
                        <span class="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded border border-yellow-500/30 cursor-pointer" onclick="setPriority('Medium')">Medium</span>
                        <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded border border-blue-500/30 cursor-pointer" onclick="setPriority('Low')">Low</span>
                        <input type="hidden" id="add-priority" value="Medium">
                    </div>

                    <button type="submit" class="w-full bg-brand-accent hover:bg-violet-600 py-3 rounded-lg font-bold shadow-lg shadow-brand-accent/20">
                        Create <span id="btn-action-text">Task</span>
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- STATE MANAGEMENT ---
        const STORE_KEY = 'lockin_app_data_v3';
        
        let store = {
            theme: 'dark', // 'dark' or 'light'
            user: null, // { name, grade, scheduleType }
            tasks: [
                 { id: 1, title: "Finish AP History Reading", category: "School", date: new Date(Date.now() + 86400000).toISOString().split('T')[0], priority: "Critical", completed: false },
                 { id: 2, title: "Apply for Summer Internship", category: "Application", date: new Date(Date.now() + (3 * 86400000)).toISOString().split('T')[0], priority: "Medium", completed: false },
                 { id: 3, title: "Buy Birthday Card for Mom", category: "Life", date: new Date(Date.now() + (5 * 86400000)).toISOString().split('T')[0], priority: "Low", completed: false },
            ],
            events: [
                { id: 201, title: "Team Meeting", type: "Social", date: new Date().toISOString().split('T')[0], time: '17:00' },
                { id: 202, title: "Math Tutoring", type: "School", date: new Date().toISOString().split('T')[0], time: '18:30' },
            ],
            habits: [
                { id: 1, title: "Sleep before 12", completedToday: false },
                { id: 2, title: "Drink Water", completedToday: false },
                { id: 3, title: "Study 30m", completedToday: false }
            ],
            focusLog: 0, // minutes
            schedule: {
                dayType: 'Static', // 'Static' or starting day of AB rotation
                classes: [
                    // Default / Example Schedule (cleared on first onboarding)
                    { id: 101, name: "AP English", color: "blue", blocks: ["A1"] },
                    { id: 102, name: "AP US History", color: "yellow", blocks: ["B1"] },
                    { id: 103, name: "Calculus", color: "red", blocks: ["A2", "B2"] },
                    { id: 104, name: "Physics", color: "green", blocks: ["A3"] },
                ],
                blockMap: { 
                    'A1': { start: '08:30', end: '09:45' },
                    'B1': { start: '09:50', end: '11:05' },
                    'A2': { start: '11:10', end: '12:25' },
                    'B2': { start: '13:00', end: '14:15' },
                    'A3': { start: '14:20', end: '15:35' },
                }
            }
        };

        let currentCalendarView = 'daily'; // daily, weekly, monthly
        let currentCalendarDate = new Date();

        // --- INIT & UTILS ---
        function init() {
            const data = localStorage.getItem(STORE_KEY);
            if (data) {
                const storedData = JSON.parse(data);
                store = { ...store, ...storedData };

                // Reset habits if new day
                const lastLogin = localStorage.getItem('lockin_last_login');
                const today = new Date().toDateString();
                if(lastLogin !== today) {
                    store.habits.forEach(h => h.completedToday = false);
                    localStorage.setItem('lockin_last_login', today);
                }
            }
            
            setTheme(store.theme);

            if (!store.user) {
                document.getElementById('onboarding-modal').classList.remove('hidden');
            } else {
                updateSidebar();
                router('dashboard');
            }
        }

        function saveData() {
            localStorage.setItem(STORE_KEY, JSON.stringify(store));
            updateSidebar();
        }
        
        function setTheme(theme) {
            store.theme = theme;
            document.documentElement.className = theme;
            saveData();
            // Re-render current view to apply new theme colors if necessary (e.g., calendar)
            const activeBtn = document.querySelector('.nav-btn.active');
            if(activeBtn) router(activeBtn.dataset.target);
        }

        function updateSidebar() {
            if(store.user) {
                document.getElementById('sidebar-username').textContent = store.user.name;
            }
        }

        function clearData() {
            if(confirm("DANGER ZONE: Reset all data? This cannot be undone.")) {
                localStorage.removeItem(STORE_KEY);
                location.reload();
            }
        }

        function router(viewName) {
            // Update UI Active States for Sidebar/Mobile Nav
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = btn.dataset.target === viewName;
                const isDesktop = window.innerWidth >= 768;
                
                // Reset classes
                btn.classList.remove('active', 'text-white', 'text-brand-accent', 'bg-white/5', 'light:bg-gray-100');
                btn.classList.add('text-gray-400');
                
                if (isActive) {
                    btn.classList.add('active', 'text-brand-accent');
                    if (isDesktop) {
                        btn.classList.add('bg-white/5');
                        if (store.theme === 'light') btn.classList.add('light:bg-gray-100');
                        btn.classList.remove('text-gray-400');
                        btn.classList.add('text-white', 'light:text-gray-900');
                    } else {
                        btn.classList.remove('text-gray-400');
                        btn.classList.add('text-brand-accent');
                    }
                }
            });

            const container = document.getElementById('main-container');
            container.innerHTML = ''; // Clear content
            container.scrollTop = 0;

            switch(viewName) {
                case 'dashboard': renderDashboard(container); break;
                case 'tasks': renderTasks(container); break;
                case 'calendar': renderCalendar(container); break;
                case 'focus': renderFocus(container); break;
                case 'settings': renderSettings(container); break;
            }
        }

        // --- SCHEDULE LOGIC ---
        // Determines the day type (A/B) based on the starting day type and current date difference
        function getDayTypeForDate(date) {
            if (!store.user || store.user.scheduleType !== 'AB') return 'Static';
            
            const startDate = new Date(); // Simplified: assume start date is today
            const timeDiff = date.getTime() - startDate.getTime();
            const dayDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
            
            // Alternating days logic: Day 0 is A. Day 1 is B. Day 2 is A.
            return (dayDiff % 2 === 0) ? store.schedule.dayType : (store.schedule.dayType === 'A' ? 'B' : 'A');
        }

        function getClassesForDate(date) {
            const dayType = getDayTypeForDate(date);
            const classes = store.schedule.classes || [];
            const blockMap = store.schedule.blockMap || {};
            
            let scheduleItems = [];

            // 1. Add classes for the determined dayType (A or B)
            classes.forEach(cls => {
                cls.blocks.forEach(blockKey => {
                    const blockPrefix = (store.user && store.user.scheduleType === 'AB') ? blockKey[0] : 'Static';
                    const isCorrectBlock = (!store.user || store.user.scheduleType === 'Static') || blockPrefix === dayType;
                    
                    if (isCorrectBlock) {
                        const time = blockMap[blockKey];
                        if (time) {
                            scheduleItems.push({
                                title: cls.name,
                                type: 'Class',
                                color: cls.color,
                                start: time.start,
                                end: time.end,
                                timeSort: time.start.replace(':', '')
                            });
                        }
                    }
                });
            });

            // 2. Add events for this specific date
            const dateStr = date.toISOString().split('T')[0];
            const eventsForDate = store.events.filter(e => e.date === dateStr);

            eventsForDate.forEach(event => {
                scheduleItems.push({
                    title: event.title,
                    type: event.type,
                    color: getCategoryColor(event.type).replace('text-', '').replace('-400', ''), // Use type color
                    start: event.time || '00:00',
                    end: event.time ? getEndTime(event.time) : '23:59',
                    timeSort: event.time ? event.time.replace(':', '') : '0000'
                });
            });

            // 3. Sort by start time
            return scheduleItems.sort((a, b) => (a.timeSort || '0000') - (b.timeSort || '0000'));
        }

        // Helper to get a simple end time 1 hour later for events if not specified
        function getEndTime(startTime) {
            if (!startTime) return '23:59';
            const [h, m] = startTime.split(':').map(Number);
            let endH = h + 1;
            let endM = m;
            if (endH >= 24) endH = 23;
            return `${String(endH).padStart(2, '0')}:${String(endM).padStart(2, '0')}`;
        }


        // --- VIEWS ---

        function renderDashboard(container) {
            if (!store.user) return; 

            const today = new Date();
            const hour = today.getHours();
            let greeting = "Good Morning";
            if (hour >= 12) greeting = "Good Afternoon";
            if (hour >= 17) greeting = "Good Evening";

            // Stats
            const pendingTasks = store.tasks.filter(t => !t.completed).length;
            
            // Dynamic Schedule
            const dayType = getDayTypeForDate(today);
            const todaysSchedule = getClassesForDate(today);
            const classesToday = todaysSchedule.filter(item => item.type === 'Class').length;
            const eventsToday = todaysSchedule.filter(item => item.type !== 'Class').length;


            // Overload Logic
            let overloadBanner = '';
            if (pendingTasks > 6) {
                overloadBanner = `
                <div class="mb-6 p-4 rounded-xl bg-brand-danger/10 border border-brand-danger/30 text-brand-danger flex items-center gap-3 animate-enter">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <div>
                        <p class="font-bold text-sm">High Workload Detected</p>
                        <p class="text-xs opacity-80">You have ${pendingTasks} tasks pending. Try focusing on the top 3 priorities.</p>
                    </div>
                </div>`;
            }

            container.innerHTML = `
                <div class="max-w-5xl mx-auto p-6 animate-enter">
                    <header class="mb-8 flex justify-between items-end">
                        <div>
                            <p class="text-gray-400 text-sm mb-1">${today.toDateString()} &bull; Day ${dayType}</p>
                            <h2 class="text-3xl font-bold">${greeting}, ${store.user.name}.</h2>
                        </div>
                        <div class="hidden md:block text-right">
                             <p class="text-2xl font-mono font-bold text-brand-accent">${store.focusLog}m</p>
                             <p class="text-xs text-gray-500 uppercase tracking-widest">Focus Today</p>
                        </div>
                    </header>

                    ${overloadBanner}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Left Col: Tasks & Wellness -->
                        <div class="md:col-span-2 space-y-6">
                            
                            <!-- Today's Snapshot -->
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="glass p-5 rounded-2xl border-l-4 border-brand-accent">
                                    <p class="text-gray-400 text-xs uppercase mb-2">Pending Tasks</p>
                                    <p class="text-3xl font-bold">${pendingTasks}</p>
                                </div>
                                <div class="glass p-5 rounded-2xl border-l-4 border-blue-500">
                                    <p class="text-gray-400 text-xs uppercase mb-2">Classes Today</p>
                                    <p class="text-3xl font-bold">${classesToday}</p>
                                </div>
                                <div class="glass p-5 rounded-2xl border-l-4 border-yellow-500">
                                    <p class="text-gray-400 text-xs uppercase mb-2">Social/Life</p>
                                    <p class="text-3xl font-bold">${eventsToday}</p>
                                </div>
                                <div class="glass p-5 rounded-2xl border-l-4 border-green-500">
                                    <p class="text-gray-400 text-xs uppercase mb-2">Avg. Streak</p>
                                    <p class="text-3xl font-bold">7<span class="text-xl opacity-50">d</span></p>
                                </div>
                            </div>

                            <!-- Tasks Section -->
                            <div class="glass p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-lg">Up Next</h3>
                                    <button onclick="router('tasks')" class="text-xs text-brand-accent hover:underline">View All</button>
                                </div>
                                <div class="space-y-3">
                                    ${store.tasks.filter(t => !t.completed).slice(0, 5).map(task => `
                                        <div class="p-3 rounded-xl flex items-center gap-4 hover:bg-white/5 light:hover:bg-gray-100 transition group border border-white/0 light:border-gray-200 light:hover:border-gray-300">
                                            <button onclick="toggleTask(${task.id})" class="w-5 h-5 flex-shrink-0 rounded-full border border-gray-500 dark:border-gray-500 light:border-gray-400 hover:border-brand-accent flex items-center justify-center transition">
                                            </button>
                                            <div class="flex-1">
                                                <p class="font-semibold text-sm">${task.title}</p>
                                                <div class="flex gap-2 text-xs text-gray-500 dark:text-gray-500 light:text-gray-600 mt-1">
                                                    <span class="${getCategoryColor(task.category)}">${task.category}</span>
                                                    <span>•</span>
                                                    <span>${task.date ? formatDate(task.date) : 'No Date'}</span>
                                                </div>
                                            </div>
                                            ${task.priority === 'Critical' ? '<i class="fa-solid fa-flag text-red-500 text-xs flex-shrink-0"></i>' : ''}
                                        </div>
                                    `).join('') || '<p class="text-gray-500 dark:text-gray-500 light:text-gray-600 italic text-sm">No tasks pending. You\'re free!</p>'}
                                </div>
                            </div>
                        </div>

                        <!-- Right Col: Schedule & Habits -->
                        <div class="space-y-6">
                            <!-- Simple Schedule (Dynamic) -->
                            <div class="glass p-6 rounded-2xl">
                                <h3 class="font-bold text-lg mb-4">Today's Timeline</h3>
                                <div class="relative pl-4 border-l border-white/10 dark:border-white/10 light:border-gray-300 space-y-6">
                                    ${todaysSchedule.map(item => `
                                        <div class="timeline-item" style="--color: ${getClassColorHex(item.color)}; --border-color: ${store.theme === 'dark' ? '#050505' : '#f3f4f6'};">
                                            <p class="text-sm font-bold text-white dark:text-white light:text-gray-900">${item.title}</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-500 light:text-gray-600">${item.start} — ${item.end} (${item.type})</p>
                                        </div>
                                    `).join('') || `
                                         <div class="timeline-item" style="--color: #8b5cf6; --border-color: ${store.theme === 'dark' ? '#050505' : '#f3f4f6'};">
                                            <p class="text-sm font-bold text-white dark:text-white light:text-gray-900">Break Day or Undefined Schedule</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-500 light:text-gray-600">No classes/events found for today.</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                            
                            <!-- Habits -->
                            <div class="glass p-6 rounded-2xl">
                                <h3 class="font-bold text-lg mb-4">Daily Habits</h3>
                                <div class="space-y-3">
                                    ${store.habits.map(habit => `
                                        <div class="flex items-center justify-between cursor-pointer" onclick="toggleHabit(${habit.id})">
                                            <span class="text-sm ${habit.completedToday ? 'text-gray-500 dark:text-gray-500 light:text-gray-400 line-through' : 'text-gray-200 dark:text-gray-200 light:text-gray-800'}">${habit.title}</span>
                                            <i class="fa-solid fa-check-circle ${habit.completedToday ? 'text-brand-success' : 'text-gray-700 dark:text-gray-700 light:text-gray-300'}"></i>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- Calendar Views ---
        function renderCalendar(container) {
            container.innerHTML = `
                <div class="max-w-7xl mx-auto p-6 animate-enter">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold">Agenda</h2>
                        <div class="flex glass rounded-xl p-1 text-sm" id="calendar-view-toggle">
                            <button id="view-daily" onclick="setCalendarView('daily')" class="px-3 py-1 rounded-lg font-semibold transition hover:bg-white/10 dark:text-gray-400 light:text-gray-600">Day</button>
                            <button id="view-weekly" onclick="setCalendarView('weekly')" class="px-3 py-1 rounded-lg font-semibold transition hover:bg-white/10 dark:text-gray-400 light:text-gray-600">Week</button>
                            <button id="view-monthly" onclick="setCalendarView('monthly')" class="px-3 py-1 rounded-lg font-semibold transition hover:bg-white/10 dark:text-gray-400 light:text-gray-600">Month</button>
                        </div>
                    </div>
                    <div id="calendar-view-container">
                        <!-- Dynamic View Injected Here -->
                    </div>
                </div>
            `;
            setCalendarView(currentCalendarView);
        }

        function setCalendarView(view) {
            currentCalendarView = view;
            const container = document.getElementById('calendar-view-container');
            if (!container) return;
            
            // Update button active state JUST for the three view buttons
            ['daily','weekly','monthly'].forEach(v => {
                const btn = document.getElementById(`view-${v}`);
                if (!btn) return;
                btn.classList.remove('bg-brand-accent', 'text-white');
            });
            const activeBtn = document.getElementById(`view-${view}`);
            if (activeBtn) {
                activeBtn.classList.add('bg-brand-accent', 'text-white');
            }

            // Clear previous view
            container.innerHTML = '';
            
            // Render new view
            switch(view) {
                case 'daily': renderDailyView(container); break;
                case 'weekly': renderWeeklyView(container); break;
                case 'monthly': renderMonthlyView(container); break;
            }
        }
        
        function renderDailyView(container) {
             const dayType = getDayTypeForDate(currentCalendarDate);
             const todaysSchedule = getClassesForDate(currentCalendarDate);
             
             container.innerHTML = `
                <div class="glass p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">${currentCalendarDate.toDateString()} &bull; Day ${dayType}</h3>
                        <div class="flex gap-2">
                            <button onclick="changeDay(-1)" class="w-8 h-8 rounded bg-white/5 hover:bg-white/10 dark:text-gray-400 light:text-gray-600 flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
                            <button onclick="changeDay(1)" class="w-8 h-8 rounded bg-white/5 hover:bg-white/10 dark:text-gray-400 light:text-gray-600 flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <p class="text-xs text-gray-500 uppercase">Hourly Timeline</p>
                        <div class="relative pl-4 border-l border-white/10 dark:border-white/10 light:border-gray-300 space-y-3">
                            ${todaysSchedule.map(item => `
                                <div class="relative p-3 rounded-lg border border-white/10 dark:border-white/10 light:border-gray-200" style="background-color: ${getClassColorHex(item.color)}15;">
                                    <div class="absolute w-3 h-3 rounded-full -left-[18px] top-4" style="background-color: ${getClassColorHex(item.color)}; border: 2px solid ${store.theme === 'dark' ? '#18181b' : '#ffffff'};"></div>
                                    <p class="text-sm font-bold text-white dark:text-white light:text-gray-900">${item.title}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-500 light:text-gray-600">${item.start} — ${item.end} (${item.type})</p>
                                </div>
                            `).join('') || '<p class="text-gray-500 italic text-sm py-4">Nothing scheduled for this date.</p>'}
                        </div>
                    </div>
                </div>
             `;
        }
        
        function changeDay(offset) {
            currentCalendarDate.setDate(currentCalendarDate.getDate() + offset);
            // After changing date, ensure the view is refreshed
            setCalendarView('daily'); 
        }

        function renderWeeklyView(container) {
            const date = new Date(currentCalendarDate);
            // Find the start of the week (Sunday)
            date.setDate(date.getDate() - date.getDay()); 
            
            const days = [];
            for (let i = 0; i < 7; i++) {
                days.push(new Date(date));
                date.setDate(date.getDate() + 1);
            }

            // Generate hours from 8:00 to 20:00
            const hours = [];
            for (let h = 8; h <= 20; h++) {
                hours.push(String(h).padStart(2, '0') + ':00');
            }

            let gridContent = `<div class="weekly-grid sticky-header">
                <div class="weekly-header glass-heavy light:bg-gray-100/95 font-bold text-xs uppercase">Time</div>
                ${days.map(d => {
                    const dayType = getDayTypeForDate(d);
                    const isToday = d.toDateString() === new Date().toDateString();
                    return `<div class="weekly-header glass-heavy light:bg-gray-100/95 text-center text-sm ${isToday ? 'text-brand-accent font-bold' : 'text-gray-400 dark:text-gray-400 light:text-gray-600'}">
                        ${d.toLocaleString('default', { weekday: 'short' })}<br>
                        <span class="text-lg">${d.getDate()}</span>
                        <span class="text-xs opacity-70 block">${dayType}</span>
                    </div>`
                }).join('')}
            `;

            hours.forEach(hour => {
                gridContent += `<div class="weekly-time text-gray-400 dark:text-gray-400 light:text-gray-600">${hour.slice(0, 5)}</div>`;
                days.forEach(day => {
                    const schedule = getClassesForDate(day);
                    const itemsAtHour = schedule.filter(item => {
                        return item.start === hour;
                    });

                    gridContent += `<div class="weekly-cell text-xs relative overflow-hidden">`;
                    itemsAtHour.forEach(item => {
                        const color = getClassColorHex(item.color);
                        gridContent += `
                            <div class="p-1 mb-1 rounded-md cursor-pointer border border-white/10 dark:border-white/10 light:border-gray-200" style="background-color: ${color}15; border-left: 3px solid ${color};">
                                <p class="font-semibold truncate">${item.title}</p>
                                <p class="text-[10px] text-gray-500">${item.start}-${item.end}</p>
                            </div>
                        `;
                    });
                    gridContent += `</div>`;
                });
            });

            gridContent += `</div>`;

             container.innerHTML = `
                <div class="glass p-4 rounded-2xl overflow-hidden">
                    <div class="flex justify-between items-center mb-4 px-2">
                        <h3 class="text-xl font-bold">${days[0].toLocaleDateString('default', { month: 'short', day: 'numeric' })} - ${days[6].toLocaleDateString('default', { month: 'short', day: 'numeric' })}</h3>
                        <div class="flex gap-2">
                            <button onclick="changeWeek(-7)" class="w-8 h-8 rounded bg-white/5 hover:bg-white/10 dark:text-gray-400 light:text-gray-600 flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
                            <button onclick="changeWeek(7)" class="w-8 h-8 rounded bg-white/5 hover:bg-white/10 dark:text-gray-400 light:text-gray-600 flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="max-h-[70vh] overflow-y-auto no-scrollbar light:bg-white/90">
                        ${gridContent}
                    </div>
                </div>
            `;
        }
        
        function changeWeek(offset) {
            currentCalendarDate.setDate(currentCalendarDate.getDate() + offset);
            setCalendarView('weekly'); 
        }

        function renderMonthlyView(container) {
            const date = new Date(currentCalendarDate);
            const year = date.getFullYear();
            const month = date.getMonth();
            const monthName = date.toLocaleString('default', { month: 'long' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Generate Grid
            let daysHtml = '';
            for(let i=0; i<firstDay; i++) {
                daysHtml += `<div></div>`;
            }
            for(let d=1; d<=daysInMonth; d++) {
                const dayString = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const checkDate = new Date(dayString);
                const schedule = getClassesForDate(checkDate);
                const hasEvent = schedule.length > 0;
                const hasTask = store.tasks.some(t => t.date === dayString && !t.completed);
                const isToday = d === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear();

                daysHtml += `
                    <div class="aspect-square rounded-lg flex flex-col items-center justify-center relative ${isToday ? 'bg-brand-accent text-white' : 'hover:bg-white/5 dark:text-gray-300 light:text-gray-800'} transition-colors cursor-pointer" onclick="setCalendarDate('${dayString}')">
                        <span class="text-sm font-semibold">${d}</span>
                        <div class="flex gap-1 mt-1">
                            ${hasEvent ? `<div class="w-1.5 h-1.5 rounded-full ${isToday ? 'bg-white' : 'bg-blue-400'}"></div>` : ''}
                            ${hasTask ? `<div class="w-1.5 h-1.5 rounded-full ${isToday ? 'bg-white' : 'bg-green-400'}"></div>` : ''}
                        </div>
                    </div>
                `;
            }

             container.innerHTML = `
                <div class="glass p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold">${monthName} ${year}</h3>
                        <div class="flex gap-2">
                            <button onclick="changeMonth(-1)" class="w-8 h-8 rounded bg-white/5 hover:bg-white/10 dark:text-gray-400 light:text-gray-600 flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
                            <button onclick="changeMonth(1)" class="w-8 h-8 rounded bg-white/5 hover:bg-white/10 dark:text-gray-400 light:text-gray-600 flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs text-gray-500 font-bold uppercase">
                        <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                    </div>
                    <div class="grid grid-cols-7 gap-2">
                        ${daysHtml}
                    </div>
                </div>
            `;
        }
        
        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            setCalendarView('monthly');
        }

        function setCalendarDate(dateString) {
            currentCalendarDate = new Date(dateString);
            setCalendarView('daily');
        }

        function renderTasks(container) {
            const sortedTasks = [...store.tasks].sort((a,b) => new Date(a.date) - new Date(b.date));
            const active = sortedTasks.filter(t => !t.completed);
            const completed = sortedTasks.filter(t => t.completed);

            container.innerHTML = `
                <div class="max-w-3xl mx-auto p-6 animate-enter pb-24">
                    <h2 class="text-2xl font-bold mb-6">Tasks</h2>
                    
                    <!-- Filters (Visual Only for MVP) -->
                    <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6">
                        <button class="bg-brand-accent text-white px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap">All</button>
                        <button class="bg-white/5 dark:bg-white/5 light:bg-gray-100 border border-white/10 dark:border-white/10 light:border-gray-300 text-gray-300 dark:text-gray-300 light:text-gray-600 px-4 py-1.5 rounded-full text-sm font-semibold whitespace-nowrap hover:bg-white/10 light:hover:bg-gray-200">School</button>
                        <button class="bg-white/5 dark:bg-white/5 light:bg-gray-100 border border-white/10 dark:border-white/10 light:border-gray-300 text-gray-300 dark:text-gray-300 light:text-gray-600 px-4 py-1.5 rounded-full text-sm font-semibold whitespace-nowrap hover:bg-white/10 light:hover:bg-gray-200">Life</button>
                        <button class="bg-white/5 dark:bg-white/5 light:bg-gray-100 border border-white/10 dark:border-white/10 light:border-gray-300 text-gray-300 dark:text-gray-300 light:text-gray-600 px-4 py-1.5 rounded-full text-sm font-semibold whitespace-nowrap hover:bg-white/10 light:hover:bg-gray-200">Applications</button>
                    </div>

                    <div class="space-y-4">
                        <p class="text-xs text-gray-500 font-bold tracking-widest uppercase">To Do (${active.length})</p>
                        ${active.map(task => renderTaskItem(task)).join('')}
                        ${active.length === 0 ? '<div class="text-center py-10 text-gray-600 dark:text-gray-600 light:text-gray-400">No active tasks. <br> Time to relax or add more.</div>' : ''}
                    </div>

                    <div class="mt-8 space-y-4 opacity-70">
                         <div class="flex items-center gap-2 cursor-pointer text-gray-400 dark:text-gray-400 light:text-gray-600 hover:opacity-100" onclick="document.getElementById('completed-list').classList.toggle('hidden')">
                             <i class="fa-solid fa-chevron-down text-xs"></i>
                             <p class="text-xs font-bold tracking-widest uppercase">Completed (${completed.length})</p>
                         </div>
                         <div id="completed-list" class="space-y-2 hidden">
                             ${completed.map(task => renderTaskItem(task)).join('')}
                         </div>
                    </div>
                </div>
            `;
        }

        function renderTaskItem(task) {
            return `
                <div class="glass p-4 rounded-xl flex items-start gap-4 group ${task.completed ? 'opacity-50' : ''} light:bg-white/90 light:border-gray-200">
                    <button onclick="toggleTask(${task.id})" class="mt-1 w-5 h-5 flex-shrink-0 rounded-full border ${task.completed ? 'bg-brand-success border-brand-success' : 'border-gray-500 dark:border-gray-500 light:border-gray-400 hover:border-brand-accent'} flex items-center justify-center transition">
                         ${task.completed ? '<i class="fa-solid fa-check text-black text-xs"></i>' : ''}
                    </button>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                             <p class="font-semibold text-sm ${task.completed ? 'line-through text-gray-500 dark:text-gray-500 light:text-gray-400' : 'text-white dark:text-white light:text-gray-900'}">${task.title}</p>
                             <button onclick="deleteTask(${task.id})" class="text-gray-600 hover:text-red-500 transition"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                        <div class="flex gap-2 text-xs text-gray-500 dark:text-gray-500 light:text-gray-600 mt-1 items-center">
                            <span class="${getCategoryColor(task.category)} border border-white/5 dark:border-white/5 light:border-gray-200 px-1.5 py-0.5 rounded">${task.category}</span>
                            ${task.date ? `<span><i class="fa-regular fa-clock mr-1"></i>${formatDate(task.date)}</span>` : ''}
                            ${task.priority === 'Critical' ? '<span class="text-red-400 font-bold">!!!</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        let focusTimer = null;
        let focusTimeLeft = 25 * 60;
        let isFocusing = false;

        function renderFocus(container) {
            container.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center animate-enter relative overflow-hidden">
                    <!-- Background blobs -->
                    <div class="absolute top-10 left-10 w-64 h-64 bg-brand-accent/20 rounded-full blur-[100px]"></div>
                    <div class="absolute bottom-10 right-10 w-64 h-64 bg-blue-500/10 rounded-full blur-[100px]"></div>

                    <div class="text-center z-10">
                        <div class="mb-8">
                            <h2 class="text-4xl font-bold mb-2">Focus Mode</h2>
                            <p class="text-gray-400 dark:text-gray-400 light:text-gray-600">Lock In. Distractions Out.</p>
                        </div>

                        <!-- Timer Display -->
                        <div class="relative w-64 h-64 mx-auto mb-8 flex items-center justify-center">
                            <svg class="absolute inset-0 w-full h-full transform -rotate-90">
                                <circle cx="128" cy="128" r="120" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="transparent" class="dark:stroke-white/10 light:stroke-gray-300"/>
                                <circle id="timer-ring" cx="128" cy="128" r="120" stroke="#8b5cf6" stroke-width="8" fill="transparent" stroke-dasharray="754" stroke-dashoffset="0" stroke-linecap="round" class="timer-circle"/>
                            </svg>
                            <div class="text-6xl font-mono font-bold tracking-tighter text-white dark:text-white light:text-gray-900" id="timer-display">25:00</div>
                        </div>

                        <!-- Task Selection -->
                        <div class="mb-8 max-w-xs mx-auto">
                            <select id="focus-task-select" class="w-full bg-white/5 border border-white/10 dark:bg-white/5 dark:border-white/10 light:bg-gray-100 light:border-gray-300 rounded-lg p-2 text-sm text-center focus:outline-none text-white dark:text-white light:text-gray-900">
                                <option value="">-- Select a task to lock in on --</option>
                                ${store.tasks.filter(t => !t.completed).map(t => `<option value="${t.id}">${t.title}</option>`).join('')}
                            </select>
                        </div>

                        <!-- Controls -->
                        <div class="flex gap-4 justify-center">
                            <button onclick="toggleTimer()" id="timer-btn" class="w-16 h-16 rounded-full bg-brand-accent text-white flex items-center justify-center text-xl hover:scale-105 transition shadow-lg shadow-brand-accent/30">
                                <i class="fa-solid fa-play ml-1"></i>
                            </button>
                            <button onclick="resetTimer()" class="w-16 h-16 rounded-full bg-white/10 dark:bg-white/10 light:bg-gray-200 text-white dark:text-white light:text-gray-900 flex items-center justify-center text-xl hover:bg-white/20 light:hover:bg-gray-300 transition">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
             updateTimerDisplay(); // Ensure the display is accurate when loading the view
        }

        function toggleTimer() {
            const btn = document.getElementById('timer-btn');
            const ring = document.getElementById('timer-ring');
            
            if (isFocusing) {
                // Pause
                clearInterval(focusTimer);
                isFocusing = false;
                btn.innerHTML = '<i class="fa-solid fa-play ml-1"></i>';
                if (ring) ring.style.stroke = "#f59e0b"; // Warning color paused
            } else {
                // Start
                if(focusTimeLeft <= 0) focusTimeLeft = 25 * 60;
                isFocusing = true;
                btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                if (ring) ring.style.stroke = "#8b5cf6";

                focusTimer = setInterval(() => {
                    focusTimeLeft--;
                    updateTimerDisplay();
                    
                    if (focusTimeLeft <= 0) {
                        clearInterval(focusTimer);
                        isFocusing = false;
                        btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                        store.focusLog += 25; // Add to stats
                        saveData();
                        showMessage("Session Complete!", "Great job! Take a well-deserved break.", "success");
                        // Reset for next session
                        resetTimer();
                    }
                }, 1000);
            }
        }

        function resetTimer() {
            clearInterval(focusTimer);
            isFocusing = false;
            focusTimeLeft = 25 * 60;
            updateTimerDisplay();
            const btn = document.getElementById('timer-btn');
            if (btn) btn.innerHTML = '<i class="fa-solid fa-play ml-1"></i>';
            const ring = document.getElementById('timer-ring');
            if (ring) ring.style.strokeDashoffset = 0; // Full circle visible on reset
        }

        function updateTimerDisplay() {
            const m = Math.floor(focusTimeLeft / 60);
            const s = focusTimeLeft % 60;
            const display = document.getElementById('timer-display');
            if(display) display.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            
            // Update Ring (Circumference 2 * PI * 120 = 753.98 ~ 754)
            const totalTime = 25 * 60;
            const progress = focusTimeLeft / totalTime;
            const dashoffset = 754 * (1 - progress);
            const ring = document.getElementById('timer-ring');
            if(ring) ring.style.strokeDashoffset = dashoffset;
        }

        function renderSettings(container) {
            container.innerHTML = `
                <div class="max-w-4xl mx-auto p-6 animate-enter pb-24">
                    <h2 class="text-2xl font-bold mb-8">Settings & Configuration</h2>
                    
                    <!-- Theme Settings -->
                    <div class="glass p-6 rounded-2xl mb-8 light:bg-white/90 light:border-gray-200">
                        <h3 class="font-bold text-lg mb-4">Appearance</h3>
                        <p class="text-sm text-gray-500 mb-4">Choose your preferred theme.</p>
                        <div class="flex gap-4">
                            <button onclick="setTheme('dark')" class="px-4 py-2 rounded-lg font-semibold border ${store.theme === 'dark' ? 'bg-brand-accent text-white border-brand-accent' : 'bg-white/5 dark:bg-white/5 light:bg-gray-100 dark:border-white/10 light:border-gray-300 dark:text-white light:text-gray-800'}">
                                <i class="fa-solid fa-moon mr-2"></i> Dark Mode
                            </button>
                            <button onclick="setTheme('light')" class="px-4 py-2 rounded-lg font-semibold border ${store.theme === 'light' ? 'bg-brand-accent text-white border-brand-accent' : 'bg-white/5 dark:bg-white/5 light:bg-gray-100 dark:border-white/10 light:border-gray-300 dark:text-white light:text-gray-800'}">
                                <i class="fa-solid fa-sun mr-2"></i> Light Mode
                            </button>
                        </div>
                    </div>

                    <!-- Schedule Configuration -->
                    <div class="glass p-6 rounded-2xl mb-8 light:bg-white/90 light:border-gray-200">
                        <h3 class="font-bold text-lg mb-4">Schedule Editor</h3>
                        <p class="text-sm text-gray-500 mb-4">Configure your rotation and define class blocks.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Current Rotating Day</label>
                                <select id="schedule-day-type" class="w-full bg-white/5 border border-white/10 dark:bg-white/5 dark:border-white/10 light:bg-gray-100 light:border-gray-300 rounded-lg p-2 text-sm text-white dark:text-white light:text-gray-900" onchange="updateScheduleDay(this.value)">
                                    <option value="A" ${store.schedule.dayType === 'A' ? 'selected' : ''}>A Day (Start of Rotation)</option>
                                    <option value="B" ${store.schedule.dayType === 'B' ? 'selected' : ''}>B Day (Start of Rotation)</option>
                                    <option value="Static" ${store.schedule.dayType === 'Static' ? 'selected' : ''}>Static / Non-Rotating</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Schedule Type</label>
                                <select id="schedule-type" class="w-full bg-white/5 border border-white/10 dark:bg-white/5 dark:border-white/10 light:bg-gray-100 light:border-gray-300 rounded-lg p-2 text-sm text-white dark:text-white light:text-gray-900" onchange="updateScheduleType(this.value)">
                                    <option value="Static" ${!store.user || store.user.scheduleType === 'Static' ? 'selected' : ''}>Static</option>
                                    <option value="AB" ${store.user && store.user.scheduleType === 'AB' ? 'selected' : ''}>A/B Rotation</option>
                                </select>
                            </div>
                        </div>

                        <!-- Block Map Editor -->
                        <h4 class="font-bold text-md mt-6 mb-3">Time Blocks (e.g., A1, Lunch, B3)</h4>
                        <div id="block-map-editor" class="space-y-3 p-4 rounded-lg border border-white/10 dark:border-white/10 light:border-gray-200">
                            ${Object.entries(store.schedule.blockMap).map(([key, time]) => `
                                <div class="flex items-center gap-3">
                                    <input type="text" value="${key}" class="w-16 p-2 rounded-lg bg-white/5 dark:bg-white/5 light:bg-gray-100 text-sm font-mono" placeholder="Block" disabled>
                                    <input type="time" value="${time.start}" onchange="updateBlockTime('${key}', 'start', this.value)" class="flex-1 p-2 rounded-lg bg-white/5 dark:bg-white/5 light:bg-gray-100 text-sm">
                                    <span class="text-gray-500">-</span>
                                    <input type="time" value="${time.end}" onchange="updateBlockTime('${key}', 'end', this.value)" class="flex-1 p-2 rounded-lg bg-white/5 dark:bg-white/5 light:bg-gray-100 text-sm">
                                    <button onclick="removeBlock('${key}')" class="text-red-500/70 hover:text-red-500"><i class="fa-solid fa-trash text-sm"></i></button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="addBlockForm()" class="mt-4 w-full py-2 bg-brand-accent/20 text-brand-accent rounded-lg text-sm font-semibold hover:bg-brand-accent/30 transition">Add New Block Slot</button>

                        <!-- Class List Editor -->
                        <h4 class="font-bold text-md mt-6 mb-3">Defined Classes</h4>
                        <div id="class-list-container" class="space-y-3 p-4 rounded-lg border border-white/10 dark:border-white/10 light:border-gray-200">
                            ${store.schedule.classes.map(cls => `
                                <div class="p-3 rounded-lg border border-white/10 dark:border-white/10 light:border-gray-200" style="border-left: 4px solid ${getClassColorHex(cls.color)};">
                                    <div class="flex items-center justify-between mb-1">
                                         <span class="text-sm font-semibold flex-1">${cls.name}</span>
                                         <button onclick="editClassBlocks(${cls.id})" class="text-brand-accent/70 hover:text-brand-accent text-xs mr-2"><i class="fa-solid fa-pencil"></i> Edit Blocks</button>
                                         <button onclick="removeClass(${cls.id})" class="text-red-500/70 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                    <span class="text-xs text-gray-500 dark:text-gray-500 light:text-gray-600">Blocks: ${cls.blocks.join(', ')}</span>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="addClassForm()" class="mt-4 w-full py-2 bg-brand-accent/20 text-brand-accent rounded-lg text-sm font-semibold hover:bg-brand-accent/30 transition">Add New Class</button>
                    </div>

                    <!-- Habit Configuration -->
                    <div class="glass p-6 rounded-2xl mb-8 light:bg-white/90 light:border-gray-200">
                        <h3 class="font-bold text-lg mb-4">Daily Habits</h3>
                        <p class="text-sm text-gray-500 mb-4">Define the small things you want to do every day. These show up on your Dashboard.</p>
                        <div id="habit-list-editor" class="space-y-3">
                            ${store.habits.map(habit => `
                                <div class="flex items-center gap-3">
                                    <input type="text" value="${habit.title}" class="flex-1 p-2 rounded-lg bg-white/5 dark:bg-white/5 light:bg-gray-100 text-sm" onchange="renameHabit(${habit.id}, this.value)">
                                    <button onclick="removeHabit(${habit.id})" class="text-red-500/70 hover:text-red-500 text-xs"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="addHabitForm()" class="mt-4 w-full py-2 bg-brand-accent/20 text-brand-accent rounded-lg text-sm font-semibold hover:bg-brand-accent/30 transition">
                            Add New Habit
                        </button>
                    </div>

                    <!-- Reset Data -->
                     <div class="glass p-6 rounded-2xl light:bg-white/90 light:border-gray-200">
                         <h3 class="font-bold text-lg mb-4 text-red-500">Danger Zone</h3>
                         <p class="text-sm text-gray-500 mb-4">Clicking this will erase all stored data and restart the application.</p>
                         <button onclick="clearData()" class="px-4 py-2 rounded-lg font-semibold border border-red-500/50 bg-red-500/10 text-red-400 hover:bg-red-500/20 transition">
                            <i class="fa-solid fa-skull-crossbones mr-2"></i> Reset All Application Data
                         </button>
                     </div>
                </div>
            `;
        }
        
        // Settings Actions
        function updateScheduleType(value) {
            if (!store.user) return;
            store.user.scheduleType = value;
            saveData();
            router('settings');
            showMessage("Schedule Type Updated", `The app is now set to ${value} schedule.`, "success");
        }

        function updateScheduleDay(value) {
            store.schedule.dayType = value;
            saveData();
            router('settings'); // Re-render settings to show new day type
        }

        function updateBlockTime(key, field, value) {
            if (store.schedule.blockMap[key]) {
                store.schedule.blockMap[key][field] = value;
                saveData();
            }
        }

        function addBlockForm() {
            const blockKey = prompt("Enter a unique Block Key (e.g., A4, Lunch, Flex):");
            if (!blockKey || store.schedule.blockMap[blockKey]) {
                showMessage("Invalid Key", "Block key is required and must be unique.", "danger");
                return;
            }
            const startTime = prompt("Enter Start Time (HH:MM format, e.g., 14:20):");
            const endTime = prompt("Enter End Time (HH:MM format, e.g., 15:35):");

            if (startTime && endTime) {
                store.schedule.blockMap[blockKey] = { start: startTime, end: endTime };
                saveData();
                router('settings');
                showMessage("Block Added!", `${blockKey} time slot is now available.`, "success");
            } else {
                 showMessage("Error", "Start and End times are required.", "danger");
            }
        }

        function removeBlock(key) {
            if (confirm(`Are you sure you want to remove block ${key}? Classes using this block will be unassigned.`)) {
                delete store.schedule.blockMap[key];
                // Also remove this block from all classes
                store.schedule.classes.forEach(cls => {
                    cls.blocks = cls.blocks.filter(b => b !== key);
                });
                saveData();
                router('settings');
                showMessage("Block Removed", `${key} deleted.`, "warning");
            }
        }

        function addClassForm() {
            const name = prompt("Enter Class Name (e.g., AP Calculus):");
            if (!name) return;
            const blocksStr = prompt("Enter Class Blocks (e.g., A1, B2, separate by comma):");
            const blocks = blocksStr ? blocksStr.split(',').map(b => b.trim()) : [];
            const color = prompt("Enter Class Color (e.g., blue, red, yellow, green, purple):");
            if (!color) return;

            const newClass = {
                id: Date.now(),
                name,
                color,
                blocks
            };
            store.schedule.classes.push(newClass);
            saveData();
            router('settings');
            showMessage("Class Added!", `${name} is now on your schedule.`, "success");
        }
        
        function editClassBlocks(id) {
            const cls = store.schedule.classes.find(c => c.id === id);
            if (!cls) return;
            
            const currentBlocks = cls.blocks.join(', ');
            const newBlocksStr = prompt(`Editing blocks for ${cls.name}. Enter blocks separated by comma (e.g., A1, B3):`, currentBlocks);
            
            if (newBlocksStr !== null) {
                cls.blocks = newBlocksStr.split(',').map(b => b.trim());
                saveData();
                router('settings');
                showMessage("Class Updated!", `${cls.name} blocks changed.`, "success");
            }
        }

        function removeClass(id) {
            store.schedule.classes = store.schedule.classes.filter(cls => cls.id !== id);
            saveData();
            router('settings');
            showMessage("Class Removed", "The class has been deleted.", "warning");
        }

        // Habit editor actions
        function addHabitForm() {
            const title = prompt("New habit (e.g., 'Read 10 pages'):");
            if (!title) return;
            const newHabit = {
                id: Date.now(),
                title,
                completedToday: false
            };
            store.habits.push(newHabit);
            saveData();
            router('settings');
            showMessage("Habit Added!", `"${title}" has been added.`, "success");
        }

        function renameHabit(id, newTitle) {
            const habit = store.habits.find(h => h.id === id);
            if (!habit) return;
            habit.title = newTitle || habit.title;
            saveData();
        }

        function removeHabit(id) {
            if (!confirm("Remove this habit?")) return;
            store.habits = store.habits.filter(h => h.id !== id);
            saveData();
            router('settings');
            showMessage("Habit Removed", "Habit deleted.", "warning");
        }

        // --- FOCUS LOGIC ---
        // (Focus Logic is defined above but remains in place)

        // --- Form Handling ---
        document.getElementById('onboarding-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('ob-name').value;
            const grade = document.getElementById('ob-grade').value;

            // Default schedule type to Static; user can change later in Settings
            store.user = { name, grade, scheduleType: 'Static' };
            store.schedule.dayType = 'Static';
            
            // Clear default/placeholder schedule on first login
            store.schedule.classes = [];
            store.schedule.blockMap = {};
            
            saveData();
            document.getElementById('onboarding-modal').classList.add('hidden');
            document.getElementById('schedule-setup-modal').classList.remove('hidden');
        });

        // Calendar import flow (real .ics upload, not just a fake toast)
        function triggerCalendarUpload() {
            const fileInput = document.getElementById('calendar-file');
            if (fileInput) fileInput.click();
        }

        function handleCalendarFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    importICS(text);
                    document.getElementById('schedule-setup-modal').classList.add('hidden');
                    saveData();
                    updateSidebar();
                    router('calendar');
                    showMessage("Calendar Imported", "We pulled events from your calendar into your Agenda.", "success");
                } catch (err) {
                    console.error(err);
                    showMessage("Import Failed", "Could not read this calendar file. Make sure it is a valid .ics.", "danger");
                }
            };
            reader.readAsText(file);
        }

        // Very simple .ics parser: pulls DTSTART, SUMMARY into store.events
        function importICS(icsText) {
            const lines = icsText.split(/\r?\n/);
            let currentEvent = null;
            const events = [];

            lines.forEach(line => {
                if (line.startsWith('BEGIN:VEVENT')) {
                    currentEvent = {};
                } else if (line.startsWith('END:VEVENT')) {
                    if (currentEvent && currentEvent.start && currentEvent.summary) {
                        const { dateStr, timeStr } = parseICSDate(currentEvent.start);
                        events.push({
                            id: Date.now() + Math.floor(Math.random() * 100000),
                            title: currentEvent.summary,
                            type: 'School', // default type; user can adjust later if they want
                            date: dateStr,
                            time: timeStr
                        });
                    }
                    currentEvent = null;
                } else if (currentEvent) {
                    if (line.startsWith('DTSTART')) {
                        const value = line.split(':')[1];
                        currentEvent.start = value;
                    } else if (line.startsWith('SUMMARY')) {
                        const value = line.split(':').slice(1).join(':'); // in case ':' present in title
                        currentEvent.summary = value;
                    }
                }
            });

            // Merge into existing events
            store.events = store.events.concat(events);
        }

        function parseICSDate(val) {
            // Handles formats like 20251201T090000Z or 20251201T090000
            let year = parseInt(val.slice(0,4), 10);
            let month = parseInt(val.slice(4,6), 10) - 1; // 0-index
            let day = parseInt(val.slice(6,8), 10);
            let hour = 0;
            let minute = 0;
            if (val.includes('T')) {
                hour = parseInt(val.slice(9,11) || '0', 10);
                minute = parseInt(val.slice(11,13) || '0', 10);
            }
            const d = new Date(year, month, day, hour, minute);
            const dateStr = d.toISOString().split('T')[0];
            const timeStr = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            return { dateStr, timeStr };
        }

        function manualScheduleEntry() {
            document.getElementById('schedule-setup-modal').classList.add('hidden');
            showMessage("Manual Entry Selected", "Head to Settings to define your time blocks and classes!", "warning");
            updateSidebar();
            router('settings');
        }


        // Add Modal Logic
        function openAddModal(isEvent = false) {
            document.getElementById('add-modal').classList.remove('hidden');
            if(isEvent) switchAddTab('event');
            else switchAddTab('task');
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
            document.getElementById('add-form').reset();
        }

        function switchAddTab(type) {
            const taskTab = document.getElementById('tab-task');
            const eventTab = document.getElementById('tab-event');
            const timeInput = document.getElementById('time-input-container');
            const actionText = document.getElementById('btn-action-text');
            const typeInput = document.getElementById('add-type');

            // Reset active classes on tabs
            [taskTab, eventTab].forEach(tab => {
                tab.classList.remove('text-brand-accent', 'border-brand-accent');
                tab.classList.add('text-gray-400', 'border-transparent');
            });

            if(type === 'task') {
                taskTab.classList.add('text-brand-accent', 'border-brand-accent');
                timeInput.classList.add('hidden');
                actionText.textContent = "Task";
                typeInput.value = "task";
                document.getElementById('priority-options').classList.remove('hidden');
            } else {
                eventTab.classList.add('text-brand-accent', 'border-brand-accent');
                timeInput.classList.remove('hidden');
                actionText.textContent = "Event";
                typeInput.value = "event";
                document.getElementById('priority-options').classList.add('hidden');
            }
        }

        document.getElementById('add-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const type = document.getElementById('add-type').value;
            const title = document.getElementById('add-title').value;
            const category = document.getElementById('add-category').value;
            const date = document.getElementById('add-date').value;

            if (type === 'task') {
                const priority = document.getElementById('add-priority').value;
                const newTask = {
                    id: Date.now(),
                    title,
                    category,
                    date,
                    priority,
                    completed: false
                };
                store.tasks.push(newTask);
                showMessage("Task Added!", `"${title}" due on ${formatDate(date)}`, "success");
            } else {
                const time = document.getElementById('add-time').value;
                const newEvent = {
                    id: Date.now(),
                    title,
                    type: category, // reusing category logic as event type
                    date,
                    time
                };
                store.events.push(newEvent);
                showMessage("Event Added!", `"${title}" scheduled for ${time || 'All day'}`, "success");
            }

            saveData();
            closeAddModal();
            // Refresh current view
            const activeBtn = document.querySelector('.nav-btn.active');
            if(activeBtn) router(activeBtn.dataset.target);
        });

        function setPriority(p) {
            document.getElementById('add-priority').value = p;
            document.querySelectorAll('#priority-options > span').forEach(el => {
                el.classList.remove('font-bold', 'border-white');
                if (el.textContent.trim() === p) {
                    el.classList.add('font-bold', 'border-white');
                }
            });
            showMessage("Priority Set", `New item is ${p} priority.`, "warning");
        }

        // Data Manipulation
        function toggleTask(id) {
            const task = store.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                saveData();
                const activeBtn = document.querySelector('.nav-btn.active');
                if(activeBtn) router(activeBtn.dataset.target);
                
                if (task.completed) {
                    showMessage("Task Complete!", `Nice work on "${task.title}".`, "success");
                }
            }
        }

        function deleteTask(id) {
            store.tasks = store.tasks.filter(t => t.id !== id);
            saveData();
            const activeBtn = document.querySelector('.nav-btn.active');
            if(activeBtn) router(activeBtn.dataset.target);
            showMessage("Task Deleted", "It's gone forever.", "danger");
        }

        function toggleHabit(id) {
            const habit = store.habits.find(h => h.id === id);
            if(habit) {
                habit.completedToday = !habit.completedToday;
                saveData();
                const active = document.querySelector('.nav-btn.active');
                if (active && active.dataset.target === 'dashboard') {
                    renderDashboard(document.getElementById('main-container'));
                }
            }
        }
        
        // Custom Message/Toast Logic (Replaces alert())
        function showMessage(title, message, type) {
            const color = type === 'success' ? 'bg-brand-success' : type === 'warning' ? 'bg-brand-warning' : 'bg-brand-danger';
            
            const toast = document.createElement('div');
            toast.className = `fixed bottom-24 md:bottom-8 right-4 z-[70] p-4 rounded-xl text-white ${color} shadow-lg animate-enter`;
            toast.innerHTML = `
                <p class="font-bold text-sm">${title}</p>
                <p class="text-xs">${message}</p>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('animate-enter');
                toast.style.opacity = 0;
                toast.style.transition = 'opacity 0.5s ease-out';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // Helpers
        function getCategoryColor(cat) {
            switch(cat) {
                case 'School': return 'text-blue-400';
                case 'Life': return 'text-green-400';
                case 'Application': return 'text-purple-400';
                case 'Social': return 'text-pink-400';
                default: return 'text-gray-400';
            }
        }
        
        function getClassColorHex(colorName) {
            switch(colorName.toLowerCase()) {
                case 'blue': return '#3b82f6';
                case 'red': return '#ef4444';
                case 'yellow': return '#f59e0b';
                case 'green': return '#10b981';
                case 'purple': return '#a855f7';
                case 'pink': return '#ec4899';
                default: return '#6b7280'; // gray
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'No Date';
            const d = new Date(dateStr + 'T00:00:00'); // Adding T00:00:00 to prevent timezone issues
            if (isNaN(d.getTime())) return dateStr;
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Initialize App
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
